<div class="accessories-inventory-container">
  <!-- Header Section -->
  <div class="inventory-header">
    <h1>Accessories Inventory</h1>
    <div class="header-actions">
      <button
        class="export-btn"
        (click)="exportInventory()"
        [disabled]="isLoading">
        <i class="material-icons">download</i>
        Export
      </button>
      <button
        class="refresh-btn"
        (click)="refreshInventory()"
        [disabled]="isRefreshing">
        <i class="material-icons">refresh</i>
        Refresh
      </button>
      <button
        class="add-accessory-btn"
        (click)="openAddAccessoryModal()"
        [disabled]="isLoading">
        <i class="material-icons">add</i>
        Add Accessory
      </button>
    </div>
  </div>

  <!-- Error Alert -->
  @if (errorMessage) {
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="material-icons">error</i>
      {{ errorMessage }}
      <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
    </div>
  }

  <!-- Statistics Grid -->
  <div class="stats-grid">
    <div class="stat-card available">
      <div class="stat-icon">
        <i class="material-icons">check_circle</i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.totalAvailable }}</h3>
        <p>Available</p>
      </div>
    </div>
    <div class="stat-card low-stock">
      <div class="stat-icon">
        <i class="material-icons">warning</i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.lowStock }}</h3>
        <p>Low Stock</p>
      </div>
    </div>
    <div class="stat-card out-of-stock">
      <div class="stat-icon">
        <i class="material-icons">cancel</i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.outOfStock }}</h3>
        <p>Out of Stock</p>
      </div>
    </div>
    <div class="stat-card total">
      <div class="stat-icon">
        <i class="material-icons">inventory</i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.totalAvailable + statistics.lowStock + statistics.outOfStock }}</h3>
        <p>Total Items</p>
      </div>
    </div>
  </div>

  <!-- Search and Filter Section -->
  <div class="search-filter-section">
    <div class="search-box">
      <input
        type="text"
        class="form-control"
        placeholder="Search accessories..."
        [(ngModel)]="searchTerm"
        (ngModelChange)="onSearchChange()">
    </div>
    <div class="filter-section">
      <select
        class="form-select"
        [(ngModel)]="selectedCategory"
        (ngModelChange)="onCategoryFilterChange()">
        <option [value]="null">All Categories</option>
        <option *ngFor="let cat of categoryOptions" [value]="cat.value">{{ cat.label }}</option>
      </select>
      <select
        class="form-select"
        [(ngModel)]="selectedStatus"
        (ngModelChange)="onStatusFilterChange()">
        <option [value]="null">All Status</option>
        <option *ngFor="let status of statusOptions" [value]="status.value">{{ status.label }}</option>
      </select>
      <select
        class="form-select"
        [(ngModel)]="selectedSupplier"
        (ngModelChange)="onSupplierFilterChange()">
        <option [value]="null">All Suppliers</option>
        <option *ngFor="let supplier of supplierOptions" [value]="supplier.value">{{ supplier.label }}</option>
      </select>
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading) {
    <div class="loading-container">
      <div class="spinner-border text-primary"></div>
      <p>Loading accessories inventory...</p>
    </div>
  }

  <!-- Empty State -->
  @if (!isLoading && filteredAccessories.length === 0) {
    <div class="no-machines">
      <div class="empty-state">
        <i class="material-icons">inbox</i>
        <h4>No Accessories Found</h4>
        <p>
          @if (hasActiveFilters()) {
            No accessories match your current filters.
          } @else {
            No accessories have been added to the inventory yet.
          }
        </p>
      </div>
    </div>
  }

  <!-- Table -->
  @if (!isLoading && filteredAccessories.length > 0) {
    <div class="table-container">
      <table class="machines-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Category</th>
            <th>Part Number</th>
            <th>Quantity</th>
            <th>Status</th>
            <th>Supplier</th>
            <th>Last Updated</th>
            <th style="width: 200px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let accessory of filteredAccessories" class="machine-row">
            <td>
              <strong>{{ accessory.name }}</strong>
              <small *ngIf="accessory.description" class="text-muted d-block">{{ accessory.description }}</small>
            </td>
            <td>
              <span class="status-badge bg-secondary">{{ accessory.category }}</span>
            </td>
            <td><code>{{ accessory.partNumber }}</code></td>
            <td>
              <strong [ngClass]="{
                'text-success': accessory.quantity > accessory.minStockLevel,
                'text-warning': accessory.quantity <= accessory.minStockLevel && accessory.quantity > 0,
                'text-danger': accessory.quantity === 0
              }">
                {{ accessory.quantity }} {{ accessory.unit }}
              </strong>
              <small class="text-muted d-block">Min: {{ accessory.minStockLevel }}</small>
            </td>
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(accessory)">
                {{ getStatusDisplay(accessory) }}
              </span>
            </td>
            <td>{{ accessory.supplier }}</td>
            <td>{{ accessory.lastUpdated | date:'short' }}</td>
            <td>
              <div class="action-buttons">
                <button class="action-btn view-btn" (click)="viewAccessoryDetails(accessory)" title="View Details">
                  <i class="material-icons">visibility</i>
                </button>
                <button class="action-btn edit-btn" (click)="editAccessory(accessory)" title="Edit">
                  <i class="material-icons">edit</i>
                </button>
                <button class="action-btn stock-btn" (click)="adjustStock(accessory)" title="Adjust Stock">
                  <i class="material-icons">add_circle</i>
                </button>
                <button class="action-btn delete-btn" (click)="deleteAccessory(accessory)" title="Delete">
                  <i class="material-icons">delete</i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  }
</div>

<!-- Add/Edit Accessory Modal -->
<p-dialog
  [(visible)]="showAccessoryModal"
  [header]="isEditMode ? 'Edit Accessory' : 'Add New Accessory'"
  [modal]="true"
  [style]="{width: '600px'}"
  [draggable]="false"
  [resizable]="false">
  <ng-template pTemplate="content">
    <div class="modal-body">
      <form class="accessory-form">
        <div class="form-row">
          <div class="form-group">
            <label for="accessoryName">Name *</label>
            <input type="text" id="accessoryName" [(ngModel)]="accessoryForm.name" 
                   name="name" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="accessoryCategory">Category *</label>
            <select id="accessoryCategory" [(ngModel)]="accessoryForm.category"
                    name="category" class="form-control" required>
              <option value="">Select Category</option>
              <option value="EngineParts">Engine Parts</option>
              <option value="HydraulicParts">Hydraulic Parts</option>
              <option value="ElectricalComponents">Electrical Components</option>
              <option value="Filters">Filters</option>
              <option value="BeltsAndHoses">Belts & Hoses</option>
              <option value="Lubricants">Lubricants</option>
              <option value="SafetyEquipment">Safety Equipment</option>
              <option value="Tools">Tools</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="partNumber">Part Number *</label>
            <input type="text" id="partNumber" [(ngModel)]="accessoryForm.partNumber" 
                   name="partNumber" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="supplier">Supplier *</label>
            <input type="text" id="supplier" [(ngModel)]="accessoryForm.supplier" 
                   name="supplier" class="form-control" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="quantity">Current Quantity *</label>
            <input type="number" id="quantity" [(ngModel)]="accessoryForm.quantity" 
                   name="quantity" class="form-control" min="0" required>
          </div>
          <div class="form-group">
            <label for="unit">Unit *</label>
            <select id="unit" [(ngModel)]="accessoryForm.unit"
                    name="unit" class="form-control" required>
              <option value="">Select Unit</option>
              <option value="Pieces">Pieces</option>
              <option value="Kilograms">Kilograms</option>
              <option value="Liters">Liters</option>
              <option value="Meters">Meters</option>
              <option value="Box">Box</option>
              <option value="Set">Set</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label for="minStockLevel">Minimum Stock Level *</label>
          <input type="number" id="minStockLevel" [(ngModel)]="accessoryForm.minStockLevel"
                 name="minStockLevel" class="form-control" min="0" required>
        </div>
        
        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" [(ngModel)]="accessoryForm.description" 
                    name="description" class="form-control" rows="3"></textarea>
        </div>
        
        <div class="form-group">
          <label for="location">Storage Location</label>
          <input type="text" id="location" [(ngModel)]="accessoryForm.location" 
                 name="location" class="form-control">
        </div>
      </form>
    </div>
  </ng-template>
  <ng-template pTemplate="footer">
    <p-button label="Cancel" severity="secondary" (onClick)="closeAccessoryModal()"></p-button>
    <p-button
      [label]="isEditMode ? 'Update Accessory' : 'Add Accessory'"
      (onClick)="saveAccessory()"
      [disabled]="!isAccessoryFormValid()">
    </p-button>
  </ng-template>
</p-dialog>

<!-- Stock Adjustment Modal -->
<p-dialog
  [(visible)]="showStockModal"
  [header]="'Adjust Stock - ' + (selectedAccessory?.name || '')"
  [modal]="true"
  [style]="{width: '500px'}"
  [draggable]="false"
  [resizable]="false">
  <ng-template pTemplate="content">
    <div class="modal-body">
      <div class="current-stock-info">
        <p><strong>Current Stock:</strong> {{ selectedAccessory?.quantity }} {{ selectedAccessory?.unit }}</p>
        <p><strong>Minimum Level:</strong> {{ selectedAccessory?.minStockLevel }} {{ selectedAccessory?.unit }}</p>
      </div>
      
      <form class="stock-form">
        <div class="form-group">
          <label for="adjustmentType">Adjustment Type</label>
          <select id="adjustmentType" [(ngModel)]="stockAdjustment.type" 
                  name="type" class="form-control">
            <option value="add">Add Stock</option>
            <option value="remove">Remove Stock</option>
            <option value="set">Set Exact Amount</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="adjustmentQuantity">
            {{ stockAdjustment.type === 'set' ? 'New Quantity' : 'Quantity to ' + (stockAdjustment.type === 'add' ? 'Add' : 'Remove') }}
          </label>
          <input type="number" id="adjustmentQuantity" [(ngModel)]="stockAdjustment.quantity" 
                 name="quantity" class="form-control" min="0" required>
        </div>
        
        <div class="form-group">
          <label for="adjustmentReason">Reason</label>
          <select id="adjustmentReason" [(ngModel)]="stockAdjustment.reason" 
                  name="reason" class="form-control">
            <option value="purchase">New Purchase</option>
            <option value="usage">Used in Maintenance</option>
            <option value="damaged">Damaged/Defective</option>
            <option value="lost">Lost/Missing</option>
            <option value="returned">Returned to Supplier</option>
            <option value="correction">Inventory Correction</option>
            <option value="other">Other</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="adjustmentNotes">Notes</label>
          <textarea id="adjustmentNotes" [(ngModel)]="stockAdjustment.notes" 
                    name="notes" class="form-control" rows="3"></textarea>
        </div>
        
        <div class="adjustment-preview" *ngIf="stockAdjustment.quantity > 0">
          <p><strong>New Stock Level:</strong> {{ calculateNewStock() }} {{ selectedAccessory?.unit }}</p>
        </div>
      </form>
    </div>
  </ng-template>
  <ng-template pTemplate="footer">
    <p-button label="Cancel" severity="secondary" (onClick)="closeStockModal()"></p-button>
    <p-button
      label="Apply Adjustment"
      (onClick)="applyStockAdjustment()"
      [disabled]="!stockAdjustment.quantity || stockAdjustment.quantity <= 0">
    </p-button>
  </ng-template>
</p-dialog>

<!-- Accessory Details Modal -->
<p-dialog
  [(visible)]="showDetailsModal"
  [header]="(selectedAccessory?.name || '') + ' - Details'"
  [modal]="true"
  [style]="{width: '800px'}"
  [draggable]="false"
  [resizable]="false">
  <ng-template pTemplate="content">
    <div class="modal-body">
      <div class="details-grid" *ngIf="selectedAccessory">
        <div class="detail-section">
          <h4>Basic Information</h4>
          <div class="detail-row">
            <span class="label">Name:</span>
            <span class="value">{{ selectedAccessory.name }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Category:</span>
            <span class="value">{{ selectedAccessory.category }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Part Number:</span>
            <span class="value">{{ selectedAccessory.partNumber }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Description:</span>
            <span class="value">{{ selectedAccessory.description || 'N/A' }}</span>
          </div>
        </div>
        
        <div class="detail-section">
          <h4>Stock Information</h4>
          <div class="detail-row">
            <span class="label">Current Quantity:</span>
            <span class="value">{{ selectedAccessory.quantity }} {{ selectedAccessory.unit }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Minimum Stock Level:</span>
            <span class="value">{{ selectedAccessory.minStockLevel }} {{ selectedAccessory.unit }}</span>
          </div>
        </div>
        
        <div class="detail-section">
          <h4>Supplier Information</h4>
          <div class="detail-row">
            <span class="label">Supplier:</span>
            <span class="value">{{ selectedAccessory.supplier }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Storage Location:</span>
            <span class="value">{{ selectedAccessory.location || 'Not specified' }}</span>
          </div>
        </div>
        
        <div class="detail-section">
          <h4>Status & Dates</h4>
          <div class="detail-row">
            <span class="label">Status:</span>
            <span class="value">
              <span class="status-badge" [ngClass]="getStatusClass(selectedAccessory)">
                {{ getStatusDisplay(selectedAccessory) }}
              </span>
            </span>
          </div>
          <div class="detail-row">
            <span class="label">Last Updated:</span>
            <span class="value">{{ selectedAccessory.lastUpdated | date:'full' }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Created:</span>
            <span class="value">{{ selectedAccessory.createdAt | date:'full' }}</span>
          </div>
        </div>
      </div>
    </div>
  </ng-template>
  <ng-template pTemplate="footer">
    <p-button label="Close" severity="secondary" (onClick)="closeDetailsModal()"></p-button>
    <p-button
      label="Edit Accessory"
      icon="pi pi-pencil"
      (onClick)="editAccessory(selectedAccessory!)">
    </p-button>
  </ng-template>
</p-dialog>