<div class="accessories-inventory">
  <!-- Page Header -->
  <div class="accessories-header">
    <h1>Accessories Inventory</h1>
    <div class="header-actions">
      <button
        class="export-btn"
        (click)="exportInventory()"
        [disabled]="isLoading">
        <i class="material-icons">download</i>
        Export
      </button>
      <button
        class="refresh-btn"
        (click)="refreshInventory()"
        [disabled]="isRefreshing">
        <i class="material-icons">refresh</i>
        Refresh
      </button>
      <button
        class="add-btn"
        (click)="openAddAccessoryModal()">
        <i class="material-icons">add</i>
        Add Accessory
      </button>
    </div>
  </div>

  <!-- Error notification display -->
  @if (errorMessage) {
    <div class="error-alert">
      <div class="error-content">
        <i class="material-icons">error_outline</i>
        <span>{{ errorMessage }}</span>
      </div>
      <button class="error-close" (click)="errorMessage = ''" type="button" aria-label="Close error">
        <i class="material-icons">close</i>
      </button>
    </div>
  }

  <!-- Statistics Grid -->
  <div class="stats-grid">
    <div class="stat-card available">
      <div class="stat-icon">
        <i class="material-icons">check_circle</i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.totalAvailable }}</h3>
        <p>Available</p>
      </div>
    </div>

    <div class="stat-card low-stock">
      <div class="stat-icon">
        <i class="material-icons">warning</i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.lowStock }}</h3>
        <p>Low Stock</p>
      </div>
    </div>

    <div class="stat-card out-of-stock">
      <div class="stat-icon">
        <i class="material-icons">cancel</i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.outOfStock }}</h3>
        <p>Out of Stock</p>
      </div>
    </div>

    <div class="stat-card total">
      <div class="stat-icon">
        <i class="material-icons">inventory</i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.totalAvailable + statistics.lowStock + statistics.outOfStock }}</h3>
        <p>Total Items</p>
      </div>
    </div>
  </div>

  <!-- Search and Filter Section -->
  <div class="search-filter-section">
    <div class="search-box">
      <input
        type="text"
        class="form-control"
        [(ngModel)]="searchTerm"
        (input)="onSearchChange()"
        placeholder="Search accessories..." />
    </div>

    <div class="filter-section">
      <div class="filter-group">
        <label class="filter-label">Category</label>
        <select
          class="form-select"
          [(ngModel)]="selectedCategory"
          (ngModelChange)="onCategoryFilterChange()">
          <option value="">All Categories</option>
          @for (option of categoryOptions; track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
          }
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">Status</label>
        <select
          class="form-select"
          [(ngModel)]="selectedStatus"
          (ngModelChange)="onStatusFilterChange()">
          <option value="">All Status</option>
          @for (option of statusOptions; track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
          }
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">Supplier</label>
        <select
          class="form-select"
          [(ngModel)]="selectedSupplier"
          (ngModelChange)="onSupplierFilterChange()">
          <option value="">All Suppliers</option>
          @for (option of supplierOptions; track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
          }
        </select>
      </div>
    </div>
  </div>

  <!-- Modern Table Section -->
  <div class="table-section">
    <div class="table-header">
      <div class="table-title">
        <i class="material-icons">view_list</i>
        <span>Accessories List</span>
        <span class="request-count">{{ filteredAccessories.length }}</span>
      </div>
    </div>

    <!-- Loading State -->
    @if (isLoading) {
      <div class="loading-state">
        <div class="loader-spinner"></div>
        <p>Loading accessories inventory...</p>
      </div>
    }

    <!-- Empty State -->
    @if (!isLoading && filteredAccessories.length === 0) {
      <div class="empty-state">
        <div class="empty-icon">
          <i class="material-icons">inbox</i>
        </div>
        <h3>No Accessories Found</h3>
        <p>
          @if (hasActiveFilters()) {
            No accessories match your current filters.
          } @else {
            No accessories have been added to the inventory yet.
          }
        </p>
        @if (!hasActiveFilters()) {
          <button class="empty-action-btn" (click)="openAddAccessoryModal()" type="button">
            Add First Accessory
          </button>
        } @else {
          <button class="empty-action-btn" (click)="clearAllFilters()" type="button">
            Clear Filters
          </button>
        }
      </div>
    }

    <!-- Modern Table -->
    @if (!isLoading && filteredAccessories.length > 0) {
      <div class="accessories-table-wrapper">
        <p-table
          [value]="filteredAccessories"
          styleClass="modern-table"
          responsiveLayout="scroll"
          [paginator]="true"
          [rows]="10"
          [rowsPerPageOptions]="[10, 25, 50, 100]"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Showing {first} to {last} of {totalRecords}"
          [rowHover]="true"
          [sortField]="'name'"
          [sortOrder]="1"
          dataKey="id">

      <!-- Header -->
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="name">
            Name <p-sortIcon field="name"></p-sortIcon>
          </th>
          <th pSortableColumn="category">
            Category <p-sortIcon field="category"></p-sortIcon>
          </th>
          <th pSortableColumn="partNumber">
            Part Number <p-sortIcon field="partNumber"></p-sortIcon>
          </th>
          <th pSortableColumn="quantity">
            Quantity <p-sortIcon field="quantity"></p-sortIcon>
          </th>
          <th>Status</th>
          <th pSortableColumn="supplier">
            Supplier <p-sortIcon field="supplier"></p-sortIcon>
          </th>
          <th pSortableColumn="lastUpdated">
            Last Updated <p-sortIcon field="lastUpdated"></p-sortIcon>
          </th>
          <th style="width: 180px;">Actions</th>
        </tr>
      </ng-template>

      <!-- Body -->
      <ng-template pTemplate="body" let-accessory>
        <tr [ngClass]="{'low-stock-row': accessory.quantity <= accessory.minStockLevel}">
          <td class="accessory-name">
            <div class="name-cell">
              <strong>{{ accessory.name }}</strong>
              <small *ngIf="accessory.description">{{ accessory.description }}</small>
            </div>
          </td>
          <td>
            <p-tag [value]="accessory.category" [style]="{'background': '#ecf0f1', 'color': '#2c3e50'}"></p-tag>
          </td>
          <td class="part-number">{{ accessory.partNumber }}</td>
          <td class="quantity-cell">
            <div class="quantity-info">
              <span class="current-quantity" [class.low-stock]="accessory.quantity <= accessory.minStockLevel">
                {{ accessory.quantity }}
              </span>
              <span class="unit">{{ accessory.unit }}</span>
              <small class="min-stock">Min: {{ accessory.minStockLevel }}</small>
            </div>
          </td>
          <td>
            <p-tag
              [value]="getStatusDisplay(accessory)"
              [severity]="getStatusSeverity(accessory)">
            </p-tag>
          </td>
          <td class="supplier-cell">{{ accessory.supplier }}</td>
          <td class="date-cell">{{ accessory.lastUpdated | date:'short' }}</td>
          <td class="actions-cell">
            <div class="action-buttons">
              <button
                class="action-btn view-btn"
                (click)="viewAccessoryDetails(accessory)"
                title="View Details">
                <i class="material-icons">visibility</i>
              </button>
              <button
                class="action-btn edit-btn"
                (click)="editAccessory(accessory)"
                title="Edit">
                <i class="material-icons">edit</i>
              </button>
              <button
                class="action-btn stock-btn"
                (click)="adjustStock(accessory)"
                title="Adjust Stock">
                <i class="material-icons">add_circle</i>
              </button>
              <button
                class="action-btn delete-btn"
                (click)="deleteAccessory(accessory)"
                title="Delete">
                <i class="material-icons">delete</i>
              </button>
            </div>
          </td>
        </tr>
          </ng-template>
        </p-table>
      </div>
    }
  </div>
</div>

<!-- Add/Edit Accessory Modal -->
<p-dialog
  [(visible)]="showAccessoryModal"
  [header]="isEditMode ? 'Edit Accessory' : 'Add New Accessory'"
  [modal]="true"
  [style]="{width: '600px'}"
  [draggable]="false"
  [resizable]="false">
  <ng-template pTemplate="content">
    <div class="modal-body">
      <form class="accessory-form">
        <div class="form-row">
          <div class="form-group">
            <label for="accessoryName">Name *</label>
            <input type="text" id="accessoryName" [(ngModel)]="accessoryForm.name" 
                   name="name" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="accessoryCategory">Category *</label>
            <select id="accessoryCategory" [(ngModel)]="accessoryForm.category"
                    name="category" class="form-control" required>
              <option value="">Select Category</option>
              <option value="EngineParts">Engine Parts</option>
              <option value="HydraulicParts">Hydraulic Parts</option>
              <option value="ElectricalComponents">Electrical Components</option>
              <option value="Filters">Filters</option>
              <option value="BeltsAndHoses">Belts & Hoses</option>
              <option value="Lubricants">Lubricants</option>
              <option value="SafetyEquipment">Safety Equipment</option>
              <option value="Tools">Tools</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="partNumber">Part Number *</label>
            <input type="text" id="partNumber" [(ngModel)]="accessoryForm.partNumber" 
                   name="partNumber" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="supplier">Supplier *</label>
            <input type="text" id="supplier" [(ngModel)]="accessoryForm.supplier" 
                   name="supplier" class="form-control" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="quantity">Current Quantity *</label>
            <input type="number" id="quantity" [(ngModel)]="accessoryForm.quantity" 
                   name="quantity" class="form-control" min="0" required>
          </div>
          <div class="form-group">
            <label for="unit">Unit *</label>
            <select id="unit" [(ngModel)]="accessoryForm.unit"
                    name="unit" class="form-control" required>
              <option value="">Select Unit</option>
              <option value="Pieces">Pieces</option>
              <option value="Kilograms">Kilograms</option>
              <option value="Liters">Liters</option>
              <option value="Meters">Meters</option>
              <option value="Box">Box</option>
              <option value="Set">Set</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label for="minStockLevel">Minimum Stock Level *</label>
          <input type="number" id="minStockLevel" [(ngModel)]="accessoryForm.minStockLevel"
                 name="minStockLevel" class="form-control" min="0" required>
        </div>
        
        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" [(ngModel)]="accessoryForm.description" 
                    name="description" class="form-control" rows="3"></textarea>
        </div>
        
        <div class="form-group">
          <label for="location">Storage Location</label>
          <input type="text" id="location" [(ngModel)]="accessoryForm.location" 
                 name="location" class="form-control">
        </div>
      </form>
    </div>
  </ng-template>
  <ng-template pTemplate="footer">
    <p-button label="Cancel" severity="secondary" (onClick)="closeAccessoryModal()"></p-button>
    <p-button
      [label]="isEditMode ? 'Update Accessory' : 'Add Accessory'"
      (onClick)="saveAccessory()"
      [disabled]="!isAccessoryFormValid()">
    </p-button>
  </ng-template>
</p-dialog>

<!-- Stock Adjustment Modal -->
<p-dialog
  [(visible)]="showStockModal"
  [header]="'Adjust Stock - ' + (selectedAccessory?.name || '')"
  [modal]="true"
  [style]="{width: '500px'}"
  [draggable]="false"
  [resizable]="false">
  <ng-template pTemplate="content">
    <div class="modal-body">
      <div class="current-stock-info">
        <p><strong>Current Stock:</strong> {{ selectedAccessory?.quantity }} {{ selectedAccessory?.unit }}</p>
        <p><strong>Minimum Level:</strong> {{ selectedAccessory?.minStockLevel }} {{ selectedAccessory?.unit }}</p>
      </div>
      
      <form class="stock-form">
        <div class="form-group">
          <label for="adjustmentType">Adjustment Type</label>
          <select id="adjustmentType" [(ngModel)]="stockAdjustment.type" 
                  name="type" class="form-control">
            <option value="add">Add Stock</option>
            <option value="remove">Remove Stock</option>
            <option value="set">Set Exact Amount</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="adjustmentQuantity">
            {{ stockAdjustment.type === 'set' ? 'New Quantity' : 'Quantity to ' + (stockAdjustment.type === 'add' ? 'Add' : 'Remove') }}
          </label>
          <input type="number" id="adjustmentQuantity" [(ngModel)]="stockAdjustment.quantity" 
                 name="quantity" class="form-control" min="0" required>
        </div>
        
        <div class="form-group">
          <label for="adjustmentReason">Reason</label>
          <select id="adjustmentReason" [(ngModel)]="stockAdjustment.reason" 
                  name="reason" class="form-control">
            <option value="purchase">New Purchase</option>
            <option value="usage">Used in Maintenance</option>
            <option value="damaged">Damaged/Defective</option>
            <option value="lost">Lost/Missing</option>
            <option value="returned">Returned to Supplier</option>
            <option value="correction">Inventory Correction</option>
            <option value="other">Other</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="adjustmentNotes">Notes</label>
          <textarea id="adjustmentNotes" [(ngModel)]="stockAdjustment.notes" 
                    name="notes" class="form-control" rows="3"></textarea>
        </div>
        
        <div class="adjustment-preview" *ngIf="stockAdjustment.quantity > 0">
          <p><strong>New Stock Level:</strong> {{ calculateNewStock() }} {{ selectedAccessory?.unit }}</p>
        </div>
      </form>
    </div>
  </ng-template>
  <ng-template pTemplate="footer">
    <p-button label="Cancel" severity="secondary" (onClick)="closeStockModal()"></p-button>
    <p-button
      label="Apply Adjustment"
      (onClick)="applyStockAdjustment()"
      [disabled]="!stockAdjustment.quantity || stockAdjustment.quantity <= 0">
    </p-button>
  </ng-template>
</p-dialog>

<!-- Accessory Details Modal -->
<p-dialog
  [(visible)]="showDetailsModal"
  [header]="(selectedAccessory?.name || '') + ' - Details'"
  [modal]="true"
  [style]="{width: '800px'}"
  [draggable]="false"
  [resizable]="false">
  <ng-template pTemplate="content">
    <div class="modal-body">
      <div class="details-grid" *ngIf="selectedAccessory">
        <div class="detail-section">
          <h4>Basic Information</h4>
          <div class="detail-row">
            <span class="label">Name:</span>
            <span class="value">{{ selectedAccessory.name }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Category:</span>
            <span class="value">{{ selectedAccessory.category }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Part Number:</span>
            <span class="value">{{ selectedAccessory.partNumber }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Description:</span>
            <span class="value">{{ selectedAccessory.description || 'N/A' }}</span>
          </div>
        </div>
        
        <div class="detail-section">
          <h4>Stock Information</h4>
          <div class="detail-row">
            <span class="label">Current Quantity:</span>
            <span class="value">{{ selectedAccessory.quantity }} {{ selectedAccessory.unit }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Minimum Stock Level:</span>
            <span class="value">{{ selectedAccessory.minStockLevel }} {{ selectedAccessory.unit }}</span>
          </div>
        </div>
        
        <div class="detail-section">
          <h4>Supplier Information</h4>
          <div class="detail-row">
            <span class="label">Supplier:</span>
            <span class="value">{{ selectedAccessory.supplier }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Storage Location:</span>
            <span class="value">{{ selectedAccessory.location || 'Not specified' }}</span>
          </div>
        </div>
        
        <div class="detail-section">
          <h4>Status & Dates</h4>
          <div class="detail-row">
            <span class="label">Status:</span>
            <span class="value">
              <span class="status-badge" [ngClass]="getStatusClass(selectedAccessory)">
                {{ getStatusDisplay(selectedAccessory) }}
              </span>
            </span>
          </div>
          <div class="detail-row">
            <span class="label">Last Updated:</span>
            <span class="value">{{ selectedAccessory.lastUpdated | date:'full' }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Created:</span>
            <span class="value">{{ selectedAccessory.createdAt | date:'full' }}</span>
          </div>
        </div>
      </div>
    </div>
  </ng-template>
  <ng-template pTemplate="footer">
    <p-button label="Close" severity="secondary" (onClick)="closeDetailsModal()"></p-button>
    <p-button
      label="Edit Accessory"
      icon="pi pi-pencil"
      (onClick)="editAccessory(selectedAccessory!)">
    </p-button>
  </ng-template>
</p-dialog>