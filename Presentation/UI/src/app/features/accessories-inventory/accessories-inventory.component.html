<div class="accessories-inventory">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <div class="title-section">
        <h1 class="page-title">
          <i class="fas fa-toolbox"></i>
          Accessories Inventory
        </h1>
        <p class="page-subtitle">Manage machine accessories, parts, and consumables</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" (click)="exportInventory()" [disabled]="isLoading">
          <i class="fas fa-download"></i>
          Export
        </button>
        <button class="btn btn-primary" (click)="refreshInventory()" [disabled]="isRefreshing">
          <i class="fas fa-sync-alt" [class.fa-spin]="isRefreshing"></i>
          Refresh
        </button>
        <button class="btn btn-success" (click)="openAddAccessoryModal()">
          <i class="fas fa-plus"></i>
          Add Accessory
        </button>
      </div>
    </div>
    <div class="timestamp">
      Last updated: {{ lastUpdated | date:'medium' }}
    </div>
  </div>

  <!-- Error Alert -->
  <div class="alert alert-danger" *ngIf="errorMessage">
    <i class="fas fa-exclamation-triangle"></i>
    {{ errorMessage }}
    <button class="alert-close" (click)="errorMessage = ''">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon available">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ statistics.totalAvailable }}</div>
        <div class="stat-label">Available</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon low-stock">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ statistics.lowStock }}</div>
        <div class="stat-label">Low Stock</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon out-of-stock">
        <i class="fas fa-times-circle"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ statistics.outOfStock }}</div>
        <div class="stat-label">Out of Stock</div>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-section">
    <div class="filters-row">
      <div class="search-box">
        <i class="pi pi-search"></i>
        <input
          pInputText
          type="text"
          placeholder="Search accessories..."
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()"
          class="search-input">
        <button *ngIf="searchTerm" class="clear-search" (click)="clearSearch()">
          <i class="pi pi-times"></i>
        </button>
      </div>

      <div class="filter-group">
        <p-dropdown
          [(ngModel)]="selectedCategory"
          [options]="categoryOptions"
          placeholder="All Categories"
          [showClear]="true"
          (onChange)="onCategoryFilterChange()"
          styleClass="filter-dropdown">
        </p-dropdown>
      </div>

      <div class="filter-group">
        <p-dropdown
          [(ngModel)]="selectedStatus"
          [options]="statusOptions"
          placeholder="All Status"
          [showClear]="true"
          (onChange)="onStatusFilterChange()"
          styleClass="filter-dropdown">
        </p-dropdown>
      </div>

      <div class="filter-group">
        <p-dropdown
          [(ngModel)]="selectedSupplier"
          [options]="supplierOptions"
          placeholder="All Suppliers"
          [showClear]="true"
          (onChange)="onSupplierFilterChange()"
          styleClass="filter-dropdown">
        </p-dropdown>
      </div>
    </div>

    <div class="active-filters" *ngIf="hasActiveFilters()">
      <span class="filter-label">Active filters:</span>
      <span class="filter-tag" *ngIf="searchTerm">
        Search: "{{ searchTerm }}"
        <button (click)="clearSearch()"><i class="pi pi-times"></i></button>
      </span>
      <span class="filter-tag" *ngIf="selectedCategory">
        Category: {{ selectedCategory }}
        <button (click)="selectedCategory = null; onCategoryFilterChange()"><i class="pi pi-times"></i></button>
      </span>
      <span class="filter-tag" *ngIf="selectedStatus">
        Status: {{ selectedStatus }}
        <button (click)="selectedStatus = null; onStatusFilterChange()"><i class="pi pi-times"></i></button>
      </span>
      <span class="filter-tag" *ngIf="selectedSupplier">
        Supplier: {{ selectedSupplier }}
        <button (click)="selectedSupplier = null; onSupplierFilterChange()"><i class="pi pi-times"></i></button>
      </span>
      <button class="clear-all-filters" (click)="clearAllFilters()">
        <i class="pi pi-times"></i> Clear All
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>Loading accessories inventory...</p>
    </div>
  </div>

  <!-- PrimeNG Table -->
  <div class="table-container" *ngIf="!isLoading">
    <p-table
      [value]="filteredAccessories"
      [paginator]="true"
      [rows]="rows"
      [first]="first"
      [rowsPerPageOptions]="[10, 25, 50, 100]"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} accessories"
      [tableStyle]="{ 'min-width': '50rem' }"
      styleClass="p-datatable-gridlines p-datatable-striped"
      [rowHover]="true"
      [sortField]="'name'"
      [sortOrder]="1"
      dataKey="id">

      <!-- Empty State -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="9" class="empty-state">
            <div class="empty-icon">
              <i class="pi pi-inbox" style="font-size: 4rem; color: #bdc3c7;"></i>
            </div>
            <h3>No Accessories Found</h3>
            <p *ngIf="hasActiveFilters()">No accessories match your current filters. Try adjusting your search criteria.</p>
            <p *ngIf="!hasActiveFilters()">No accessories have been added to the inventory yet.</p>
            <button class="btn btn-primary" (click)="openAddAccessoryModal()" *ngIf="!hasActiveFilters()">
              <i class="pi pi-plus"></i>
              Add First Accessory
            </button>
            <button class="btn btn-secondary" (click)="clearAllFilters()" *ngIf="hasActiveFilters()">
              <i class="pi pi-times"></i>
              Clear Filters
            </button>
          </td>
        </tr>
      </ng-template>

      <!-- Header -->
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="name">
            Name <p-sortIcon field="name"></p-sortIcon>
          </th>
          <th pSortableColumn="category">
            Category <p-sortIcon field="category"></p-sortIcon>
          </th>
          <th pSortableColumn="partNumber">
            Part Number <p-sortIcon field="partNumber"></p-sortIcon>
          </th>
          <th pSortableColumn="quantity">
            Quantity <p-sortIcon field="quantity"></p-sortIcon>
          </th>
          <th>Status</th>
          <th pSortableColumn="supplier">
            Supplier <p-sortIcon field="supplier"></p-sortIcon>
          </th>
          <th pSortableColumn="lastUpdated">
            Last Updated <p-sortIcon field="lastUpdated"></p-sortIcon>
          </th>
          <th style="width: 180px;">Actions</th>
        </tr>
      </ng-template>

      <!-- Body -->
      <ng-template pTemplate="body" let-accessory>
        <tr [ngClass]="{'low-stock-row': accessory.quantity <= accessory.minStockLevel}">
          <td class="accessory-name">
            <div class="name-cell">
              <strong>{{ accessory.name }}</strong>
              <small *ngIf="accessory.description">{{ accessory.description }}</small>
            </div>
          </td>
          <td>
            <p-tag [value]="accessory.category" [style]="{'background': '#ecf0f1', 'color': '#2c3e50'}"></p-tag>
          </td>
          <td class="part-number">{{ accessory.partNumber }}</td>
          <td class="quantity-cell">
            <div class="quantity-info">
              <span class="current-quantity" [class.low-stock]="accessory.quantity <= accessory.minStockLevel">
                {{ accessory.quantity }}
              </span>
              <span class="unit">{{ accessory.unit }}</span>
              <small class="min-stock">Min: {{ accessory.minStockLevel }}</small>
            </div>
          </td>
          <td>
            <p-tag
              [value]="getStatusDisplay(accessory)"
              [severity]="getStatusSeverity(accessory)">
            </p-tag>
          </td>
          <td class="supplier-cell">{{ accessory.supplier }}</td>
          <td class="date-cell">{{ accessory.lastUpdated | date:'short' }}</td>
          <td class="actions-cell">
            <div class="action-buttons">
              <p-button
                icon="pi pi-eye"
                [rounded]="true"
                [text]="true"
                severity="info"
                (onClick)="viewAccessoryDetails(accessory)"
                pTooltip="View Details"
                tooltipPosition="top">
              </p-button>
              <p-button
                icon="pi pi-pencil"
                [rounded]="true"
                [text]="true"
                severity="secondary"
                (onClick)="editAccessory(accessory)"
                pTooltip="Edit"
                tooltipPosition="top">
              </p-button>
              <p-button
                icon="pi pi-plus-circle"
                [rounded]="true"
                [text]="true"
                severity="warn"
                (onClick)="adjustStock(accessory)"
                pTooltip="Adjust Stock"
                tooltipPosition="top">
              </p-button>
              <p-button
                icon="pi pi-trash"
                [rounded]="true"
                [text]="true"
                severity="danger"
                (onClick)="deleteAccessory(accessory)"
                pTooltip="Delete"
                tooltipPosition="top">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<!-- Add/Edit Accessory Modal -->
<p-dialog
  [(visible)]="showAccessoryModal"
  [header]="isEditMode ? 'Edit Accessory' : 'Add New Accessory'"
  [modal]="true"
  [style]="{width: '600px'}"
  [draggable]="false"
  [resizable]="false">
  <ng-template pTemplate="content">
    <div class="modal-body">
      <form class="accessory-form">
        <div class="form-row">
          <div class="form-group">
            <label for="accessoryName">Name *</label>
            <input type="text" id="accessoryName" [(ngModel)]="accessoryForm.name" 
                   name="name" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="accessoryCategory">Category *</label>
            <select id="accessoryCategory" [(ngModel)]="accessoryForm.category" 
                    name="category" class="form-control" required>
              <option value="">Select Category</option>
              <option value="Engine Parts">Engine Parts</option>
              <option value="Hydraulic Parts">Hydraulic Parts</option>
              <option value="Electrical Components">Electrical Components</option>
              <option value="Filters">Filters</option>
              <option value="Belts & Hoses">Belts & Hoses</option>
              <option value="Lubricants">Lubricants</option>
              <option value="Safety Equipment">Safety Equipment</option>
              <option value="Tools">Tools</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="partNumber">Part Number *</label>
            <input type="text" id="partNumber" [(ngModel)]="accessoryForm.partNumber" 
                   name="partNumber" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="supplier">Supplier *</label>
            <input type="text" id="supplier" [(ngModel)]="accessoryForm.supplier" 
                   name="supplier" class="form-control" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="quantity">Current Quantity *</label>
            <input type="number" id="quantity" [(ngModel)]="accessoryForm.quantity" 
                   name="quantity" class="form-control" min="0" required>
          </div>
          <div class="form-group">
            <label for="unit">Unit *</label>
            <select id="unit" [(ngModel)]="accessoryForm.unit" 
                    name="unit" class="form-control" required>
              <option value="">Select Unit</option>
              <option value="pcs">Pieces</option>
              <option value="kg">Kilograms</option>
              <option value="ltr">Liters</option>
              <option value="m">Meters</option>
              <option value="box">Box</option>
              <option value="set">Set</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label for="minStockLevel">Minimum Stock Level *</label>
          <input type="number" id="minStockLevel" [(ngModel)]="accessoryForm.minStockLevel"
                 name="minStockLevel" class="form-control" min="0" required>
        </div>
        
        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" [(ngModel)]="accessoryForm.description" 
                    name="description" class="form-control" rows="3"></textarea>
        </div>
        
        <div class="form-group">
          <label for="location">Storage Location</label>
          <input type="text" id="location" [(ngModel)]="accessoryForm.location" 
                 name="location" class="form-control">
        </div>
      </form>
    </div>
  </ng-template>
  <ng-template pTemplate="footer">
    <p-button label="Cancel" severity="secondary" (onClick)="closeAccessoryModal()"></p-button>
    <p-button
      [label]="isEditMode ? 'Update Accessory' : 'Add Accessory'"
      (onClick)="saveAccessory()"
      [disabled]="!isAccessoryFormValid()">
    </p-button>
  </ng-template>
</p-dialog>

<!-- Stock Adjustment Modal -->
<p-dialog
  [(visible)]="showStockModal"
  [header]="'Adjust Stock - ' + (selectedAccessory?.name || '')"
  [modal]="true"
  [style]="{width: '500px'}"
  [draggable]="false"
  [resizable]="false">
  <ng-template pTemplate="content">
    <div class="modal-body">
      <div class="current-stock-info">
        <p><strong>Current Stock:</strong> {{ selectedAccessory?.quantity }} {{ selectedAccessory?.unit }}</p>
        <p><strong>Minimum Level:</strong> {{ selectedAccessory?.minStockLevel }} {{ selectedAccessory?.unit }}</p>
      </div>
      
      <form class="stock-form">
        <div class="form-group">
          <label for="adjustmentType">Adjustment Type</label>
          <select id="adjustmentType" [(ngModel)]="stockAdjustment.type" 
                  name="type" class="form-control">
            <option value="add">Add Stock</option>
            <option value="remove">Remove Stock</option>
            <option value="set">Set Exact Amount</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="adjustmentQuantity">
            {{ stockAdjustment.type === 'set' ? 'New Quantity' : 'Quantity to ' + (stockAdjustment.type === 'add' ? 'Add' : 'Remove') }}
          </label>
          <input type="number" id="adjustmentQuantity" [(ngModel)]="stockAdjustment.quantity" 
                 name="quantity" class="form-control" min="0" required>
        </div>
        
        <div class="form-group">
          <label for="adjustmentReason">Reason</label>
          <select id="adjustmentReason" [(ngModel)]="stockAdjustment.reason" 
                  name="reason" class="form-control">
            <option value="purchase">New Purchase</option>
            <option value="usage">Used in Maintenance</option>
            <option value="damaged">Damaged/Defective</option>
            <option value="lost">Lost/Missing</option>
            <option value="returned">Returned to Supplier</option>
            <option value="correction">Inventory Correction</option>
            <option value="other">Other</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="adjustmentNotes">Notes</label>
          <textarea id="adjustmentNotes" [(ngModel)]="stockAdjustment.notes" 
                    name="notes" class="form-control" rows="3"></textarea>
        </div>
        
        <div class="adjustment-preview" *ngIf="stockAdjustment.quantity > 0">
          <p><strong>New Stock Level:</strong> {{ calculateNewStock() }} {{ selectedAccessory?.unit }}</p>
        </div>
      </form>
    </div>
  </ng-template>
  <ng-template pTemplate="footer">
    <p-button label="Cancel" severity="secondary" (onClick)="closeStockModal()"></p-button>
    <p-button
      label="Apply Adjustment"
      (onClick)="applyStockAdjustment()"
      [disabled]="!stockAdjustment.quantity || stockAdjustment.quantity <= 0">
    </p-button>
  </ng-template>
</p-dialog>

<!-- Accessory Details Modal -->
<p-dialog
  [(visible)]="showDetailsModal"
  [header]="(selectedAccessory?.name || '') + ' - Details'"
  [modal]="true"
  [style]="{width: '800px'}"
  [draggable]="false"
  [resizable]="false">
  <ng-template pTemplate="content">
    <div class="modal-body">
      <div class="details-grid" *ngIf="selectedAccessory">
        <div class="detail-section">
          <h4>Basic Information</h4>
          <div class="detail-row">
            <span class="label">Name:</span>
            <span class="value">{{ selectedAccessory.name }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Category:</span>
            <span class="value">{{ selectedAccessory.category }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Part Number:</span>
            <span class="value">{{ selectedAccessory.partNumber }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Description:</span>
            <span class="value">{{ selectedAccessory.description || 'N/A' }}</span>
          </div>
        </div>
        
        <div class="detail-section">
          <h4>Stock Information</h4>
          <div class="detail-row">
            <span class="label">Current Quantity:</span>
            <span class="value">{{ selectedAccessory.quantity }} {{ selectedAccessory.unit }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Minimum Stock Level:</span>
            <span class="value">{{ selectedAccessory.minStockLevel }} {{ selectedAccessory.unit }}</span>
          </div>
        </div>
        
        <div class="detail-section">
          <h4>Supplier Information</h4>
          <div class="detail-row">
            <span class="label">Supplier:</span>
            <span class="value">{{ selectedAccessory.supplier }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Storage Location:</span>
            <span class="value">{{ selectedAccessory.location || 'Not specified' }}</span>
          </div>
        </div>
        
        <div class="detail-section">
          <h4>Status & Dates</h4>
          <div class="detail-row">
            <span class="label">Status:</span>
            <span class="value">
              <span class="status-badge" [ngClass]="getStatusClass(selectedAccessory)">
                {{ getStatusDisplay(selectedAccessory) }}
              </span>
            </span>
          </div>
          <div class="detail-row">
            <span class="label">Last Updated:</span>
            <span class="value">{{ selectedAccessory.lastUpdated | date:'full' }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Created:</span>
            <span class="value">{{ selectedAccessory.createdAt | date:'full' }}</span>
          </div>
        </div>
      </div>
    </div>
  </ng-template>
  <ng-template pTemplate="footer">
    <p-button label="Close" severity="secondary" (onClick)="closeDetailsModal()"></p-button>
    <p-button
      label="Edit Accessory"
      icon="pi pi-pencil"
      (onClick)="editAccessory(selectedAccessory!)">
    </p-button>
  </ng-template>
</p-dialog>