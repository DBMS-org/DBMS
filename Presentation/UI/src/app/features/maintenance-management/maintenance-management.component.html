<!-- Maintenance Management Component -->
<div class="maintenance-management">
  <!-- Page Header -->
  <div class="maintenance-header">
    <h1>Maintenance Management</h1>
    <div class="header-actions">
      <button
        class="schedule-btn"
        (click)="openScheduleModal()">
        <i class="material-icons">add</i>
        Schedule Maintenance
      </button>
      <button
        class="export-btn"
        (click)="exportMaintenanceData()"
        [disabled]="isExporting">
        <i class="material-icons">download</i>
        Export
      </button>
      <button
        class="refresh-btn"
        (click)="refreshData()"
        [disabled]="isLoading">
        <i class="material-icons">refresh</i>
        Refresh
      </button>
    </div>
  </div>

  <!-- Error notification display -->
  @if (errorMessage) {
    <div class="error-alert">
      <div class="error-content">
        <i class="material-icons">error_outline</i>
        <span>{{ errorMessage }}</span>
      </div>
      <button class="error-close" (click)="clearError()" type="button" aria-label="Close error">
        <i class="material-icons">close</i>
      </button>
    </div>
  }

  <!-- Statistics Grid -->
  <div class="stats-grid">
    <div class="stat-card scheduled">
      <div class="stat-icon">
        <i class="material-icons">event</i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.scheduled }}</h3>
        <p>Scheduled</p>
      </div>
    </div>

    <div class="stat-card in-progress">
      <div class="stat-icon">
        <i class="material-icons">build_circle</i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.inProgress }}</h3>
        <p>In Progress</p>
      </div>
    </div>

    <div class="stat-card overdue">
      <div class="stat-icon">
        <i class="material-icons">error</i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.overdue }}</h3>
        <p>Overdue</p>
      </div>
    </div>

    <div class="stat-card completed">
      <div class="stat-icon">
        <i class="material-icons">check_circle</i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.completed }}</h3>
        <p>Completed</p>
      </div>
    </div>
  </div>

  <!-- Search and Filter Section -->
  <div class="search-filter-section">
    <div class="search-box">
      <input
        type="text"
        class="form-control"
        [(ngModel)]="searchTerm"
        (input)="applyFilters()"
        placeholder="Search maintenance records..." />
    </div>

    <div class="filter-section">
      <div class="filter-group">
        <label class="filter-label">Status</label>
        <select
          class="form-select"
          [(ngModel)]="selectedStatus"
          (ngModelChange)="onStatusFilterChange()">
          <option value="">All Status</option>
          <option value="scheduled">Scheduled</option>
          <option value="in-progress">In Progress</option>
          <option value="completed">Completed</option>
          <option value="overdue">Overdue</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">Type</label>
        <select
          class="form-select"
          [(ngModel)]="selectedType"
          (ngModelChange)="onTypeFilterChange()">
          <option value="">All Types</option>
          <option value="preventive">Preventive</option>
          <option value="corrective">Corrective</option>
          <option value="emergency">Emergency</option>
          <option value="inspection">Inspection</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">Priority</label>
        <select
          class="form-select"
          [(ngModel)]="selectedPriority"
          (ngModelChange)="onPriorityFilterChange()">
          <option value="">All Priorities</option>
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
          <option value="critical">Critical</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Modern Table Section -->
  <div class="table-section">
    <div class="table-header">
      <div class="table-title">
        <i class="material-icons">view_list</i>
        <span>Maintenance Records</span>
        <span class="request-count">{{ filteredMaintenanceRecords.length }}</span>
      </div>
    </div>

    <!-- Loading State -->
    @if (isLoading) {
      <div class="loading-state">
        <div class="loader-spinner"></div>
        <p>Loading maintenance records...</p>
      </div>
    }

    <!-- Empty State -->
    @if (!isLoading && filteredMaintenanceRecords.length === 0) {
      <div class="empty-state">
        <div class="empty-icon">
          <i class="material-icons">inbox</i>
        </div>
        <h3>No Maintenance Records Found</h3>
        <p>
          @if (hasActiveFilters() || searchTerm) {
            No maintenance records match your current filters.
          } @else {
            No maintenance activities have been scheduled yet.
          }
        </p>
        @if (!hasActiveFilters() && !searchTerm) {
          <button class="empty-action-btn" (click)="openScheduleModal()" type="button">
            Schedule First Maintenance
          </button>
        } @else {
          <button class="empty-action-btn" (click)="clearAllFilters()" type="button">
            Clear Filters
          </button>
        }
      </div>
    }

    <!-- Modern Table -->
    @if (!isLoading && filteredMaintenanceRecords.length > 0) {
      <div class="maintenance-table-wrapper">
        <p-table
          [value]="filteredMaintenanceRecords"
          styleClass="modern-table"
          responsiveLayout="scroll"
          [paginator]="true"
          [rows]="10"
          [rowsPerPageOptions]="[10, 25, 50]"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Showing {first} to {last} of {totalRecords}"
          [rowHover]="true"
          dataKey="id">

          <ng-template pTemplate="header">
            <tr>
              <th pSortableColumn="machineName" class="col-machine">
                Machine
                <p-sortIcon field="machineName"></p-sortIcon>
              </th>
              <th pSortableColumn="type" class="col-type">
                Type
                <p-sortIcon field="type"></p-sortIcon>
              </th>
              <th pSortableColumn="priority" class="col-priority">
                Priority
                <p-sortIcon field="priority"></p-sortIcon>
              </th>
              <th pSortableColumn="scheduledDate" class="col-date">
                Scheduled Date
                <p-sortIcon field="scheduledDate"></p-sortIcon>
              </th>
              <th pSortableColumn="status" class="col-status">
                Status
                <p-sortIcon field="status"></p-sortIcon>
              </th>
              <th class="col-technician">Technician</th>
              <th class="col-duration">Duration</th>
              <th class="col-actions">Actions</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-record>
            <tr [ngClass]="{'overdue-row': record.status === 'overdue', 'critical-row': record.priority === 'critical'}">
              <td class="col-machine">
                <div class="machine-cell">
                  <i class="material-icons">precision_manufacturing</i>
                  <div class="machine-info">
                    <span class="machine-name">{{ record.machineName }}</span>
                    <span class="machine-detail">{{ record.machineModel }} - {{ record.rigNo }}</span>
                  </div>
                </div>
              </td>
              <td class="col-type">
                <span class="type-badge type-{{ record.type }}">
                  {{ record.type | titlecase }}
                </span>
              </td>
              <td class="col-priority">
                <span class="priority-badge priority-{{ record.priority }}">
                  {{ record.priority | titlecase }}
                </span>
              </td>
              <td class="col-date">
                <div class="date-cell">
                  <i class="material-icons">event</i>
                  <div class="date-info">
                    <span>{{ record.scheduledDate | date:'MMM dd, yyyy' }}</span>
                    <small>{{ record.scheduledTime }}</small>
                  </div>
                </div>
              </td>
              <td class="col-status">
                <span class="status-badge status-{{ record.status }}">
                  <i class="material-icons">
                    {{ record.status === 'completed' ? 'check_circle' :
                       record.status === 'in-progress' ? 'build_circle' :
                       record.status === 'overdue' ? 'error' : 'schedule' }}
                  </i>
                  {{ record.status | titlecase }}
                </span>
              </td>
              <td class="col-technician">
                <div class="technician-cell">
                  <i class="material-icons">person</i>
                  <span>{{ record.assignedTechnician }}</span>
                </div>
              </td>
              <td class="col-duration">
                <span class="duration-badge">{{ record.estimatedDuration }}h</span>
              </td>
              <td class="col-actions">
                <div class="action-buttons">
                  <button
                    class="action-btn view-btn"
                    (click)="viewMaintenanceDetails(record)"
                    title="View Details">
                    <i class="material-icons">visibility</i>
                  </button>
                  @if (record.status !== 'completed') {
                    <button
                      class="action-btn edit-btn"
                      (click)="editMaintenance(record)"
                      title="Edit">
                      <i class="material-icons">edit</i>
                    </button>
                  }
                  @if (record.status === 'scheduled') {
                    <button
                      class="action-btn start-btn"
                      (click)="startMaintenance(record)"
                      title="Start Maintenance">
                      <i class="material-icons">play_arrow</i>
                    </button>
                  }
                  @if (record.status === 'in-progress') {
                    <button
                      class="action-btn complete-btn"
                      (click)="completeMaintenance(record)"
                      title="Complete">
                      <i class="material-icons">check</i>
                    </button>
                  }
                  @if (record.status === 'scheduled') {
                    <button
                      class="action-btn cancel-btn"
                      (click)="cancelMaintenance(record)"
                      title="Cancel">
                      <i class="material-icons">close</i>
                    </button>
                  }
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    }
  </div>
</div>

<!-- Schedule Maintenance Modal -->
<div class="modal-overlay" *ngIf="showScheduleModal" (click)="closeScheduleModal()">
  <div class="modal-content large-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ editingMaintenance ? 'Edit Maintenance' : 'Schedule Maintenance' }}</h3>
      <button class="modal-close" (click)="closeScheduleModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form class="maintenance-form" (ngSubmit)="saveMaintenance()" #maintenanceForm="ngForm">
        <div class="form-row">
          <div class="form-group">
            <label for="machineId">Machine *</label>
            <select id="machineId" 
                    class="form-control" 
                    [(ngModel)]="maintenanceFormData.machineId" 
                    name="machineId" 
                    required>
              <option value="">Select Machine</option>
              <option *ngFor="let machine of availableMachines" [value]="machine.id">
                {{ machine.name }} - {{ machine.model }} ({{ machine.rigNo }})
              </option>
            </select>
          </div>
          <div class="form-group">
            <label for="type">Maintenance Type *</label>
            <select id="type" 
                    class="form-control" 
                    [(ngModel)]="maintenanceFormData.type" 
                    name="type" 
                    required>
              <option value="">Select Type</option>
              <option value="preventive">Preventive</option>
              <option value="corrective">Corrective</option>
              <option value="emergency">Emergency</option>
              <option value="inspection">Inspection</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="priority">Priority *</label>
            <select id="priority" 
                    class="form-control" 
                    [(ngModel)]="maintenanceFormData.priority" 
                    name="priority" 
                    required>
              <option value="">Select Priority</option>
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
              <option value="critical">Critical</option>
            </select>
          </div>
          <div class="form-group">
            <label for="assignedTechnician">Assigned Technician *</label>
            <select id="assignedTechnician" 
                    class="form-control" 
                    [(ngModel)]="maintenanceFormData.assignedTechnician" 
                    name="assignedTechnician" 
                    required>
              <option value="">Select Technician</option>
              <option *ngFor="let technician of availableTechnicians" [value]="technician">
                {{ technician }}
              </option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="scheduledDate">Scheduled Date *</label>
            <input type="date" 
                   id="scheduledDate" 
                   class="form-control" 
                   [(ngModel)]="maintenanceFormData.scheduledDate" 
                   name="scheduledDate" 
                   required>
          </div>
          <div class="form-group">
            <label for="scheduledTime">Scheduled Time *</label>
            <input type="time" 
                   id="scheduledTime" 
                   class="form-control" 
                   [(ngModel)]="maintenanceFormData.scheduledTime" 
                   name="scheduledTime" 
                   required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="estimatedDuration">Estimated Duration (hours) *</label>
            <input type="number" 
                   id="estimatedDuration" 
                   class="form-control" 
                   [(ngModel)]="maintenanceFormData.estimatedDuration" 
                   name="estimatedDuration" 
                   min="0.5" 
                   step="0.5" 
                   required>
          </div>
          <div class="form-group">
            <label for="cost">Estimated Cost</label>
            <input type="number" 
                   id="cost" 
                   class="form-control" 
                   [(ngModel)]="maintenanceFormData.cost" 
                   name="cost" 
                   min="0" 
                   step="0.01" 
                   placeholder="0.00">
          </div>
        </div>
        <div class="form-group">
          <label for="description">Description *</label>
          <textarea id="description" 
                    class="form-control" 
                    [(ngModel)]="maintenanceFormData.description" 
                    name="description" 
                    rows="3" 
                    placeholder="Describe the maintenance work to be performed..."
                    required></textarea>
        </div>
        <div class="form-group">
          <label for="notes">Additional Notes</label>
          <textarea id="notes" 
                    class="form-control" 
                    [(ngModel)]="maintenanceFormData.notes" 
                    name="notes" 
                    rows="2" 
                    placeholder="Any additional notes or special instructions..."></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeScheduleModal()">
        Cancel
      </button>
      <button type="submit" 
              class="btn btn-primary" 
              (click)="saveMaintenance()" 
              [disabled]="!isMaintenanceFormValid() || isSaving">
        <i class="fas fa-spinner fa-spin" *ngIf="isSaving"></i>
        <i class="fas fa-save" *ngIf="!isSaving"></i>
        {{ editingMaintenance ? 'Update' : 'Schedule' }} Maintenance
      </button>
    </div>
  </div>
</div>

<!-- Maintenance Details Modal -->
<div class="modal-overlay" *ngIf="showDetailsModal" (click)="closeDetailsModal()">
  <div class="modal-content large-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Maintenance Details</h3>
      <button class="modal-close" (click)="closeDetailsModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body" *ngIf="selectedMaintenance as record">
      <!-- Identification details -->
      <div class="detail-row">
        <span class="label">Record ID</span>
        <span class="value">{{ record.id }}</span>
      </div>
      <div class="detail-row">
        <span class="label">Machine Name</span>
        <span class="value">{{ record.machineName }}</span>
      </div>
      <div class="detail-row">
        <span class="label">Model</span>
        <span class="value">{{ record.machineModel }}</span>
      </div>
      <div class="detail-row">
        <span class="label">Rig No</span>
        <span class="value">{{ record.rigNo }}</span>
      </div>
  
      <!-- Badges -->
      <div class="detail-row">
        <span class="label">Type</span>
        <span class="type-badge" [class]="'type-' + record.type">{{ record.type | titlecase }}</span>
      </div>
      <div class="detail-row">
        <span class="label">Priority</span>
        <span class="priority-badge" [class]="'priority-' + record.priority">{{ record.priority | titlecase }}</span>
      </div>
      <div class="detail-row">
        <span class="label">Status</span>
        <span class="status-badge" [class]="'status-' + record.status">{{ record.status | titlecase }}</span>
      </div>
  
      <!-- Scheduling details -->
      <div class="detail-row">
        <span class="label">Scheduled Date</span>
        <span class="value">{{ record.scheduledDate | date:'fullDate' }}</span>
      </div>
      <div class="detail-row">
        <span class="label">Scheduled Time</span>
        <span class="value">{{ record.scheduledTime }}</span>
      </div>
      <div class="detail-row">
        <span class="label">Technician</span>
        <span class="value">{{ record.assignedTechnician }}</span>
      </div>
      <div class="detail-row">
        <span class="label">Estimated Duration</span>
        <span class="value">{{ record.estimatedDuration }} hours</span>
      </div>
      <div class="detail-row" *ngIf="record.actualDuration">
        <span class="label">Actual Duration</span>
        <span class="value">{{ record.actualDuration }} hours</span>
      </div>
      <div class="detail-row" *ngIf="record.cost">
        <span class="label">Estimated Cost</span>
        <span class="value">${{ record.cost | number:'1.2-2' }}</span>
      </div>
      <div class="detail-row" *ngIf="record.actualCost">
        <span class="label">Actual Cost</span>
        <span class="value">${{ record.actualCost | number:'1.2-2' }}</span>
      </div>
  
      <!-- Description and notes -->
      <div class="detail-section full-width">
        <span class="label">Description</span>
        <p class="description-text">{{ record.description }}</p>
      </div>
      <div class="detail-section full-width" *ngIf="record.notes">
        <span class="label">Notes</span>
        <p class="notes-text">{{ record.notes }}</p>
      </div>
      <div class="detail-section full-width" *ngIf="record.completionNotes">
        <span class="label">Completion Notes</span>
        <p class="completion-notes">{{ record.completionNotes }}</p>
      </div>
  
      <!-- Actions -->
      <div class="modal-actions">
        <button class="btn btn-primary" (click)="editMaintenance(record)" *ngIf="record.status !== 'completed'">Edit</button>
        <button type="button" class="btn btn-secondary" (click)="closeDetailsModal()">
          Close
        </button>
        <button type="button" 
                class="btn btn-primary" 
                (click)="editMaintenance(selectedMaintenance)"
                *ngIf="selectedMaintenance?.status !== 'completed'">
          <i class="fas fa-edit"></i>
          Edit Maintenance
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Complete Maintenance Modal -->
<div class="modal-overlay" *ngIf="showCompleteModal" (click)="closeCompleteModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Complete Maintenance</h3>
      <button class="modal-close" (click)="closeCompleteModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form class="completion-form">
        <div class="form-group">
          <label for="actualDuration">Actual Duration (hours) *</label>
          <input type="number" 
                 id="actualDuration" 
                 class="form-control" 
                 [(ngModel)]="completionData.actualDuration" 
                 name="actualDuration" 
                 min="0.1" 
                 step="0.1" 
                 required>
        </div>
        <div class="form-group">
          <label for="actualCost">Actual Cost</label>
          <input type="number" 
                 id="actualCost" 
                 class="form-control" 
                 [(ngModel)]="completionData.actualCost" 
                 name="actualCost" 
                 min="0" 
                 step="0.01" 
                 placeholder="0.00">
        </div>
        <div class="form-group">
          <label for="completionNotes">Completion Notes *</label>
          <textarea id="completionNotes" 
                    class="form-control" 
                    [(ngModel)]="completionData.completionNotes" 
                    name="completionNotes" 
                    rows="4" 
                    placeholder="Describe the work performed, parts used, issues found, etc..."
                    required></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeCompleteModal()">
        Cancel
      </button>
      <button type="button" 
              class="btn btn-success" 
              (click)="confirmCompleteMaintenance()" 
              [disabled]="!isCompletionFormValid() || isSaving">
        <i class="fas fa-spinner fa-spin" *ngIf="isSaving"></i>
        <i class="fas fa-check" *ngIf="!isSaving"></i>
        Complete Maintenance
      </button>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal-overlay" *ngIf="showConfirmModal" (click)="closeConfirmModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ confirmModalData.title }}</h3>
      <button class="modal-close" (click)="closeConfirmModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p>{{ confirmModalData.message }}</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeConfirmModal()">
        Cancel
      </button>
      <button type="button" 
              class="btn" 
              [class]="confirmModalData.confirmButtonClass" 
              (click)="confirmModalData.onConfirm()" 
              [disabled]="isSaving">
        <i class="fas fa-spinner fa-spin" *ngIf="isSaving"></i>
        {{ confirmModalData.confirmButtonText }}
      </button>
    </div>
  </div>
</div>