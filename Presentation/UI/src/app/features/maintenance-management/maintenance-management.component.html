<div class="maintenance-management">
  <!-- Page Header -->
  <div class="maintenance-header">
    <h1>Maintenance Management</h1>
    <div class="header-actions">
      <button class="refresh-btn" (click)="refreshData()" [disabled]="isLoading">
        <i class="material-icons">refresh</i>
        Refresh
      </button>
    </div>
  </div>

  <!-- Error notification -->
  @if (errorMessage) {
    <div class="error-alert">
      <div class="error-content">
        <i class="material-icons">error_outline</i>
        <span>{{ errorMessage }}</span>
      </div>
      <button class="error-close" (click)="clearError()" type="button">
        <i class="material-icons">close</i>
      </button>
    </div>
  }

  <!-- Statistics Grid -->
  <div class="stats-grid">
    <div class="stat-card scheduled">
      <div class="stat-icon"><i class="material-icons">event</i></div>
      <div class="stat-content">
        <h3>{{ statistics.scheduledJobs }}</h3>
        <p>Scheduled</p>
      </div>
    </div>
    <div class="stat-card in-progress">
      <div class="stat-icon"><i class="material-icons">build_circle</i></div>
      <div class="stat-content">
        <h3>{{ statistics.inProgressJobs }}</h3>
        <p>In Progress</p>
      </div>
    </div>
    <div class="stat-card overdue">
      <div class="stat-icon"><i class="material-icons">error</i></div>
      <div class="stat-content">
        <h3>{{ statistics.overdueJobs }}</h3>
        <p>Overdue</p>
      </div>
    </div>
    <div class="stat-card completed">
      <div class="stat-icon"><i class="material-icons">check_circle</i></div>
      <div class="stat-content">
        <h3>{{ statistics.completedJobs }}</h3>
        <p>Completed</p>
      </div>
    </div>
  </div>

  <!-- Service Alerts Section -->
  @if (serviceAlerts.length > 0) {
    <div class="service-alerts-section">
      <h2><i class="material-icons">warning</i> Service Due Alerts</h2>
      <div class="alerts-grid">
        @for (alert of serviceAlerts.slice(0, 4); track alert.machineId) {
          <div class="alert-card" [ngClass]="getAlertLevelClass(alert.alertLevel)">
            <div class="alert-header">
              <span class="machine-name">{{ alert.machineName }}</span>
              <span class="alert-badge">{{ alert.alertLevel }}</span>
            </div>
            <div class="alert-body">
              <p><strong>{{ alert.serviceType }}</strong></p>
              <p>{{ alert.currentHours | number:'1.0-0' }} / {{ alert.intervalHours | number:'1.0-0' }} hrs</p>
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="alert.percentageUsed"></div>
              </div>
              <p class="remaining">{{ alert.hoursRemaining | number:'1.0-0' }} hrs remaining</p>
            </div>
          </div>
        }
      </div>
    </div>
  }

  <!-- Search and Filter Section -->
  <div class="search-filter-section">
    <div class="search-box">
      <input type="text" class="form-control" [(ngModel)]="searchTerm"
             (input)="onSearchChange()" placeholder="Search by machine, serial, project..." />
    </div>
    <div class="filter-section">
      <select class="form-select" [(ngModel)]="selectedStatus" (ngModelChange)="onStatusFilterChange()" title="Filter by status">
        <option value="">All Status</option>
        <option value="Scheduled">Scheduled</option>
        <option value="InProgress">In Progress</option>
        <option value="Completed">Completed</option>
        <option value="Overdue">Overdue</option>
      </select>
      <select class="form-select" [(ngModel)]="selectedType" (ngModelChange)="onTypeFilterChange()" title="Filter by type">
        <option value="">All Types</option>
        <option value="Preventive">Preventive</option>
        <option value="Corrective">Corrective</option>
        <option value="Emergency">Emergency</option>
      </select>
      <button class="clear-btn" (click)="clearAllFilters()">Clear Filters</button>
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Loading maintenance data...</p>
    </div>
  }

  <!-- Empty State -->
  @if (!isLoading && filteredJobs.length === 0) {
    <div class="empty-state">
      <i class="material-icons">inbox</i>
      <h3>No Maintenance Jobs Found</h3>
      <p>No maintenance jobs match your current filters.</p>
    </div>
  }

  <!-- Jobs Table -->
  @if (!isLoading && filteredJobs.length > 0) {
    <div class="table-container">
      <table class="jobs-table">
        <thead>
          <tr>
            <th (click)="sortBy('machineName')" class="sortable">
              Machine
              @if (sortField === 'machineName') {
                <i class="material-icons">{{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}</i>
              }
            </th>
            <th>Serial No.</th>
            <th>Project</th>
            <th (click)="sortBy('type')" class="sortable">Type</th>
            <th (click)="sortBy('status')" class="sortable">Status</th>
            <th>Priority</th>
            <th (click)="sortBy('scheduledDate')" class="sortable">Scheduled</th>
            <th>Assigned To</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (job of paginatedJobs; track job.id) {
            <tr>
              <td>
                <strong>{{ job.machineName }}</strong>
                <small class="model-text">{{ job.machineModel }}</small>
              </td>
              <td>{{ job.serialNumber }}</td>
              <td>{{ job.projectName || 'N/A' }}</td>
              <td>
                <span class="type-badge" [ngClass]="'type-' + job.type.toLowerCase()">
                  {{ job.type }}
                </span>
              </td>
              <td>
                <span class="status-badge" [ngClass]="getStatusClass(job.status)">
                  {{ job.status }}
                </span>
              </td>
              <td>
                <span class="priority-badge" [ngClass]="getPriorityClass(job.serviceAlertLevel)">
                  {{ job.serviceAlertLevel || 'Normal' }}
                </span>
              </td>
              <td>{{ job.scheduledDate | date:'short' }}</td>
              <td>{{ getAssignedEngineer(job) }}</td>
              <td>
                <button class="action-btn view-btn" (click)="viewJobDetails(job)" title="View Details">
                  <i class="material-icons">visibility</i>
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination">
      <div class="pagination-info">
        Showing {{ getStartIndex() + 1 }} to {{ getEndIndex() }} of {{ filteredJobs.length }} jobs
      </div>
      <div class="pagination-controls">
        <button (click)="previousPage()" [disabled]="currentPage === 1">
          <i class="material-icons">chevron_left</i>
        </button>
        @for (page of getPageNumbers(); track page) {
          <button [class.active]="currentPage === page" (click)="goToPage(page)">
            {{ page }}
          </button>
        }
        <button (click)="nextPage()" [disabled]="currentPage === totalPages">
          <i class="material-icons">chevron_right</i>
        </button>
        <select [(ngModel)]="pageSize" (ngModelChange)="onPageSizeChange()" title="Items per page">
          <option [value]="10">10</option>
          <option [value]="25">25</option>
          <option [value]="50">50</option>
        </select>
      </div>
    </div>
  }

  <!-- Last Updated -->
  <div class="last-updated">
    Last updated: {{ lastUpdated | date:'medium' }}
  </div>
</div>
