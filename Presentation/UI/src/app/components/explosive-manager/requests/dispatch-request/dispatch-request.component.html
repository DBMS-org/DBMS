<ng-template #loadingTpl>
  <div class="loading-overlay fade-in">
    <div class="loading-content scale-in">
      <mat-spinner diameter="40" color="primary"></mat-spinner>
      <div class="loading-text">Loading dispatch request details...</div>
    </div>
  </div>
</ng-template>

<div class="dispatch-container fade-in" *ngIf="request && !isLoading; else loadingTpl">
  <!-- Enhanced Page Header -->
  <div class="page-header slide-in-up">
    <div class="header-top">
      <div class="header-left">
        <button type="button" mat-icon-button (click)="goBack()" class="back-button" matTooltip="Go back to requests">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <div class="header-content">
          <div class="title-section">
            <div class="icon-wrapper">
              <mat-icon class="title-icon">local_shipping</mat-icon>
            </div>
            <div class="title-text">
              <h1 class="main-title">Dispatch Request</h1>
              <div class="request-meta">
                <div class="meta-item">
                  <mat-icon>tag</mat-icon>
                  <span class="request-id">{{request.requestNumber}}</span>
                </div>
                <div class="meta-item">
                  <mat-icon>event</mat-icon>
                  <span class="request-date">{{request.requestDate | date:'MMM dd, yyyy'}}</span>
                </div>
                <div class="meta-item">
                  <mat-icon>person</mat-icon>
                  <span class="requester">{{request.requestedByUserName}}</span>
                </div>
              </div>
            </div>
          </div>
          <p class="subtitle">Prepare and schedule dispatch for approved explosive materials</p>
        </div>
      </div>
      <div class="header-right">
        <div class="status-section">
          <span class="status-label">Current Status</span>
          <div class="status-chip" [ngClass]="'status-' + (request?.statusName | lowercase)" *ngIf="request?.status">
            <mat-icon class="status-icon">local_shipping</mat-icon>
            <span class="status-text">{{ request?.statusName }}</span>
          </div>
        </div>
        <div class="priority-badge" *ngIf="request?.isUrgent">
          <mat-icon>priority_high</mat-icon>
          <span>Urgent</span>
        </div>
      </div>
    </div>
    
    <!-- Enhanced Progress Indicator -->
    <div class="progress-indicator bounce-in">
      <div class="progress-step completed">
        <div class="step-circle">
          <mat-icon>assignment_turned_in</mat-icon>
        </div>
        <div class="step-content">
          <span class="step-title">Request Submitted</span>
          <span class="step-subtitle">{{request.requestDate | date:'MMM dd'}}</span>
        </div>
      </div>
      <div class="progress-line completed"></div>
      <div class="progress-step completed">
        <div class="step-circle">
          <mat-icon>verified</mat-icon>
        </div>
        <div class="step-content">
          <span class="step-title">Approved</span>
          <span class="step-subtitle">{{request.approvedDate | date:'MMM dd'}}</span>
        </div>
      </div>
      <div class="progress-line" [ngClass]="{'completed': request?.dispatchDate}"></div>
      <div class="progress-step" [ngClass]="{'active': !request?.dispatchDate, 'completed': request?.dispatchDate}">
        <div class="step-circle">
          <mat-icon>{{request?.dispatchDate ? 'check_circle' : 'local_shipping'}}</mat-icon>
        </div>
        <div class="step-content">
          <span class="step-title">{{request?.dispatchDate ? 'Dispatched' : 'Ready for Dispatch'}}</span>
          <span class="step-subtitle">{{request?.dispatchDate ? (request.dispatchDate | date:'MMM dd') : 'In Progress'}}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Content Grid -->
  <div class="content-grid">
    <!-- Request Summary Card -->
    <div class="summary-card">
      <div class="card-header">
        <div class="header-icon">
          <mat-icon>info_outline</mat-icon>
        </div>
        <div class="header-text">
          <h3>Request Summary</h3>
          <p>Overview of the explosive request details</p>
        </div>
        <div class="card-actions">
          <button mat-icon-button matTooltip="View full details">
            <mat-icon>visibility</mat-icon>
          </button>
        </div>
      </div>
      
      <div class="summary-content">
        <div class="summary-grid">
          <div class="summary-item">
            <div class="item-icon"><mat-icon>location_on</mat-icon></div>
            <div class="item-content">
              <label>Destination Store</label>
              <span class="value">{{request.destinationStoreName}}</span>
            </div>
          </div>
          
          <div class="summary-item">
            <div class="item-icon"><mat-icon>science</mat-icon></div>
            <div class="item-content">
              <label>Explosive Type</label>
              <span class="value explosive-type" [ngClass]="'type-' + (request.explosiveTypeName | lowercase)">{{request.explosiveTypeName}}</span>
            </div>
          </div>
          

          
          <div class="summary-item">
            <div class="item-icon"><mat-icon>schedule</mat-icon></div>
            <div class="item-content">
              <label>Required Date</label>
              <span class="value">{{ request?.requiredByDate | date: 'MMM dd, yyyy' }}</span>
            </div>
          </div>
          
          <div class="summary-item">
            <div class="item-icon"><mat-icon>person</mat-icon></div>
            <div class="item-content">
              <label>Requester</label>
              <span class="value">{{ request?.requestedByUserName }}</span>
            </div>
          </div>
          
          <div class="summary-item" *ngIf="request.dispatchDate">
            <div class="item-icon"><mat-icon>flight_takeoff</mat-icon></div>
            <div class="item-content">
              <label>Dispatch Date</label>
              <span class="value">{{request.dispatchDate | date:'MMM dd, yyyy'}}</span>
            </div>
          </div>
        </div>
        
        <!-- Purpose Section -->
        <div class="purpose-section" *ngIf="request.requestNotes">
          <div class="section-header">
            <mat-icon>description</mat-icon>
            <span>Request Notes</span>
          </div>
          <p class="purpose-text">{{request.requestNotes}}</p>
        </div>

        <!-- Additional Info -->
        <div class="additional-info" *ngIf="request.approvalNotes">
          <div class="section-header">
            <mat-icon>note</mat-icon>
            <span>Approval Notes</span>
          </div>
          <p class="notes-text">{{request.approvalNotes}}</p>
        </div>
      </div>
    </div>

    <!-- Enhanced Dispatch Form -->
    <div class="dispatch-form-card">
      <div class="card-header">
        <div class="header-icon">
          <mat-icon>local_shipping</mat-icon>
        </div>
        <div class="header-text">
          <h3>Dispatch Information</h3>
          <p>Enter dispatch details and logistics information</p>
        </div>
        <div class="card-badge">
          <mat-icon>schedule</mat-icon>
          <span>Required</span>
        </div>
      </div>
      
      <form [formGroup]="dispatchForm" (ngSubmit)="submit()" class="dispatch-form">
        <!-- Transportation Section -->
        <div class="form-section">
          <div class="section-title">
            <div class="title-icon">
              <mat-icon>local_shipping</mat-icon>
            </div>
            <div class="title-content">
              <span class="title-text">Transportation Details</span>
              <span class="title-subtitle">Vehicle and driver information</span>
            </div>
          </div>
          <div class="form-grid">
            <mat-form-field appearance="outline" class="enhanced-field">
              <mat-label>Truck Number</mat-label>
              <input matInput formControlName="truckNumber" placeholder="e.g., TRK-001" [disabled]="isSubmitting" />
              <mat-icon matPrefix>local_shipping</mat-icon>
              <mat-hint>Vehicle identification number</mat-hint>
              <mat-error *ngIf="hasError('truckNumber')">{{ getError('truckNumber') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="enhanced-field">
              <mat-label>Driver Name</mat-label>
              <input matInput formControlName="driverName" placeholder="Enter driver's full name" [disabled]="isSubmitting" />
              <mat-icon matPrefix>person</mat-icon>
              <mat-hint>Authorized driver for this dispatch</mat-hint>
              <mat-error *ngIf="hasError('driverName')">{{ getError('driverName') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="enhanced-field">
              <mat-label>Driver Contact Number</mat-label>
              <input matInput formControlName="driverContactNumber" placeholder="Phone number (optional)" [disabled]="isSubmitting" />
              <mat-icon matPrefix>phone</mat-icon>
              <mat-hint>Contact number for driver</mat-hint>
              <mat-error *ngIf="hasError('driverContactNumber')">{{ getError('driverContactNumber') }}</mat-error>
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline" class="full-width enhanced-field">
            <mat-label>Dispatch Notes</mat-label>
            <textarea matInput formControlName="dispatchNotes" rows="3"
                      placeholder="Any additional notes or special instructions"
                      [disabled]="isSubmitting"></textarea>
            <mat-icon matPrefix>note</mat-icon>
            <mat-hint>Optional: Add any special handling or delivery instructions</mat-hint>
          </mat-form-field>
        </div>

        <!-- Enhanced Action Buttons -->
        <div class="action-buttons">
          <div class="button-group">
            <button mat-stroked-button 
                    type="button" 
                    class="cancel-btn"
                    [disabled]="isSubmitting"
                    (click)="goBack()">
              <mat-icon>arrow_back</mat-icon>
              <span>Cancel</span>
            </button>
            
            <button mat-raised-button 
                    type="submit" 
                    color="primary"
                    class="submit-btn"
                    [disabled]="dispatchForm.invalid || isSubmitting">
              <div class="button-content">
                <mat-icon *ngIf="!isSubmitting">send</mat-icon>
                <mat-spinner *ngIf="isSubmitting" diameter="20" color="accent"></mat-spinner>
                <span>{{ isSubmitting ? 'Processing...' : 'Dispatch Request' }}</span>
              </div>
            </button>
          </div>
          
          <!-- Form Status Indicator -->
          <div class="form-status" *ngIf="dispatchForm.invalid && dispatchForm.touched">
            <mat-icon class="warning-icon">warning</mat-icon>
            <span>Please complete all required fields</span>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>