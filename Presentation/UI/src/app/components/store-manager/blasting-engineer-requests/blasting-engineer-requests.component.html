<div class="p-4 min-h-screen bg-gray-50">
  <!-- Header Section -->
  <div class="mb-3">
    <p-panel>
      <ng-template pTemplate="header">
        <div class="flex items-center justify-between flex-wrap gap-2 w-full p-2">
          <div class="flex-1">
            <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2 m-0">
              <i class="pi pi-wrench text-blue-600 text-lg"></i>
              Blasting Engineer Requests
            </h2>
            <p class="text-gray-600 text-xs mt-0.5 mb-0">Manage explosive material requests from blasting engineers in your region</p>
          </div>
          <p-button
            label="Refresh"
            icon="pi pi-refresh"
            (onClick)="refreshRequests()"
            [disabled]="isLoading"
            size="small">
          </p-button>
        </div>
      </ng-template>

      @if (currentUserRegion || currentUserCountry || currentUserName) {
        <div class="flex flex-wrap gap-2 p-2 bg-blue-50 rounded-md border-l-4 border-blue-600">
          @if (currentUserName) {
            <div class="flex items-center gap-1.5 text-xs text-gray-700">
              <i class="pi pi-user text-blue-600 text-xs"></i>
              <span>{{ getUserDisplayInfo() }}</span>
            </div>
          }
          @if (currentUserRegion) {
            <div class="flex items-center gap-1.5 text-xs text-gray-700">
              <i class="pi pi-map-marker text-blue-600 text-xs"></i>
              <span>Region: {{ currentUserRegion }}</span>
            </div>
          }
          @if (currentUserCountry) {
            <div class="flex items-center gap-1.5 text-xs text-gray-700">
              <i class="pi pi-globe text-blue-600 text-xs"></i>
              <span>Country: {{ currentUserCountry }}</span>
            </div>
          }
          @if (lastRefreshTime) {
            <div class="flex items-center gap-1.5 text-xs text-gray-600 ml-auto">
              <i class="pi pi-refresh text-green-600 text-xs"></i>
              <span>Last updated: {{ getFormattedRefreshTime() }}</span>
            </div>
          }
        </div>
      }
    </p-panel>
  </div>

<!-- Request Details Modal -->
<app-request-details
  [request]="selectedRequest"
  [isVisible]="isDetailsModalVisible"
  (close)="onCloseDetailsModal()"
  (approve)="onApproveFromModal($event)"
  (reject)="onRejectFromModal($event)">
</app-request-details>

  <!-- Error Message -->
  @if (errorMessage) {
    <p-message severity="error" styleClass="mb-3 w-full">
      <ng-template pTemplate>
        <div class="flex items-center justify-between w-full gap-2">
          <div class="flex-1">
            <h4 class="font-semibold text-sm m-0 mb-0.5">Error</h4>
            <p class="text-xs m-0">{{ errorMessage }}</p>
          </div>
          <p-button
            label="Retry"
            icon="pi pi-refresh"
            (onClick)="refreshRequests()"
            severity="danger"
            [text]="true"
            size="small">
          </p-button>
        </div>
      </ng-template>
    </p-message>
  }

  <!-- Filters Section -->
  <p-panel styleClass="mb-3">
    <ng-template pTemplate="header">
      <div class="flex items-center gap-2 p-2">
        <i class="pi pi-filter text-blue-600 text-sm"></i>
        <span class="font-semibold text-sm">Filters</span>
      </div>
    </ng-template>
    <div class="flex flex-col gap-2">
      <span class="p-input-icon-left w-full">
        <i class="pi pi-search text-sm"></i>
        <input
          type="text"
          pInputText
          placeholder="Search by Request ID, Engineer, Project Site, or Comments..."
          [(ngModel)]="searchTerm"
          (input)="onSearch()"
          class="w-full text-sm pl-8">
      </span>

      <div class="flex items-center gap-2 flex-wrap">
        <div class="flex items-center gap-2">
          <label for="statusFilter" class="text-xs text-gray-700">Status:</label>
          <p-dropdown
            [options]="statusOptions"
            [(ngModel)]="statusFilter"
            (onChange)="onStatusFilterChange()"
            placeholder="All Statuses"
            styleClass="w-44">
          </p-dropdown>
        </div>

        <p-button
          label="Clear Filters"
          icon="pi pi-filter-slash"
          (onClick)="clearFilters()"
          severity="secondary"
          [outlined]="true"
          size="small">
        </p-button>
      </div>
    </div>
  </p-panel>

  <!-- Table Section -->
  <p-table
    [value]="filteredRequests"
    [loading]="isLoading"
    styleClass="p-datatable-sm"
    responsiveLayout="scroll"
    [paginator]="true"
    [rows]="10"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} requests">

    <ng-template pTemplate="header">
      <tr class="bg-blue-600 text-white">
        <th class="text-xs uppercase py-2">Request ID</th>
        <th class="text-xs uppercase py-2">Engineer</th>
        <th class="text-xs uppercase py-2">Project Site</th>
        <th class="text-xs uppercase py-2">Expected Date</th>
        <th class="text-xs uppercase py-2">Request Date</th>
        <th class="text-xs uppercase py-2">Status</th>
        <th class="text-xs uppercase py-2">Priority</th>
        <th class="text-xs uppercase py-2">Type</th>
        <th class="text-xs uppercase py-2">Comments</th>
        <th class="text-xs uppercase py-2">Actions</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-request>
      <tr class="hover:bg-blue-50 transition-colors">
        <td class="py-2">
          <p-tag [value]="request.id.toString()" severity="info"></p-tag>
        </td>
        <td class="py-2">
          <div class="flex flex-col gap-0.5">
            <span class="font-semibold text-xs text-gray-800">{{ request.requestedByUser?.name || 'Unknown' }}</span>
            <span class="text-xs text-gray-500 italic">{{ request.requestedByUser?.email || '' }}</span>
          </div>
        </td>
        <td class="py-2">
          <div class="flex flex-col gap-0.5">
            <span class="font-semibold text-xs text-gray-800">{{ request.projectSite?.name || 'Unknown Site' }}</span>
            <span class="text-xs text-gray-500 italic">{{ request.projectSite?.project?.name || '' }}</span>
          </div>
        </td>
        <td class="py-2">
          <span class="text-xs font-medium text-gray-700">{{ formatDate(request.expectedUsageDate) }}</span>
        </td>
        <td class="py-2">
          <div class="flex flex-col gap-0.5">
            <span class="text-xs font-medium text-gray-700">{{ formatDate(request.createdAt) }}</span>
            @if (getProcessedByInfo(request)) {
              <span class="text-xs text-gray-500 italic">{{ getProcessedByInfo(request) }}</span>
            }
          </div>
        </td>
        <td class="py-2">
          <p-tag
            [value]="request.status"
            [severity]="getStatusSeverity(request.status)"
            [rounded]="true">
          </p-tag>
        </td>
        <td class="py-2">
          <p-tag
            [value]="request.priority"
            [severity]="getPrioritySeverity(request.priority)"
            [rounded]="true">
          </p-tag>
        </td>
        <td class="py-2">
          <p-tag
            [value]="request.approvalType"
            [severity]="getApprovalTypeSeverity(request.approvalType)"
            [rounded]="true">
          </p-tag>
        </td>
        <td class="py-2">
          <span class="text-xs text-gray-600" [pTooltip]="request.comments || 'No comments'">
            {{ request.comments ? (request.comments.length > 30 ? request.comments.substring(0, 30) + '...' : request.comments) : 'No comments' }}
          </span>
        </td>
        <td class="py-2">
          <div class="flex gap-0.5">
            <p-button
              icon="pi pi-eye"
              (onClick)="onViewDetails(request)"
              severity="info"
              [rounded]="true"
              [text]="true"
              size="small"
              pTooltip="View Details">
            </p-button>
            @if (request.status === 'Pending') {
              <p-button
                icon="pi pi-check"
                (onClick)="onApprove(request)"
                severity="success"
                [rounded]="true"
                [text]="true"
                size="small"
                pTooltip="Approve Request">
              </p-button>
              <p-button
                icon="pi pi-times"
                (onClick)="onReject(request)"
                severity="danger"
                [rounded]="true"
                [text]="true"
                size="small"
                pTooltip="Reject Request">
              </p-button>
            }
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="10" class="text-center py-8">
          <div class="flex flex-col items-center gap-2">
            <i class="pi pi-inbox text-4xl text-gray-300"></i>
            <h4 class="text-gray-700 m-0 font-semibold text-sm">No Requests Found</h4>
            <p class="text-gray-600 m-0 text-xs">No blasting engineer requests match your current filters.</p>
            @if (searchTerm || statusFilter !== 'ALL') {
              <p-button
                label="Clear Filters"
                icon="pi pi-filter-slash"
                (onClick)="clearFilters()"
                severity="secondary"
                size="small">
              </p-button>
            }
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Summary Section -->
  @if (!isLoading && filteredRequests.length > 0) {
    <p-panel styleClass="mt-3">
      <ng-template pTemplate="header">
        <div class="flex items-center gap-2 p-2">
          <i class="pi pi-chart-bar text-blue-600 text-sm"></i>
          <span class="font-semibold text-sm">Summary Statistics</span>
        </div>
      </ng-template>
      <div class="flex flex-wrap gap-4">
        <div class="flex flex-col gap-0.5">
          <span class="text-xs text-gray-600 font-medium">Total Requests:</span>
          <span class="text-lg font-bold text-gray-800">{{ getTotalRequestsCount() }}</span>
        </div>
        <div class="flex flex-col gap-0.5">
          <span class="text-xs text-gray-600 font-medium">Pending:</span>
          <span class="text-lg font-bold text-yellow-600">{{ getPendingCount() }}</span>
        </div>
        <div class="flex flex-col gap-0.5">
          <span class="text-xs text-gray-600 font-medium">Approved:</span>
          <span class="text-lg font-bold text-green-600">{{ getApprovedCount() }}</span>
        </div>
        <div class="flex flex-col gap-0.5">
          <span class="text-xs text-gray-600 font-medium">Rejected:</span>
          <span class="text-lg font-bold text-red-600">{{ getRejectedCount() }}</span>
        </div>
      </div>
    </p-panel>
  }
</div>