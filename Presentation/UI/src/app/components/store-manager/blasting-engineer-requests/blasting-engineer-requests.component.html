<div class="blasting-requests-container">
  <!-- Header Section -->
  <div class="header-section">
    <div class="page-title-section">
      <h2 class="page-title">
        <i class="material-icons">engineering</i>
        Blasting Engineer Requests
      </h2>
      <p class="page-subtitle">Manage explosive material requests from blasting engineers in your region</p>
      @if (currentUserRegion) {
        <div class="region-info">
          <i class="material-icons">location_on</i>
          <span>Region: {{ currentUserRegion }}</span>
        </div>
      }
    </div>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="refreshRequests()" [disabled]="isLoading">
        <i class="material-icons">refresh</i>
        Refresh
      </button>
    </div>
  </div>

  <!-- Error Message -->
  @if (errorMessage) {
    <div class="error-message">
      <i class="material-icons">error</i>
      <span>{{ errorMessage }}</span>
      <button class="btn btn-sm btn-secondary" (click)="refreshRequests()">
        <i class="material-icons">refresh</i>
        Retry
      </button>
    </div>
  }

  <!-- Filters Section -->
  <div class="filters-section">
    <div class="search-container">
      <div class="search-box">
        <i class="material-icons">search</i>
        <input 
          type="text" 
          placeholder="Search by Request ID, Engineer, Project Site, or Comments..." 
          [(ngModel)]="searchTerm"
          (input)="onSearch()"
          class="search-input">
        @if (searchTerm) {
          <button class="clear-search" (click)="searchTerm = ''; onSearch()" title="Clear search">
            <i class="material-icons">clear</i>
          </button>
        }
      </div>
    </div>
    
    <div class="filter-controls">
      <div class="filter-group">
        <label for="statusFilter">Status:</label>
        <select 
          id="statusFilter" 
          [(ngModel)]="statusFilter" 
          (change)="onStatusFilterChange()"
          class="filter-select">
          <option value="ALL">All Statuses</option>
          <option value="Pending">Pending</option>
          <option value="Approved">Approved</option>
          <option value="Rejected">Rejected</option>
          <option value="Cancelled">Cancelled</option>
          <option value="Expired">Expired</option>
        </select>
      </div>
      
      <button class="btn btn-secondary" (click)="clearFilters()" title="Clear all filters">
        <i class="material-icons">filter_list_off</i>
        Clear Filters
      </button>
    </div>
  </div>

  <!-- Table Section -->
  <div class="table-section">
    @if (isLoading) {
      <div class="loading-container">
        <div class="loading-spinner"></div>
        <p>Loading requests...</p>
      </div>
    } @else {
      <div class="table-container">
        <table class="requests-table">
          <thead>
            <tr>
              <th>Request ID</th>
              <th>Engineer</th>
              <th>Project Site</th>
              <th>Expected Date</th>
              <th>Request Date</th>
              <th>Status</th>
              <th>Priority</th>
              <th>Type</th>
              <th>Comments</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (request of filteredRequests; track request.id) {
              <tr class="request-row">
                <td class="request-id">
                  <span class="id-badge">{{ request.id }}</span>
                </td>
                <td class="engineer-info">
                  <div class="engineer-details">
                    <span class="engineer-name">{{ request.requestedByUser?.name || 'Unknown' }}</span>
                    <span class="engineer-email">{{ request.requestedByUser?.email || '' }}</span>
                  </div>
                </td>
                <td class="project-site">
                  <div class="site-info">
                    <span class="site-name">{{ request.projectSite?.name || 'Unknown Site' }}</span>
                    <span class="project-name">{{ request.projectSite?.project?.name || '' }}</span>
                  </div>
                </td>
                <td class="expected-date">{{ formatDate(request.expectedUsageDate) }}</td>
                <td class="request-date">{{ formatDate(request.createdAt) }}</td>
                <td class="status">
                  <span class="status-badge" [class]="getStatusClass(request.status)">
                    {{ request.status }}
                  </span>
                </td>
                <td class="priority">
                  <span class="priority-badge" [class]="'priority-' + request.priority.toLowerCase()">
                    {{ request.priority }}
                  </span>
                </td>
                <td class="approval-type">
                  <span class="type-badge" [class]="'type-' + request.approvalType.toLowerCase()">
                    {{ request.approvalType }}
                  </span>
                </td>
                <td class="comments">
                  <span class="comments-text" [title]="request.comments || 'No comments'">
                    {{ request.comments ? (request.comments.length > 30 ? request.comments.substring(0, 30) + '...' : request.comments) : 'No comments' }}
                  </span>
                </td>
                <td class="actions">
                  <div class="action-buttons">
                    <button 
                      class="btn btn-sm btn-info" 
                      (click)="onViewDetails(request)"
                      title="View Details">
                      <i class="material-icons">visibility</i>
                    </button>
                    @if (request.status === 'Pending') {
                      <button 
                        class="btn btn-sm btn-success" 
                        (click)="onApprove(request)"
                        title="Approve Request">
                        <i class="material-icons">check</i>
                      </button>
                      <button 
                        class="btn btn-sm btn-danger" 
                        (click)="onReject(request)"
                        title="Reject Request">
                        <i class="material-icons">close</i>
                      </button>
                    }
                  </div>
                </td>
              </tr>
            } @empty {
              <tr>
                <td colspan="10" class="no-data">
                  <div class="empty-state">
                    <i class="material-icons">inbox</i>
                    <h4>No Requests Found</h4>
                    <p>No blasting engineer requests match your current filters.</p>
                    @if (searchTerm || statusFilter !== 'ALL') {
                      <button class="btn btn-secondary" (click)="clearFilters()">
                        <i class="material-icons">filter_list_off</i>
                        Clear Filters
                      </button>
                    }
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>

  <!-- Summary Section -->
  @if (!isLoading && filteredRequests.length > 0) {
    <div class="summary-section">
      <div class="summary-stats">
        <div class="stat-item">
          <span class="stat-label">Total Requests:</span>
          <span class="stat-value">{{ filteredRequests.length }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Pending:</span>
          <span class="stat-value pending">{{ getPendingCount() }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Approved:</span>
          <span class="stat-value approved">{{ getApprovedCount() }}</span>
        </div>
      </div>
    </div>
  }
</div>