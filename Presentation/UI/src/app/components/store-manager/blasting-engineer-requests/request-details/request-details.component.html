<!-- Modal Backdrop -->
<div *ngIf="isVisible" class="fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-4" (click)="onBackdropClick($event)">

  <!-- Modal Dialog -->
  <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] flex flex-col" (click)="$event.stopPropagation()">

    <!-- Modal Header -->
    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-indigo-600 to-purple-600">
      <div class="flex items-center gap-3">
        <i class="pi pi-file-edit text-2xl text-white"></i>
        <h2 class="text-xl font-bold text-white m-0">Request Details</h2>
        @if (request) {
          <span class="px-3 py-1 bg-blue-500 text-white text-sm font-semibold rounded-full">
            ID: {{ request.id }}
          </span>
        }
      </div>
      <button
        (click)="onClose()"
        class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition-colors"
        aria-label="Close">
        <i class="pi pi-times text-xl"></i>
      </button>
    </div>

    <!-- Modal Body -->
    <div *ngIf="request" class="overflow-y-auto px-6 py-4 flex-1">
      <div class="space-y-4">

        <!-- Status Section -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
          <button
            (click)="toggleSection('status')"
            class="w-full flex items-center justify-between px-4 py-3 bg-gray-50 hover:bg-gray-100 transition-colors rounded-t-lg">
            <div class="flex items-center gap-2">
              <i class="pi pi-info-circle text-indigo-600"></i>
              <span class="font-semibold text-gray-800">Status</span>
            </div>
            <i class="pi" [ngClass]="expandedSections['status'] ? 'pi-chevron-up' : 'pi-chevron-down'" class="text-gray-600"></i>
          </button>
          <div *ngIf="expandedSections['status']" class="p-4 border-t border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="flex flex-col gap-1">
                <label class="text-sm font-semibold text-gray-600">Current Status:</label>
                <span class="px-3 py-1.5 inline-flex items-center justify-center w-fit rounded-full text-sm font-semibold"
                      [ngClass]="getStatusClasses(request.status)">
                  {{ request.status }}
                </span>
              </div>
              <div class="flex flex-col gap-1">
                <label class="text-sm font-semibold text-gray-600">Priority:</label>
                <span class="px-3 py-1.5 inline-flex items-center justify-center w-fit rounded-full text-sm font-semibold"
                      [ngClass]="getPriorityClasses(request.priority)">
                  {{ request.priority }}
                </span>
              </div>
              <div class="flex flex-col gap-1">
                <label class="text-sm font-semibold text-gray-600">Approval Type:</label>
                <span class="px-3 py-1.5 inline-flex items-center justify-center w-fit rounded-full text-sm font-semibold"
                      [ngClass]="getApprovalTypeClasses(request.approvalType)">
                  {{ request.approvalType }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Request Information Section -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
          <button
            (click)="toggleSection('requestInfo')"
            class="w-full flex items-center justify-between px-4 py-3 bg-gray-50 hover:bg-gray-100 transition-colors rounded-t-lg">
            <div class="flex items-center gap-2">
              <i class="pi pi-calendar text-indigo-600"></i>
              <span class="font-semibold text-gray-800">Request Information</span>
            </div>
            <i class="pi" [ngClass]="expandedSections['requestInfo'] ? 'pi-chevron-up' : 'pi-chevron-down'" class="text-gray-600"></i>
          </button>
          <div *ngIf="expandedSections['requestInfo']" class="p-4 border-t border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="flex flex-col gap-1">
                <label class="text-sm font-semibold text-gray-600">Expected Usage Date:</label>
                <span class="text-base text-gray-800">{{ formatDate(request.expectedUsageDate) }}</span>
              </div>
              <div class="flex flex-col gap-1" *ngIf="request.estimatedDurationHours">
                <label class="text-sm font-semibold text-gray-600">Estimated Duration:</label>
                <span class="text-base text-gray-800">{{ formatDuration(request.estimatedDurationHours) }}</span>
              </div>
              <div class="flex flex-col gap-1">
                <label class="text-sm font-semibold text-gray-600">Created At:</label>
                <span class="text-base text-gray-800">{{ formatDateTime(request.createdAt) }}</span>
              </div>
              <div class="flex flex-col gap-1" *ngIf="request.updatedAt">
                <label class="text-sm font-semibold text-gray-600">Last Updated:</label>
                <span class="text-base text-gray-800">{{ formatDateTime(request.updatedAt) }}</span>
              </div>
              <div class="flex flex-col gap-1 md:col-span-2" *ngIf="request.comments">
                <label class="text-sm font-semibold text-gray-600">Comments:</label>
                <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                  <p class="m-0 text-sm text-gray-800">{{ request.comments }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Requester Information Section -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
          <button
            (click)="toggleSection('requester')"
            class="w-full flex items-center justify-between px-4 py-3 bg-gray-50 hover:bg-gray-100 transition-colors rounded-t-lg">
            <div class="flex items-center gap-2">
              <i class="pi pi-user text-indigo-600"></i>
              <span class="font-semibold text-gray-800">Requester Information</span>
            </div>
            <i class="pi" [ngClass]="expandedSections['requester'] ? 'pi-chevron-up' : 'pi-chevron-down'" class="text-gray-600"></i>
          </button>
          <div *ngIf="expandedSections['requester']" class="p-4 border-t border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="flex flex-col gap-1">
                <label class="text-sm font-semibold text-gray-600">Name:</label>
                <span class="text-base text-gray-800">{{ request.requestedByUser?.name || 'N/A' }}</span>
              </div>
              <div class="flex flex-col gap-1">
                <label class="text-sm font-semibold text-gray-600">Email:</label>
                <span class="text-base text-gray-800">{{ request.requestedByUser?.email || 'N/A' }}</span>
              </div>
              <div class="flex flex-col gap-1">
                <label class="text-sm font-semibold text-gray-600">User ID:</label>
                <span class="text-base text-gray-800">{{ request.requestedByUserId }}</span>
              </div>
              <div class="flex flex-col gap-1">
                <label class="text-sm font-semibold text-gray-600">Region:</label>
                <span class="text-base text-gray-800">{{ request.requestedByUser?.region || 'N/A' }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Project & Site Information Section -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
          <button
            (click)="toggleSection('project')"
            class="w-full flex items-center justify-between px-4 py-3 bg-gray-50 hover:bg-gray-100 transition-colors rounded-t-lg">
            <div class="flex items-center gap-2">
              <i class="pi pi-map-marker text-indigo-600"></i>
              <span class="font-semibold text-gray-800">Project & Site Information</span>
            </div>
            <i class="pi" [ngClass]="expandedSections['project'] ? 'pi-chevron-up' : 'pi-chevron-down'" class="text-gray-600"></i>
          </button>
          <div *ngIf="expandedSections['project']" class="p-4 border-t border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="flex flex-col gap-1">
                <label class="text-sm font-semibold text-gray-600">Project Site:</label>
                <span class="text-base text-gray-800">{{ request.projectSite?.name || 'N/A' }}</span>
              </div>
              <div class="flex flex-col gap-1">
                <label class="text-sm font-semibold text-gray-600">Site ID:</label>
                <span class="text-base text-gray-800">{{ request.projectSiteId }}</span>
              </div>
              <div class="flex flex-col gap-1">
                <label class="text-sm font-semibold text-gray-600">Project Name:</label>
                <span class="text-base text-gray-800">{{ request.projectSite?.project?.name || 'Unknown Project' }}</span>
              </div>
              <div class="flex flex-col gap-1">
                <label class="text-sm font-semibold text-gray-600">Project ID:</label>
                <span class="text-base text-gray-800">{{ request.projectSite?.project?.id || 'N/A' }}</span>
              </div>
              <div class="flex flex-col gap-1">
                <label class="text-sm font-semibold text-gray-600">Project Region:</label>
                <span class="text-base text-gray-800">{{ request.projectSite?.project?.region || 'N/A' }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Explosive Calculations Section -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
          <button
            (click)="toggleSection('calculations')"
            class="w-full flex items-center justify-between px-4 py-3 bg-gray-50 hover:bg-gray-100 transition-colors rounded-t-lg">
            <div class="flex items-center gap-2">
              <i class="pi pi-calculator text-indigo-600"></i>
              <span class="font-semibold text-gray-800">Explosive Calculations</span>
            </div>
            <i class="pi" [ngClass]="expandedSections['calculations'] ? 'pi-chevron-up' : 'pi-chevron-down'" class="text-gray-600"></i>
          </button>
          <div *ngIf="expandedSections['calculations']" class="p-4 border-t border-gray-200">
            @if (isLoadingCalculations) {
              <div class="flex items-center justify-center py-8">
                <i class="pi pi-spin pi-spinner text-3xl text-indigo-600"></i>
                <span class="ml-3 text-gray-600">Loading calculations...</span>
              </div>
            } @else {
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="flex flex-col gap-1">
                  <label class="text-sm font-semibold text-gray-600">Total ANFO:</label>
                  <span class="text-2xl font-bold text-indigo-600">{{ totalAnfo | number:'1.2-2' }} kg</span>
                </div>
                <div class="flex flex-col gap-1">
                  <label class="text-sm font-semibold text-gray-600">Total Emulsion:</label>
                  <span class="text-2xl font-bold text-purple-600">{{ totalEmulsion | number:'1.2-2' }} kg</span>
                </div>
              </div>

              @if (explosiveCalculations.length > 0) {
                <div class="mt-4">
                  <h4 class="text-sm font-semibold text-gray-700 mb-2">Calculation Details:</h4>
                  <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                      <thead class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
                        <tr>
                          <th class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wider">Calculation ID</th>
                          <th class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wider">ANFO (kg)</th>
                          <th class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wider">Emulsion (kg)</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-gray-200">
                        <tr *ngFor="let calc of explosiveCalculations" class="hover:bg-indigo-50 transition-colors">
                          <td class="px-4 py-2 text-sm text-gray-800">{{ calc.id }}</td>
                          <td class="px-4 py-2 text-sm font-semibold text-gray-800">{{ calc.totalAnfo | number:'1.2-2' }}</td>
                          <td class="px-4 py-2 text-sm font-semibold text-gray-800">{{ calc.totalEmulsion | number:'1.2-2' }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              }
            }
          </div>
        </div>

        <!-- Blasting Schedule Section -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
          <button
            (click)="toggleSection('schedule')"
            class="w-full flex items-center justify-between px-4 py-3 bg-gray-50 hover:bg-gray-100 transition-colors rounded-t-lg">
            <div class="flex items-center gap-2">
              <i class="pi pi-clock text-indigo-600"></i>
              <span class="font-semibold text-gray-800">Blasting Schedule</span>
            </div>
            <i class="pi" [ngClass]="expandedSections['schedule'] ? 'pi-chevron-up' : 'pi-chevron-down'" class="text-gray-600"></i>
          </button>
          <div *ngIf="expandedSections['schedule']" class="p-4 border-t border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Blasting Date -->
              <div class="flex flex-col gap-1">
                <label class="text-sm font-semibold text-gray-600">Blasting Date:</label>
                @if (request.blastingDate) {
                  <div class="flex items-center gap-2">
                    <i class="pi pi-check-circle text-green-600"></i>
                    <span class="text-base text-gray-800">{{ formatDate(request.blastingDate) }}</span>
                  </div>
                } @else {
                  <div class="flex items-center gap-2">
                    <i class="pi pi-exclamation-triangle text-amber-500"></i>
                    <span class="text-base text-amber-600 font-semibold">Not Specified</span>
                  </div>
                }
              </div>

              <!-- Blast Timing -->
              <div class="flex flex-col gap-1">
                <label class="text-sm font-semibold text-gray-600">Blast Timing:</label>
                @if (request.blastTiming) {
                  <div class="flex items-center gap-2">
                    <i class="pi pi-check-circle text-green-600"></i>
                    <span class="text-base text-gray-800">{{ request.blastTiming }}</span>
                  </div>
                } @else {
                  <div class="flex items-center gap-2">
                    <i class="pi pi-exclamation-triangle text-amber-500"></i>
                    <span class="text-base text-amber-600 font-semibold">Not Specified</span>
                  </div>
                }
              </div>
            </div>

            <!-- Information Note when timing is missing -->
            @if (!request.blastingDate || !request.blastTiming) {
              <div class="mt-4 p-3 bg-amber-50 rounded-lg border border-amber-200">
                <div class="flex items-start gap-2">
                  <i class="pi pi-info-circle text-amber-600 mt-0.5"></i>
                  <div>
                    <p class="m-0 text-sm text-amber-800 font-semibold">Timing Information Required for Approval</p>
                    <p class="m-0 mt-1 text-xs text-amber-700">The Blasting Engineer needs to specify both the blasting date and timing before this request can be approved.</p>
                  </div>
                </div>
              </div>
            }
          </div>
        </div>

        <!-- Processing Information Section -->
        <div *ngIf="request.processedByUserId || request.processedAt || request.rejectionReason" class="bg-white border border-gray-200 rounded-lg shadow-sm">
          <button
            (click)="toggleSection('processing')"
            class="w-full flex items-center justify-between px-4 py-3 bg-gray-50 hover:bg-gray-100 transition-colors rounded-t-lg">
            <div class="flex items-center gap-2">
              <i class="pi pi-verified text-indigo-600"></i>
              <span class="font-semibold text-gray-800">Processing Information</span>
            </div>
            <i class="pi" [ngClass]="expandedSections['processing'] ? 'pi-chevron-up' : 'pi-chevron-down'" class="text-gray-600"></i>
          </button>
          <div *ngIf="expandedSections['processing']" class="p-4 border-t border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="flex flex-col gap-1" *ngIf="request.processedByUser?.name">
                <label class="text-sm font-semibold text-gray-600">Processed By:</label>
                <span class="text-base text-gray-800">{{ request.processedByUser?.name }}</span>
              </div>
              <div class="flex flex-col gap-1" *ngIf="request.processedByUser?.email">
                <label class="text-sm font-semibold text-gray-600">Processor Email:</label>
                <span class="text-base text-gray-800">{{ request.processedByUser?.email }}</span>
              </div>
              <div class="flex flex-col gap-1" *ngIf="request.processedAt">
                <label class="text-sm font-semibold text-gray-600">Processed At:</label>
                <span class="text-base text-gray-800">{{ formatDateTime(request.processedAt) }}</span>
              </div>
              <div class="flex flex-col gap-1 md:col-span-2" *ngIf="request.rejectionReason">
                <label class="text-sm font-semibold text-gray-600">Rejection Reason:</label>
                <div class="p-3 bg-red-50 rounded-lg border border-red-200">
                  <p class="m-0 text-sm text-red-800">{{ request.rejectionReason }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Additional Data Section -->
        <div *ngIf="request.additionalData" class="bg-white border border-gray-200 rounded-lg shadow-sm">
          <button
            (click)="toggleSection('additional')"
            class="w-full flex items-center justify-between px-4 py-3 bg-gray-50 hover:bg-gray-100 transition-colors rounded-t-lg">
            <div class="flex items-center gap-2">
              <i class="pi pi-database text-indigo-600"></i>
              <span class="font-semibold text-gray-800">Additional Data</span>
            </div>
            <i class="pi" [ngClass]="expandedSections['additional'] ? 'pi-chevron-up' : 'pi-chevron-down'" class="text-gray-600"></i>
          </button>
          <div *ngIf="expandedSections['additional']" class="p-4 border-t border-gray-200">
            <pre class="p-3 bg-gray-50 rounded-lg border border-gray-200 text-xs overflow-x-auto">{{ request.additionalData }}</pre>
          </div>
        </div>

      </div>
    </div>

    <!-- Modal Footer -->
    <div class="px-6 py-4 border-t border-gray-200 bg-gray-50">
      <div class="flex flex-col gap-3 w-full">

        <!-- Approval Requirements Message (shown when approval is blocked) -->
        @if (request?.status === 'Pending' && !canApprove()) {
          <div class="p-3 bg-amber-50 rounded-lg border border-amber-300">
            <div class="flex items-start gap-2">
              <i class="pi pi-exclamation-triangle text-amber-600 mt-0.5"></i>
              <div>
                <p class="m-0 text-sm font-semibold text-amber-800">Cannot Approve Request</p>
                <p class="m-0 mt-1 text-xs text-amber-700">{{ getApprovalBlockedMessage() }}</p>
              </div>
            </div>
          </div>
        }

        <!-- Action Buttons -->
        <div class="flex justify-between items-center w-full">
          <button
            (click)="onClose()"
            class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors flex items-center gap-2">
            <i class="pi pi-times"></i>
            <span>Close</span>
          </button>

          <div class="flex gap-2" *ngIf="request?.status === 'Pending'">
            <button
              (click)="onReject()"
              class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors flex items-center gap-2">
              <i class="pi pi-times-circle"></i>
              <span>Reject</span>
            </button>
            <button
              (click)="onApprove()"
              [disabled]="!canApprove()"
              [title]="!canApprove() ? getApprovalBlockedMessage() : 'Approve this request'"
              class="px-4 py-2 font-semibold rounded-lg transition-colors flex items-center gap-2"
              [ngClass]="canApprove() ? 'bg-green-600 hover:bg-green-700 text-white cursor-pointer' : 'bg-gray-300 text-gray-500 cursor-not-allowed'">
              <i class="pi pi-check-circle"></i>
              <span>Approve</span>
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
