<p-dialog
  [(visible)]="isVisible"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{width: '90vw', maxWidth: '1200px', maxHeight: '90vh'}"
  styleClass="request-details-dialog"
  (onHide)="onClose()">

  <ng-template pTemplate="header">
    <div class="flex items-center gap-3">
      <i class="pi pi-file-edit text-2xl text-indigo-600"></i>
      <h2 class="text-xl font-bold text-gray-800 m-0">Request Details</h2>
      @if (request) {
        <p-tag [value]="'ID: ' + request.id" severity="info" [rounded]="true"></p-tag>
      }
    </div>
  </ng-template>

  <div *ngIf="request" class="space-y-4">

    <!-- Status Section -->
    <p-panel header="Status" [toggleable]="true" styleClass="shadow-sm">
      <ng-template pTemplate="header">
        <div class="flex items-center gap-2">
          <i class="pi pi-info-circle text-indigo-600"></i>
          <span class="font-semibold">Status</span>
        </div>
      </ng-template>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-3">
        <div class="flex flex-col gap-1">
          <label class="text-sm font-semibold text-gray-600">Current Status:</label>
          <p-tag [value]="request.status" [severity]="getStatusSeverity(request.status)" [rounded]="true"></p-tag>
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-sm font-semibold text-gray-600">Priority:</label>
          <p-tag [value]="request.priority" [severity]="getPrioritySeverity(request.priority)" [rounded]="true"></p-tag>
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-sm font-semibold text-gray-600">Approval Type:</label>
          <p-tag [value]="request.approvalType" [severity]="getApprovalTypeSeverity(request.approvalType)" [rounded]="true"></p-tag>
        </div>
      </div>
    </p-panel>

    <!-- Request Information Section -->
    <p-panel header="Request Information" [toggleable]="true" styleClass="shadow-sm">
      <ng-template pTemplate="header">
        <div class="flex items-center gap-2">
          <i class="pi pi-calendar text-indigo-600"></i>
          <span class="font-semibold">Request Information</span>
        </div>
      </ng-template>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-3">
        <div class="flex flex-col gap-1">
          <label class="text-sm font-semibold text-gray-600">Expected Usage Date:</label>
          <span class="text-base text-gray-800">{{ formatDate(request.expectedUsageDate) }}</span>
        </div>
        <div class="flex flex-col gap-1" *ngIf="request.estimatedDurationHours">
          <label class="text-sm font-semibold text-gray-600">Estimated Duration:</label>
          <span class="text-base text-gray-800">{{ formatDuration(request.estimatedDurationHours) }}</span>
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-sm font-semibold text-gray-600">Created At:</label>
          <span class="text-base text-gray-800">{{ formatDateTime(request.createdAt) }}</span>
        </div>
        <div class="flex flex-col gap-1" *ngIf="request.updatedAt">
          <label class="text-sm font-semibold text-gray-600">Last Updated:</label>
          <span class="text-base text-gray-800">{{ formatDateTime(request.updatedAt) }}</span>
        </div>
        <div class="flex flex-col gap-1 md:col-span-2" *ngIf="request.comments">
          <label class="text-sm font-semibold text-gray-600">Comments:</label>
          <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
            <p class="m-0 text-sm text-gray-800">{{ request.comments }}</p>
          </div>
        </div>
      </div>
    </p-panel>

    <!-- Requester Information Section -->
    <p-panel header="Requester Information" [toggleable]="true" styleClass="shadow-sm">
      <ng-template pTemplate="header">
        <div class="flex items-center gap-2">
          <i class="pi pi-user text-indigo-600"></i>
          <span class="font-semibold">Requester Information</span>
        </div>
      </ng-template>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-3">
        <div class="flex flex-col gap-1">
          <label class="text-sm font-semibold text-gray-600">Name:</label>
          <span class="text-base text-gray-800">{{ request.requestedByUser?.name || 'N/A' }}</span>
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-sm font-semibold text-gray-600">Email:</label>
          <span class="text-base text-gray-800">{{ request.requestedByUser?.email || 'N/A' }}</span>
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-sm font-semibold text-gray-600">User ID:</label>
          <span class="text-base text-gray-800">{{ request.requestedByUserId }}</span>
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-sm font-semibold text-gray-600">Region:</label>
          <span class="text-base text-gray-800">{{ request.requestedByUser?.region || 'N/A' }}</span>
        </div>
      </div>
    </p-panel>

    <!-- Project & Site Information Section -->
    <p-panel header="Project & Site Information" [toggleable]="true" styleClass="shadow-sm">
      <ng-template pTemplate="header">
        <div class="flex items-center gap-2">
          <i class="pi pi-map-marker text-indigo-600"></i>
          <span class="font-semibold">Project & Site Information</span>
        </div>
      </ng-template>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-3">
        <div class="flex flex-col gap-1">
          <label class="text-sm font-semibold text-gray-600">Project Site:</label>
          <span class="text-base text-gray-800">{{ request.projectSite?.name || 'N/A' }}</span>
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-sm font-semibold text-gray-600">Site ID:</label>
          <span class="text-base text-gray-800">{{ request.projectSiteId }}</span>
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-sm font-semibold text-gray-600">Project Name:</label>
          <span class="text-base text-gray-800">{{ request.projectSite?.project?.name || 'Unknown Project' }}</span>
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-sm font-semibold text-gray-600">Project ID:</label>
          <span class="text-base text-gray-800">{{ request.projectSite?.project?.id || 'N/A' }}</span>
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-sm font-semibold text-gray-600">Project Region:</label>
          <span class="text-base text-gray-800">{{ request.projectSite?.project?.region || 'N/A' }}</span>
        </div>
      </div>
    </p-panel>

    <!-- Explosive Calculations Section -->
    <p-panel header="Explosive Calculations" [toggleable]="true" styleClass="shadow-sm">
      <ng-template pTemplate="header">
        <div class="flex items-center gap-2">
          <i class="pi pi-calculator text-indigo-600"></i>
          <span class="font-semibold">Explosive Calculations</span>
        </div>
      </ng-template>
      <div class="p-3">
        @if (isLoadingCalculations) {
          <div class="flex items-center justify-center py-8">
            <i class="pi pi-spin pi-spinner text-3xl text-indigo-600"></i>
            <span class="ml-3 text-gray-600">Loading calculations...</span>
          </div>
        } @else {
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="flex flex-col gap-1">
              <label class="text-sm font-semibold text-gray-600">Total ANFO:</label>
              <span class="text-2xl font-bold text-indigo-600">{{ totalAnfo | number:'1.2-2' }} kg</span>
            </div>
            <div class="flex flex-col gap-1">
              <label class="text-sm font-semibold text-gray-600">Total Emulsion:</label>
              <span class="text-2xl font-bold text-purple-600">{{ totalEmulsion | number:'1.2-2' }} kg</span>
            </div>
          </div>

          @if (explosiveCalculations.length > 0) {
            <div class="mt-4">
              <h4 class="text-sm font-semibold text-gray-700 mb-2">Calculation Details:</h4>
              <p-table [value]="explosiveCalculations" styleClass="p-datatable-sm">
                <ng-template pTemplate="header">
                  <tr>
                    <th class="text-xs">Calculation ID</th>
                    <th class="text-xs">ANFO (kg)</th>
                    <th class="text-xs">Emulsion (kg)</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-calc>
                  <tr>
                    <td class="text-xs">{{ calc.id }}</td>
                    <td class="text-xs font-semibold">{{ calc.totalAnfo | number:'1.2-2' }}</td>
                    <td class="text-xs font-semibold">{{ calc.totalEmulsion | number:'1.2-2' }}</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          }
        }
      </div>
    </p-panel>

    <!-- Blasting Schedule Section -->
    <p-panel header="Blasting Schedule" [toggleable]="true" styleClass="shadow-sm">
      <ng-template pTemplate="header">
        <div class="flex items-center gap-2">
          <i class="pi pi-clock text-indigo-600"></i>
          <span class="font-semibold">Blasting Schedule</span>
        </div>
      </ng-template>
      <div class="p-3">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Blasting Date -->
          <div class="flex flex-col gap-1">
            <label class="text-sm font-semibold text-gray-600">Blasting Date:</label>
            @if (request.blastingDate) {
              <div class="flex items-center gap-2">
                <i class="pi pi-check-circle text-green-600"></i>
                <span class="text-base text-gray-800">{{ formatDate(request.blastingDate) }}</span>
              </div>
            } @else {
              <div class="flex items-center gap-2">
                <i class="pi pi-exclamation-triangle text-amber-500"></i>
                <span class="text-base text-amber-600 font-semibold">Not Specified</span>
              </div>
            }
          </div>

          <!-- Blast Timing -->
          <div class="flex flex-col gap-1">
            <label class="text-sm font-semibold text-gray-600">Blast Timing:</label>
            @if (request.blastTiming) {
              <div class="flex items-center gap-2">
                <i class="pi pi-check-circle text-green-600"></i>
                <span class="text-base text-gray-800">{{ request.blastTiming }}</span>
              </div>
            } @else {
              <div class="flex items-center gap-2">
                <i class="pi pi-exclamation-triangle text-amber-500"></i>
                <span class="text-base text-amber-600 font-semibold">Not Specified</span>
              </div>
            }
          </div>
        </div>

        <!-- Information Note when timing is missing -->
        @if (!request.blastingDate || !request.blastTiming) {
          <div class="mt-4 p-3 bg-amber-50 rounded-lg border border-amber-200">
            <div class="flex items-start gap-2">
              <i class="pi pi-info-circle text-amber-600 mt-0.5"></i>
              <div>
                <p class="m-0 text-sm text-amber-800 font-semibold">Timing Information Required for Approval</p>
                <p class="m-0 mt-1 text-xs text-amber-700">The Blasting Engineer needs to specify both the blasting date and timing before this request can be approved.</p>
              </div>
            </div>
          </div>
        }
      </div>
    </p-panel>

    <!-- Processing Information Section -->
    <p-panel header="Processing Information" [toggleable]="true" styleClass="shadow-sm" *ngIf="request.processedByUserId || request.processedAt || request.rejectionReason">
      <ng-template pTemplate="header">
        <div class="flex items-center gap-2">
          <i class="pi pi-verified text-indigo-600"></i>
          <span class="font-semibold">Processing Information</span>
        </div>
      </ng-template>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-3">
        <div class="flex flex-col gap-1" *ngIf="request.processedByUser?.name">
          <label class="text-sm font-semibold text-gray-600">Processed By:</label>
          <span class="text-base text-gray-800">{{ request.processedByUser?.name }}</span>
        </div>
        <div class="flex flex-col gap-1" *ngIf="request.processedByUser?.email">
          <label class="text-sm font-semibold text-gray-600">Processor Email:</label>
          <span class="text-base text-gray-800">{{ request.processedByUser?.email }}</span>
        </div>
        <div class="flex flex-col gap-1" *ngIf="request.processedAt">
          <label class="text-sm font-semibold text-gray-600">Processed At:</label>
          <span class="text-base text-gray-800">{{ formatDateTime(request.processedAt) }}</span>
        </div>
        <div class="flex flex-col gap-1 md:col-span-2" *ngIf="request.rejectionReason">
          <label class="text-sm font-semibold text-gray-600">Rejection Reason:</label>
          <div class="p-3 bg-red-50 rounded-lg border border-red-200">
            <p class="m-0 text-sm text-red-800">{{ request.rejectionReason }}</p>
          </div>
        </div>
      </div>
    </p-panel>

    <!-- Additional Data Section -->
    <p-panel header="Additional Data" [toggleable]="true" [collapsed]="true" styleClass="shadow-sm" *ngIf="request.additionalData">
      <ng-template pTemplate="header">
        <div class="flex items-center gap-2">
          <i class="pi pi-database text-indigo-600"></i>
          <span class="font-semibold">Additional Data</span>
        </div>
      </ng-template>
      <div class="p-3">
        <pre class="p-3 bg-gray-50 rounded-lg border border-gray-200 text-xs overflow-x-auto">{{ request.additionalData }}</pre>
      </div>
    </p-panel>

  </div>

  <ng-template pTemplate="footer">
    <div class="flex flex-col gap-3 w-full">

      <!-- Approval Requirements Message (shown when approval is blocked) -->
      @if (request?.status === 'Pending' && !canApprove()) {
        <div class="p-3 bg-amber-50 rounded-lg border border-amber-300">
          <div class="flex items-start gap-2">
            <i class="pi pi-exclamation-triangle text-amber-600 mt-0.5"></i>
            <div>
              <p class="m-0 text-sm font-semibold text-amber-800">Cannot Approve Request</p>
              <p class="m-0 mt-1 text-xs text-amber-700">{{ getApprovalBlockedMessage() }}</p>
            </div>
          </div>
        </div>
      }

      <!-- Action Buttons -->
      <div class="flex justify-between items-center w-full">
        <p-button
          label="Close"
          icon="pi pi-times"
          (onClick)="onClose()"
          severity="secondary"></p-button>

        <div class="flex gap-2" *ngIf="request?.status === 'Pending'">
          <p-button
            label="Reject"
            icon="pi pi-times-circle"
            (onClick)="onReject()"
            severity="danger"></p-button>
          <p-button
            label="Approve"
            icon="pi pi-check-circle"
            (onClick)="onApprove()"
            [disabled]="!canApprove()"
            [pTooltip]="!canApprove() ? getApprovalBlockedMessage() : 'Approve this request'"
            tooltipPosition="top"
            severity="success"></p-button>
        </div>
      </div>
    </div>
  </ng-template>
</p-dialog>
