<div class="request-history-container">
  <!-- Header Section -->
  <div class="header-section">
    <div class="page-title-section">
      <h1 class="page-title">
        <i class="material-icons">history</i>
        Request History
      </h1>
      <p class="page-subtitle">View and manage your explosive stock request history</p>
    </div>
  </div>

  <!-- Alert Messages -->
  <div *ngIf="successMessage" class="alert alert-success">
    <i class="material-icons">check_circle</i>
    {{ successMessage }}
    <button class="btn-close" (click)="clearMessages()">
      <i class="material-icons">close</i>
    </button>
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger">
    <i class="material-icons">error</i>
    {{ errorMessage }}
    <button class="btn-close" (click)="clearMessages()">
      <i class="material-icons">close</i>
    </button>
  </div>

  <div class="content-layout">
    <!-- Main Content Card -->
    <div class="main-content-card">
      <!-- Filters Section -->
      <div class="filters-header" (click)="toggleFilters()" style="cursor: pointer;">
        <h3>
          <i class="material-icons">filter_list</i>
          Filter Requests
          <i class="material-icons toggle-icon" [class.rotated]="!isFiltersCollapsed">
            expand_more
          </i>
        </h3>
      </div>

      <div class="filters-content" [class.collapsed]="isFiltersCollapsed" *ngIf="!isFiltersCollapsed">
        <div class="form-section-group">
          <div class="filter-grid">
            <!-- Search Input with Icon -->
            <div class="form-group search-group">
              <label>
                <i class="material-icons">search</i>
                Search
              </label>
              <div class="search-input-wrapper">
                <i class="material-icons search-icon">search</i>
                <input 
                  type="text" 
                  class="form-control search-input"
                  [(ngModel)]="searchTerm"
                  (input)="applyFilters()"
                  placeholder="Search by ID, requester, or purpose...">
                <button 
                  *ngIf="searchTerm" 
                  class="clear-search-btn"
                  (click)="searchTerm = ''; applyFilters()"
                  type="button">
                  <i class="material-icons">close</i>
                </button>
              </div>
            </div>
            
            <!-- Status Filter -->
            <div class="form-group">
              <label>
                <i class="material-icons">assignment</i>
                Status
              </label>
              <select
                title="Filter by status"
                class="form-select"
                [(ngModel)]="filterStatus"
                (change)="applyFilters()">
                <option value="">All Statuses</option>
                <option value="PENDING">Pending</option>
                <option value="APPROVED">Approved</option>
                <option value="REJECTED">Rejected</option>
                <option value="DISPATCHED">Dispatched</option>
              </select>
            </div>
            
            <!-- Date From -->
            <div class="form-group">
              <label>
                <i class="material-icons">date_range</i>
                Date From
              </label>
              <input 
                type="date" 
                class="form-control"
                [(ngModel)]="filterDateFrom"
                (change)="applyFilters()"
                title="Filter from date">
            </div>
            
            <!-- Date To -->
            <div class="form-group">
              <label>
                <i class="material-icons">date_range</i>
                Date To
              </label>
              <input 
                type="date" 
                class="form-control"
                [(ngModel)]="filterDateTo"
                (change)="applyFilters()"
                title="Filter to date">
            </div>
            
            <!-- Clear Filters Button -->
            <div class="form-group clear-filters-group">
              <label>&nbsp;</label>
              <button 
                type="button" 
                class="btn btn-clear-filters"
                (click)="clearFilters()">
                <i class="material-icons">clear_all</i>
                Clear All Filters
              </button>
            </div>
          </div>
          
          <!-- Active Filters Display -->
          <div class="active-filters" *ngIf="hasActiveFilters()">
            <span class="active-filters-label">Active Filters:</span>
            <div class="filter-tags">
              <span class="filter-tag" *ngIf="searchTerm">
                <i class="material-icons">search</i>
                Search: "{{ searchTerm }}"
                <button (click)="searchTerm = ''; applyFilters()" class="remove-filter">
                  <i class="material-icons">close</i>
                </button>
              </span>
              <span class="filter-tag" *ngIf="filterStatus">
                <i class="material-icons">assignment</i>
                Status: {{ filterStatus }}
                <button (click)="filterStatus = ''; applyFilters()" class="remove-filter">
                  <i class="material-icons">close</i>
                </button>
              </span>
              <span class="filter-tag" *ngIf="filterDateFrom">
                <i class="material-icons">date_range</i>
                From: {{ filterDateFrom }}
                <button (click)="filterDateFrom = ''; applyFilters()" class="remove-filter">
                  <i class="material-icons">close</i>
                </button>
              </span>
              <span class="filter-tag" *ngIf="filterDateTo">
                <i class="material-icons">date_range</i>
                To: {{ filterDateTo }}
                <button (click)="filterDateTo = ''; applyFilters()" class="remove-filter">
                  <i class="material-icons">close</i>
                </button>
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Request History Section -->
      <div class="history-section">
        <div class="history-header">
          <h3>
            <i class="material-icons">list</i>
            Request History ({{ filteredRequests.length }} requests)
          </h3>
        </div>

        <div class="history-content">
          <!-- Loading State -->
          <div *ngIf="isLoading" class="loading-state">
            <div class="spinner"></div>
            <p>Loading request history...</p>
          </div>

          <!-- Empty State -->
          <div *ngIf="!isLoading && filteredRequests.length === 0" class="empty-state">
            <i class="material-icons">inbox</i>
            <h3>No requests found</h3>
            <p>No requests match your current filters. Try adjusting your search criteria.</p>
          </div>

          <!-- Requests Table -->
          <div *ngIf="!isLoading && filteredRequests.length > 0" class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Request Number</th>
                  <th>Request Date</th>
                  <th>Required Date</th>
                  <th>Status</th>
                  <th>Dispatch Status</th>
                  <th>Delivery Status</th>
                  <th>Explosive Type</th>
                  <th>Final Quantity</th>
                  <th>Notes</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <ng-container *ngFor="let request of filteredRequests">
                  <tr>
                    <td>
                      <strong>{{ request.requestNumber }}</strong>
                    </td>
                    <td>{{ formatDate(request.requestDate) }}</td>
                    <td>{{ formatDate(request.requiredByDate) }}</td>
                    <td>
                      <span class="badge" [class]="getStatusClass(request.status)">
                        {{ request.statusName }}
                      </span>
                    </td>
                    <td>
                      <span class="badge" [class]="request.dispatchDate ? 'badge-success' : 'badge-warning'">
                        {{ request.dispatchDate ? 'Dispatched' : 'Not Dispatched' }}
                      </span>
                      <div *ngIf="request.dispatchDate" class="text-muted small mt-1">
                        {{ formatDate(request.dispatchDate) }}
                      </div>
                    </td>
                    <td>
                      <span class="badge" [class]="request.deliveryConfirmedDate ? 'badge-success' : 'badge-secondary'">
                        {{ request.deliveryConfirmedDate ? 'Received' : 'Not Received' }}
                      </span>
                      <div *ngIf="request.deliveryConfirmedDate" class="text-muted small mt-1">
                        {{ formatDate(request.deliveryConfirmedDate) }}
                      </div>
                    </td>
                    <td>
                      {{ request.explosiveTypeName }}
                      <span class="text-muted">({{ request.requestedQuantity }} {{ request.unit }})</span>
                    </td>
                    <td>{{ request.finalQuantity }} {{ request.unit }}</td>
                    <td class="purpose-cell">{{ request.requestNotes || '-' }}</td>
                    <td>
                      <div class="action-buttons">
                        <button 
                          class="btn btn-sm btn-outline-primary"
                          (click)="openViewDetails(request)"
                          title="View Details">
                          <i class="material-icons">visibility</i>
                        </button>
                        <button
                          class="action-btn dispatch-btn"
                          (click)="openDispatchInfo(request)"
                          *ngIf="request.dispatchDate"
                          title="View Dispatch Information">
                          <mat-icon>local_shipping</mat-icon>
                        </button>
                        <button
                          *ngIf="request.status === TransferRequestStatus.Pending"
                          class="btn btn-sm btn-outline-warning"
                          title="Edit Request">
                          <i class="material-icons">edit</i>
                        </button>
                        <button
                          *ngIf="request.status === TransferRequestStatus.Pending"
                          class="btn btn-sm btn-outline-danger"
                          title="Cancel Request">
                          <i class="material-icons">cancel</i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </ng-container>
              </tbody>
            </table>
          </div>


        </div>
      </div>
    </div>
  </div>
</div>

<!-- View Details Modal -->
<app-view-details
  *ngIf="showViewDetails && selectedRequest"
  [request]="selectedRequest"
  (close)="closeViewDetails()">
</app-view-details>