<div class="request-history-container">
  <!-- Header Section -->
  <div class="header-section">
    <div class="page-title-section">
      <h1 class="page-title">
        <i class="material-icons">history</i>
        Request History
      </h1>
      <p class="page-subtitle">View and manage your explosive stock request history</p>
    </div>
  </div>

  <!-- Alert Messages -->
  <div *ngIf="successMessage" class="alert alert-success">
    <i class="material-icons">check_circle</i>
    {{ successMessage }}
    <button class="btn-close" (click)="clearMessages()">
      <i class="material-icons">close</i>
    </button>
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger">
    <i class="material-icons">error</i>
    {{ errorMessage }}
    <button class="btn-close" (click)="clearMessages()">
      <i class="material-icons">close</i>
    </button>
  </div>

  <div class="content-layout">
    <!-- Main Content Card -->
    <div class="main-content-card">
      <!-- Filters Section -->
      <div class="filters-header" (click)="toggleFilters()" style="cursor: pointer;">
        <h3>
          <i class="material-icons">filter_list</i>
          Filter Requests
          <i class="material-icons toggle-icon" [class.rotated]="!isFiltersCollapsed">
            expand_more
          </i>
        </h3>
      </div>

      <div class="filters-content" [class.collapsed]="isFiltersCollapsed" *ngIf="!isFiltersCollapsed">
        <div class="form-section-group">
          <div class="filter-grid">
            <!-- Search Input with Icon -->
            <div class="form-group search-group">
              <label>
                <i class="material-icons">search</i>
                Search
              </label>
              <div class="search-input-wrapper">
                <i class="material-icons search-icon">search</i>
                <input 
                  type="text" 
                  class="form-control search-input"
                  [(ngModel)]="searchTerm"
                  (input)="applyFilters()"
                  placeholder="Search by ID, requester, or purpose...">
                <button 
                  *ngIf="searchTerm" 
                  class="clear-search-btn"
                  (click)="searchTerm = ''; applyFilters()"
                  type="button">
                  <i class="material-icons">close</i>
                </button>
              </div>
            </div>
            
            <!-- Status Filter -->
            <div class="form-group">
              <label>
                <i class="material-icons">assignment</i>
                Status
              </label>
              <select
                title="Filter by status"
                class="form-select"
                [(ngModel)]="filterStatus"
                (change)="applyFilters()">
                <option value="">All Statuses</option>
                <option value="PENDING">Pending</option>
                <option value="APPROVED">Approved</option>
                <option value="REJECTED">Rejected</option>
                <option value="DISPATCHED">Dispatched</option>
              </select>
            </div>
            
            <!-- Explosive Type Filter -->
            <div class="form-group">
              <label>
                <i class="material-icons">science</i>
                Explosive Type
              </label>
              <select
                title="Filter by explosive type"
                class="form-select"
                [(ngModel)]="filterType"
                (change)="applyFilters()">
                <option value="">All Types</option>
                <option value="ANFO">ANFO</option>
                <option value="EMULSION">Emulsion</option>
                <option value="DYNAMITE">Dynamite</option>
                <option value="SLURRY">Slurry</option>
              </select>
            </div>
            
            <!-- Date From -->
            <div class="form-group">
              <label>
                <i class="material-icons">date_range</i>
                Date From
              </label>
              <input 
                type="date" 
                class="form-control"
                [(ngModel)]="filterDateFrom"
                (change)="applyFilters()"
                title="Filter from date">
            </div>
            
            <!-- Date To -->
            <div class="form-group">
              <label>
                <i class="material-icons">date_range</i>
                Date To
              </label>
              <input 
                type="date" 
                class="form-control"
                [(ngModel)]="filterDateTo"
                (change)="applyFilters()"
                title="Filter to date">
            </div>
            
            <!-- Clear Filters Button -->
            <div class="form-group clear-filters-group">
              <label>&nbsp;</label>
              <button 
                type="button" 
                class="btn btn-clear-filters"
                (click)="clearFilters()">
                <i class="material-icons">clear_all</i>
                Clear All Filters
              </button>
            </div>
          </div>
          
          <!-- Active Filters Display -->
          <div class="active-filters" *ngIf="hasActiveFilters()">
            <span class="active-filters-label">Active Filters:</span>
            <div class="filter-tags">
              <span class="filter-tag" *ngIf="searchTerm">
                <i class="material-icons">search</i>
                Search: "{{ searchTerm }}"
                <button (click)="searchTerm = ''; applyFilters()" class="remove-filter">
                  <i class="material-icons">close</i>
                </button>
              </span>
              <span class="filter-tag" *ngIf="filterStatus">
                <i class="material-icons">assignment</i>
                Status: {{ filterStatus }}
                <button (click)="filterStatus = ''; applyFilters()" class="remove-filter">
                  <i class="material-icons">close</i>
                </button>
              </span>
              <span class="filter-tag" *ngIf="filterType">
                <i class="material-icons">science</i>
                Type: {{ filterType }}
                <button (click)="filterType = ''; applyFilters()" class="remove-filter">
                  <i class="material-icons">close</i>
                </button>
              </span>
              <span class="filter-tag" *ngIf="filterDateFrom">
                <i class="material-icons">date_range</i>
                From: {{ filterDateFrom }}
                <button (click)="filterDateFrom = ''; applyFilters()" class="remove-filter">
                  <i class="material-icons">close</i>
                </button>
              </span>
              <span class="filter-tag" *ngIf="filterDateTo">
                <i class="material-icons">date_range</i>
                To: {{ filterDateTo }}
                <button (click)="filterDateTo = ''; applyFilters()" class="remove-filter">
                  <i class="material-icons">close</i>
                </button>
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Request History Section -->
      <div class="history-section">
        <div class="history-header">
          <h3>
            <i class="material-icons">list</i>
            Request History ({{ filteredRequests.length }} requests)
          </h3>
        </div>

        <div class="history-content">
          <!-- Loading State -->
          <div *ngIf="isLoading" class="loading-state">
            <div class="spinner"></div>
            <p>Loading request history...</p>
          </div>

          <!-- Empty State -->
          <div *ngIf="!isLoading && filteredRequests.length === 0" class="empty-state">
            <i class="material-icons">inbox</i>
            <h3>No requests found</h3>
            <p>No requests match your current filters. Try adjusting your search criteria.</p>
          </div>

          <!-- Requests Table -->
          <div *ngIf="!isLoading && filteredRequests.length > 0" class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th></th>
                  <th>Request ID</th>
                  <th>Date</th>
                  <th>Required Date</th>
                  <th>Status</th>
                  <th>Dispatched</th>
                  <th>Received</th>
                  <th>Requested Items</th>
                  <th>Items</th>
                  <th>Justification</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <ng-container *ngFor="let request of filteredRequests">
                  <tr>
                    <td>
                      <button class="btn btn-sm btn-outline-secondary" (click)="toggleExpanded(request.id)" [attr.aria-expanded]="isExpanded(request.id)">
                        <i class="material-icons">{{ isExpanded(request.id) ? 'expand_less' : 'expand_more' }}</i>
                      </button>
                    </td>
                    <td>
                      <strong>{{ request.id }}</strong>
                    </td>
                    <td>{{ formatDate(request.requestDate) }}</td>
                    <td>{{ formatDate(request.requiredDate) }}</td>
                    <td>
                      <span class="badge" [class]="getStatusClass(request.status)">
                        {{ request.status }}
                      </span>
                    </td>
                    <td>
                      <span class="badge" [class]="request.dispatched ? 'badge-success' : 'badge-warning'">
                        {{ request.dispatched ? 'Dispatched' : 'Not Dispatched' }}
                      </span>
                      <div *ngIf="request.dispatched && request.dispatchedDate" class="text-muted small mt-1">
                        {{ formatDate(request.dispatchedDate) }}
                      </div>
                    </td>
                    <td>
                      <span class="badge" [class]="request.fulfillmentDate ? 'badge-success' : 'badge-secondary'">
                        {{ request.fulfillmentDate ? 'Received' : 'Not Received' }}
                      </span>
                      <div *ngIf="request.fulfillmentDate" class="text-muted small mt-1">
                        {{ formatDate(request.fulfillmentDate) }}
                      </div>
                    </td>
                    <td>
                      <div *ngFor="let item of request.requestedItems; let i = index">
                        <small class="text-muted">{{ i + 1 }}.</small> {{ item.explosiveType }} 
                        <span class="text-muted">({{ item.requestedQuantity }} {{ item.unit }})</span>
                        <div *ngIf="request.requestedItems.length > 1" class="mt-1"></div>
                      </div>
                    </td>
                    <td>{{ request.requestedItems.length }} item(s)</td>
                    <td class="purpose-cell">{{ request.justification }}</td>
                    <td>
                      <div class="action-buttons">
                        <button 
                          class="btn btn-sm btn-outline-primary"
                          (click)="openViewDetails(request)"
                          title="View Details">
                          <i class="material-icons">visibility</i>
                        </button>
                        <button 
                          class="action-btn dispatch-btn" 
                          (click)="openDispatchInfo(request)"
                          *ngIf="request.dispatched"
                          title="View Dispatch Information">
                          <mat-icon>local_shipping</mat-icon>
                        </button>
                        <button 
                          *ngIf="request.status === StockRequestStatus.PENDING"
                          class="btn btn-sm btn-outline-warning"
                          title="Edit Request">
                          <i class="material-icons">edit</i>
                        </button>
                        <button 
                          *ngIf="request.status === StockRequestStatus.PENDING"
                          class="btn btn-sm btn-outline-danger"
                          title="Cancel Request">
                          <i class="material-icons">cancel</i>
                        </button>
                      </div>
                    </td>
                  </tr>
                  
                  <!-- Expanded row: nested items table -->
                  <tr *ngIf="isExpanded(request.id)">
                    <td colspan="11" class="nested-row">
                      <div class="nested-table-wrapper">
                        <table class="table table-sm table-bordered nested-table">
                          <thead>
                            <tr>
                              <th>#</th>
                              <th>Type</th>
                              <th>Quantity</th>
                              <th>Unit</th>
                              <th>Purpose</th>
                              <th>Specifications</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr *ngFor="let item of request.requestedItems; let idx = index">
                              <td>{{ idx + 1 }}</td>
                              <td>{{ item.explosiveType }}</td>
                              <td>{{ item.requestedQuantity }}</td>
                              <td>{{ item.unit }}</td>
                              <td>{{ item.purpose }}</td>
                              <td>{{ item.specifications || '-' }}</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </td>
                  </tr>
                </ng-container>
              </tbody>
            </table>
          </div>


        </div>
      </div>
    </div>
  </div>
</div>

<!-- View Details Modal -->
<app-view-details
  *ngIf="showViewDetails && selectedRequest"
  [request]="selectedRequest"
  (close)="closeViewDetails()">
</app-view-details>