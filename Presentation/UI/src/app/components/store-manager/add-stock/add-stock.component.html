<div class="add-stock-container">
  <!-- Header Section -->
  <div class="header-section">
    <div class="page-title-section">
      <h1 class="page-title">
        <i class="material-icons">add_shopping_cart</i>
        Request Stock from Central Warehouse
      </h1>
      <p class="page-subtitle">Submit a request to the explosive manager for additional explosive inventory</p>
    </div>
  </div>

  <!-- Alert Messages -->
  <div *ngIf="successMessage" class="alert alert-success">
    <i class="material-icons">check_circle</i>
    {{ successMessage }}
    <button type="button" class="btn-close" (click)="clearMessages()">
      <i class="material-icons">close</i>
    </button>
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger">
    <i class="material-icons">error</i>
    {{ errorMessage }}
    <button type="button" class="btn-close" (click)="clearMessages()">
      <i class="material-icons">close</i>
    </button>
  </div>

  <div class="content-layout">
    <!-- Main Form Section -->
    <div class="form-section">
      <div class="section-card">
        <div class="card-header">
          <h2>
            <i class="material-icons">description</i>
            New Transfer Request
          </h2>
        </div>

        <div class="card-body">
          <form [formGroup]="stockRequestForm" (ngSubmit)="onSubmit()">
            <!-- Request Information -->
            <div class="form-section-group">
              <h3 class="section-title">Request Information</h3>

              <div class="form-row">
                <div class="form-group">
                  <label for="requestDate">Request Date</label>
                  <input
                    type="text"
                    class="form-control"
                    id="requestDate"
                    [value]="getCurrentDateTime()"
                    readonly>
                  <small class="text-muted">Automatically generated</small>
                </div>

                <div class="form-group">
                  <label>Status</label>
                  <div>
                    <span class="badge bg-warning">PENDING</span>
                  </div>
                  <small class="text-muted">Will be updated after submission</small>
                </div>
              </div>
            </div>

            <!-- Requester Information -->
            <div class="form-section-group">
              <h3 class="section-title">Requester Information</h3>

              <div class="form-row">
                <div class="form-group">
                  <label for="requesterName">Store Manager</label>
                  <input
                    type="text"
                    class="form-control"
                    id="requesterName"
                    [value]="currentUser.name"
                    readonly>
                  <small class="text-muted">From user profile</small>
                </div>

                <div class="form-group">
                  <label for="requesterRole">Role</label>
                  <input
                    type="text"
                    class="form-control"
                    id="requesterRole"
                    [value]="currentUser.role"
                    readonly>
                  <small class="text-muted">From user profile</small>
                </div>

                <div class="form-group">
                  <label for="storeLocation">Destination Store</label>
                  <input
                    type="text"
                    class="form-control"
                    id="storeLocation"
                    [value]="currentStore.name"
                    readonly>
                  <small class="text-muted">From store assignment</small>
                </div>
              </div>
            </div>

            <!-- Explosive Details Section -->
            <div class="form-section-group">
              <h3 class="section-title">Select from Central Warehouse</h3>

              <div *ngIf="isLoadingInventory" class="alert alert-info">
                <i class="material-icons">hourglass_empty</i>
                Loading available inventory...
              </div>

              <div *ngIf="!isLoadingInventory && availableInventory.length === 0" class="alert alert-warning">
                <i class="material-icons">warning</i>
                No inventory available in central warehouse
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="explosiveType">Explosive Type *</label>
                  <select
                    class="form-select"
                    id="explosiveType"
                    formControlName="explosiveType"
                    (change)="onExplosiveTypeChange()"
                    [disabled]="isLoadingInventory"
                    [class.is-invalid]="isFieldInvalid(stockRequestForm, 'explosiveType')">
                    <option value="">Select explosive type</option>
                    <option *ngFor="let type of getExplosiveTypes()" [value]="type">
                      {{ getExplosiveTypeName(type) }}
                    </option>
                  </select>
                  <div *ngIf="isFieldInvalid(stockRequestForm, 'explosiveType')" class="error-message">
                    {{ getFieldError(stockRequestForm, 'explosiveType') }}
                  </div>
                </div>

                <div class="form-group flex-grow">
                  <label for="batchId">Available Batch *</label>
                  <select
                    class="form-select"
                    id="batchId"
                    formControlName="batchId"
                    (change)="onBatchChange()"
                    [disabled]="isLoadingInventory || filteredInventory.length === 0"
                    [class.is-invalid]="isFieldInvalid(stockRequestForm, 'batchId')">
                    <option value="">Select batch</option>
                    <option *ngFor="let batch of filteredInventory" [value]="batch.id">
                      {{ getBatchDisplayName(batch) }}
                    </option>
                  </select>
                  <small class="text-muted" *ngIf="!stockRequestForm.get('explosiveType')?.value">
                    Select explosive type first
                  </small>
                  <div *ngIf="isFieldInvalid(stockRequestForm, 'batchId')" class="error-message">
                    {{ getFieldError(stockRequestForm, 'batchId') }}
                  </div>
                </div>
              </div>

              <div *ngIf="selectedBatch" class="alert alert-info mt-3">
                <h4>Selected Batch Information:</h4>
                <p><strong>Batch ID:</strong> {{ selectedBatch.batchId }}</p>
                <p><strong>Available Quantity:</strong> {{ selectedBatch.availableQuantity }} {{ selectedBatch.unit }}</p>
                <p><strong>Manufacturing Date:</strong> {{ selectedBatch.manufacturingDate | date }}</p>
                <p><strong>Expiry Date:</strong> {{ selectedBatch.expiryDate | date }}</p>
                <p><strong>Supplier:</strong> {{ selectedBatch.supplier }}</p>
              </div>

              <div class="form-row mt-3">
                <div class="form-group">
                  <label for="requestedQuantity">Requested Quantity *</label>
                  <input
                    type="number"
                    class="form-control"
                    id="requestedQuantity"
                    formControlName="requestedQuantity"
                    [disabled]="!selectedBatch"
                    [max]="selectedBatch?.availableQuantity || 999999"
                    [class.is-invalid]="isFieldInvalid(stockRequestForm, 'requestedQuantity')"
                    placeholder="Enter quantity"
                    min="0.1"
                    step="0.1">
                  <small class="text-muted" *ngIf="selectedBatch">
                    Maximum: {{ selectedBatch.availableQuantity }} {{ selectedBatch.unit }}
                  </small>
                  <div *ngIf="isFieldInvalid(stockRequestForm, 'requestedQuantity')" class="error-message">
                    {{ getFieldError(stockRequestForm, 'requestedQuantity') }}
                  </div>
                </div>

                <div class="form-group">
                  <label for="unit">Unit *</label>
                  <input
                    type="text"
                    class="form-control"
                    id="unit"
                    formControlName="unit"
                    readonly>
                  <small class="text-muted">Unit from selected batch</small>
                </div>
              </div>
            </div>

            <!-- Request Details Section -->
            <div class="form-section-group">
              <h3 class="section-title">Request Details</h3>

              <div class="form-group">
                <label for="requiredDate">Required By Date</label>
                <input
                  type="date"
                  class="form-control"
                  id="requiredDate"
                  formControlName="requiredDate"
                  [class.is-invalid]="isFieldInvalid(stockRequestForm, 'requiredDate')">
                <small class="text-muted">When do you need this material?</small>
                <div *ngIf="isFieldInvalid(stockRequestForm, 'requiredDate')" class="error-message">
                  {{ getFieldError(stockRequestForm, 'requiredDate') }}
                </div>
              </div>
            </div>

            <!-- Notes Section -->
            <div class="form-section-group">
              <h3 class="section-title">Additional Notes</h3>

              <div class="form-group">
                <label for="notes">Additional Notes (Optional)</label>
                <textarea
                  class="form-control"
                  id="notes"
                  formControlName="notes"
                  placeholder="Any additional information or special requirements"
                  rows="3"></textarea>
                <small class="text-muted">Provide any additional information that may be relevant to this request</small>
              </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
              <button
                type="button"
                class="btn btn-secondary"
                (click)="resetForm()"
                [disabled]="isSubmitting">
                <i class="material-icons">refresh</i>
                Reset Form
              </button>

              <button
                type="submit"
                class="btn btn-primary"
                [disabled]="isSubmitting">
                <i class="material-icons">send</i>
                <span *ngIf="!isSubmitting">Submit Request</span>
                <span *ngIf="isSubmitting">Submitting...</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
