<div class="assignment-requests-container">
  <!-- Page Header -->
  <div class="requests-header">
    <h1>Assignment Requests</h1>
    <div class="header-actions">
      <button
        class="export-btn"
        (click)="exportRequests()"
        [disabled]="isLoading">
        <i class="material-icons">download</i>
        Export
      </button>
      <button
        class="refresh-btn"
        (click)="refreshRequests()"
        [disabled]="isLoading">
        <i class="material-icons">refresh</i>
        Refresh
      </button>
    </div>
  </div>

  <!-- Error Alert -->
  @if (error) {
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="material-icons">error</i>
      {{ error }}
      <button type="button" class="btn-close" (click)="error = null"></button>
    </div>
  }

  <!-- Statistics Grid -->
  <div class="stats-grid">
    <div class="stat-card pending">
      <div class="stat-icon">
        <i class="material-icons">pending_actions</i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.pending }}</h3>
        <p>Pending</p>
      </div>
    </div>

    <div class="stat-card approved">
      <div class="stat-icon">
        <i class="material-icons">check_circle</i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.approved }}</h3>
        <p>Approved</p>
      </div>
    </div>

    <div class="stat-card rejected">
      <div class="stat-icon">
        <i class="material-icons">cancel</i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.rejected }}</h3>
        <p>Rejected</p>
      </div>
    </div>

    <div class="stat-card total">
      <div class="stat-icon">
        <i class="material-icons">inventory_2</i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.total }}</h3>
        <p>Total Requests</p>
      </div>
    </div>
  </div>

  <!-- Search and Filter Section -->
  <div class="search-filter-section">
    <div class="search-box">
      <input
        type="text"
        class="form-control"
        placeholder="Search requests..."
        [(ngModel)]="searchQuery"
        (input)="applyAll()">
    </div>

    <div class="filter-section">
      <select
        class="form-select"
        [(ngModel)]="selectedStatus"
        (ngModelChange)="applyAll()">
        <option value="ALL">All Status</option>
        <option value="PENDING">Pending</option>
        <option value="APPROVED">Approved</option>
        <option value="REJECTED">Rejected</option>
      </select>

      <select
        class="form-select"
        [(ngModel)]="selectedUrgency"
        (ngModelChange)="applyAll()">
        <option value="ALL">All Urgency</option>
        <option value="LOW">Low</option>
        <option value="MEDIUM">Medium</option>
        <option value="HIGH">High</option>
        <option value="URGENT">Urgent</option>
      </select>

      <select
        class="form-select"
        [(ngModel)]="selectedMachineType"
        (ngModelChange)="applyAll()">
        <option value="ALL">All Types</option>
        <option value="EXCAVATOR">Excavator</option>
        <option value="BULLDOZER">Bulldozer</option>
        <option value="LOADER">Loader</option>
        <option value="DUMP_TRUCK">Dump Truck</option>
        <option value="DRILL_RIG">Drill Rig</option>
        <option value="CRANE">Crane</option>
      </select>
    </div>
  </div>

  <!-- Modern Table Section -->
  <div class="table-section">
    <div class="table-header">
      <div class="table-title">
        <i class="material-icons">view_list</i>
        <span>Requests List</span>
        <span class="request-count">{{ filteredRequests.length }}</span>
      </div>
    </div>

    <!-- Loading State -->
    @if (isLoading) {
      <div class="loading-state">
        <div class="loader-spinner"></div>
        <p>Loading assignment requests...</p>
      </div>
    }

    <!-- Empty State -->
    @if (!isLoading && filteredRequests.length === 0) {
      <div class="empty-state">
        <div class="empty-icon">
          <i class="material-icons">inbox</i>
        </div>
        <h3>No Requests Found</h3>
        <p>There are no assignment requests matching your current filters.</p>
        <button class="empty-action-btn" (click)="clearFilters()" type="button">
          Clear Filters
        </button>
      </div>
    }

    <!-- Modern Table -->
    @if (!isLoading && filteredRequests.length > 0) {
      <div class="requests-table-wrapper">
        <p-table
          [value]="filteredRequests"
          styleClass="modern-table"
          responsiveLayout="scroll"
          [paginator]="true"
          [rows]="10"
          [rowsPerPageOptions]="[10, 25, 50]"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Showing {first} to {last} of {totalRecords}"
          [sortField]="sortBy"
          [sortOrder]="sortDirection === 'asc' ? 1 : -1">

          <ng-template pTemplate="header">
            <tr>
              <th pSortableColumn="requestedAt" class="col-date">
                Date
                <p-sortIcon field="requestedAt"></p-sortIcon>
              </th>
              <th pSortableColumn="id" class="col-id">
                ID
                <p-sortIcon field="id"></p-sortIcon>
              </th>
              <th pSortableColumn="requesterName" class="col-requester">
                Requester
                <p-sortIcon field="requesterName"></p-sortIcon>
              </th>
              <th pSortableColumn="projectName" class="col-project">
                Project
                <p-sortIcon field="projectName"></p-sortIcon>
              </th>
              <th pSortableColumn="machineType" class="col-machine">
                Machine
                <p-sortIcon field="machineType"></p-sortIcon>
              </th>
              <th class="col-qty">Qty</th>
              <th pSortableColumn="urgency" class="col-urgency">
                Urgency
                <p-sortIcon field="urgency"></p-sortIcon>
              </th>
              <th pSortableColumn="status" class="col-status">
                Status
                <p-sortIcon field="status"></p-sortIcon>
              </th>
              <th class="col-age">Age</th>
              <th class="col-actions">Actions</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-request>
            <tr [ngClass]="'urgency-' + request.urgency.toLowerCase()">
              <td class="col-date">
                <div class="date-cell">
                  <i class="material-icons">event</i>
                  <span>{{ formatDate(request.requestedAt) }}</span>
                </div>
              </td>
              <td class="col-id">
                <span class="request-id">{{ request.id }}</span>
              </td>
              <td class="col-requester">
                <div class="user-cell">
                  <div class="user-avatar">
                    <i class="material-icons">person</i>
                  </div>
                  <div class="user-info">
                    <span class="user-name">{{ request.requesterName }}</span>
                    <span class="user-email">{{ request.requesterEmail }}</span>
                  </div>
                </div>
              </td>
              <td class="col-project">
                <div class="project-cell">
                  <span class="project-name">{{ request.projectName }}</span>
                  <span class="project-id">{{ request.projectId }}</span>
                </div>
              </td>
              <td class="col-machine">
                <span class="machine-badge">{{ request.machineType }}</span>
              </td>
              <td class="col-qty">
                <span class="quantity-badge">{{ request.quantity }}</span>
              </td>
              <td class="col-urgency">
                <span class="urgency-badge urgency-{{ request.urgency.toLowerCase() }}">
                  {{ request.urgency }}
                </span>
              </td>
              <td class="col-status">
                <span class="status-badge status-{{ request.status.toLowerCase() }}">
                  <i class="material-icons">
                    {{ request.status === 'APPROVED' ? 'check_circle' :
                       request.status === 'REJECTED' ? 'cancel' : 'schedule' }}
                  </i>
                  {{ request.status }}
                </span>
              </td>
              <td class="col-age">
                <span class="age-badge">{{ getRequestAgeLabel(request) }}</span>
              </td>
              <td class="col-actions">
                @if (request.status === 'PENDING') {
                  <div class="action-buttons">
                    <p-button
                      icon="pi pi-check"
                      [rounded]="true"
                      [text]="true"
                      severity="success"
                      (onClick)="approveRequest(request)"
                      pTooltip="Approve Request"
                      tooltipPosition="top">
                    </p-button>
                    <p-button
                      icon="pi pi-times"
                      [rounded]="true"
                      [text]="true"
                      severity="danger"
                      (onClick)="rejectRequest(request)"
                      pTooltip="Reject Request"
                      tooltipPosition="top">
                    </p-button>
                  </div>
                } @else {
                  <span class="no-actions">â€”</span>
                }
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    }
  </div>
</div>
