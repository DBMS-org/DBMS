<div class="assignment-requests-container">
  <!-- Modern Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-title-section">
        <div class="icon-wrapper">
          <i class="material-icons">assignment_turned_in</i>
        </div>
        <div class="title-content">
          <h1 class="page-title">Assignment Requests</h1>
          <p class="page-subtitle">Manage and review machine assignment requests</p>
        </div>
      </div>
      <div class="header-actions">
        <p-button
          icon="pi pi-download"
          label="Export"
          (onClick)="exportRequests()"
          [disabled]="isLoading"
          severity="secondary"
          [outlined]="true"
          styleClass="export-btn">
        </p-button>
        <p-button
          icon="pi pi-refresh"
          label="Refresh"
          (onClick)="refreshRequests()"
          [disabled]="isLoading"
          severity="secondary"
          [outlined]="true"
          styleClass="refresh-btn">
        </p-button>
      </div>
    </div>
  </div>

  <!-- Error notification display -->
  @if (error) {
    <div class="error-alert">
      <div class="error-content">
        <i class="material-icons">error_outline</i>
        <span>{{ error }}</span>
      </div>
      <button class="error-close" (click)="error = null" type="button" aria-label="Close error">
        <i class="material-icons">close</i>
      </button>
    </div>
  }

  <!-- Modern Statistics Dashboard -->
  <div class="stats-dashboard">
    <div class="stat-card stat-pending">
      <div class="stat-header">
        <div class="stat-icon-bg">
          <i class="material-icons">pending_actions</i>
        </div>
        <span class="stat-label">Pending</span>
      </div>
      <div class="stat-value">{{ statistics.pending }}</div>
      <div class="stat-footer">Awaiting Review</div>
    </div>

    <div class="stat-card stat-approved">
      <div class="stat-header">
        <div class="stat-icon-bg">
          <i class="material-icons">check_circle</i>
        </div>
        <span class="stat-label">Approved</span>
      </div>
      <div class="stat-value">{{ statistics.approved }}</div>
      <div class="stat-footer">Today</div>
    </div>

    <div class="stat-card stat-rejected">
      <div class="stat-header">
        <div class="stat-icon-bg">
          <i class="material-icons">cancel</i>
        </div>
        <span class="stat-label">Rejected</span>
      </div>
      <div class="stat-value">{{ statistics.rejected }}</div>
      <div class="stat-footer">Today</div>
    </div>

    <div class="stat-card stat-total">
      <div class="stat-header">
        <div class="stat-icon-bg">
          <i class="material-icons">inventory_2</i>
        </div>
        <span class="stat-label">Total</span>
      </div>
      <div class="stat-value">{{ statistics.total }}</div>
      <div class="stat-footer">All Requests</div>
    </div>
  </div>

  <!-- Modern Filter Section -->
  <div class="filter-section">
    <div class="filter-header">
      <div class="filter-title">
        <i class="material-icons">tune</i>
        <span>Filters</span>
      </div>
      <button class="clear-filters-btn" (click)="clearFilters()" type="button">
        <i class="material-icons">clear_all</i>
        Clear All
      </button>
    </div>

    <div class="filter-grid">
      <!-- Search Input -->
      <div class="filter-item search-item">
        <label class="filter-label">
          <i class="material-icons">search</i>
          Search
        </label>
        <input
          type="text"
          class="filter-input search-input"
          [(ngModel)]="searchQuery"
          (input)="applyAll()"
          placeholder="Search requests..." />
      </div>

      <!-- Status Filter -->
      <div class="filter-item">
        <label class="filter-label">Status</label>
        <p-dropdown
          [options]="[
            {label: 'All Status', value: 'ALL'},
            {label: 'Pending', value: 'PENDING'},
            {label: 'Approved', value: 'APPROVED'},
            {label: 'Rejected', value: 'REJECTED'}
          ]"
          [(ngModel)]="selectedStatus"
          (onChange)="applyAll()"
          optionLabel="label"
          optionValue="value"
          styleClass="w-full filter-dropdown">
        </p-dropdown>
      </div>

      <!-- Urgency Filter -->
      <div class="filter-item">
        <label class="filter-label">Urgency</label>
        <p-dropdown
          [options]="[
            {label: 'All Urgency', value: 'ALL'},
            {label: 'Low', value: 'LOW'},
            {label: 'Medium', value: 'MEDIUM'},
            {label: 'High', value: 'HIGH'},
            {label: 'Urgent', value: 'URGENT'}
          ]"
          [(ngModel)]="selectedUrgency"
          (onChange)="applyAll()"
          optionLabel="label"
          optionValue="value"
          styleClass="w-full filter-dropdown">
        </p-dropdown>
      </div>

      <!-- Machine Type Filter -->
      <div class="filter-item">
        <label class="filter-label">Machine Type</label>
        <p-dropdown
          [options]="[
            {label: 'All Types', value: 'ALL'},
            {label: 'Excavator', value: 'EXCAVATOR'},
            {label: 'Bulldozer', value: 'BULLDOZER'},
            {label: 'Loader', value: 'LOADER'},
            {label: 'Dump Truck', value: 'DUMP_TRUCK'},
            {label: 'Drill Rig', value: 'DRILL_RIG'},
            {label: 'Crane', value: 'CRANE'}
          ]"
          [(ngModel)]="selectedMachineType"
          (onChange)="applyAll()"
          optionLabel="label"
          optionValue="value"
          styleClass="w-full filter-dropdown">
        </p-dropdown>
      </div>
    </div>
  </div>

  <!-- Modern Table Section -->
  <div class="table-section">
    <div class="table-header">
      <div class="table-title">
        <i class="material-icons">view_list</i>
        <span>Requests List</span>
        <span class="request-count">{{ filteredRequests.length }}</span>
      </div>
    </div>

    <!-- Loading State -->
    @if (isLoading) {
      <div class="loading-state">
        <div class="loader-spinner"></div>
        <p>Loading assignment requests...</p>
      </div>
    }

    <!-- Empty State -->
    @if (!isLoading && filteredRequests.length === 0) {
      <div class="empty-state">
        <div class="empty-icon">
          <i class="material-icons">inbox</i>
        </div>
        <h3>No Requests Found</h3>
        <p>There are no assignment requests matching your current filters.</p>
        <button class="empty-action-btn" (click)="clearFilters()" type="button">
          Clear Filters
        </button>
      </div>
    }

    <!-- Modern Table -->
    @if (!isLoading && filteredRequests.length > 0) {
      <div class="requests-table-wrapper">
        <p-table
          [value]="filteredRequests"
          styleClass="modern-table"
          responsiveLayout="scroll"
          [paginator]="true"
          [rows]="10"
          [rowsPerPageOptions]="[10, 25, 50]"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Showing {first} to {last} of {totalRecords}"
          [sortField]="sortBy"
          [sortOrder]="sortDirection === 'asc' ? 1 : -1">

          <ng-template pTemplate="header">
            <tr>
              <th pSortableColumn="requestedAt" class="col-date">
                Date
                <p-sortIcon field="requestedAt"></p-sortIcon>
              </th>
              <th pSortableColumn="id" class="col-id">
                ID
                <p-sortIcon field="id"></p-sortIcon>
              </th>
              <th pSortableColumn="requesterName" class="col-requester">
                Requester
                <p-sortIcon field="requesterName"></p-sortIcon>
              </th>
              <th pSortableColumn="projectName" class="col-project">
                Project
                <p-sortIcon field="projectName"></p-sortIcon>
              </th>
              <th pSortableColumn="machineType" class="col-machine">
                Machine
                <p-sortIcon field="machineType"></p-sortIcon>
              </th>
              <th class="col-qty">Qty</th>
              <th pSortableColumn="urgency" class="col-urgency">
                Urgency
                <p-sortIcon field="urgency"></p-sortIcon>
              </th>
              <th pSortableColumn="status" class="col-status">
                Status
                <p-sortIcon field="status"></p-sortIcon>
              </th>
              <th class="col-age">Age</th>
              <th class="col-actions">Actions</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-request>
            <tr [ngClass]="'urgency-' + request.urgency.toLowerCase()">
              <td class="col-date">
                <div class="date-cell">
                  <i class="material-icons">event</i>
                  <span>{{ formatDate(request.requestedAt) }}</span>
                </div>
              </td>
              <td class="col-id">
                <span class="request-id">{{ request.id }}</span>
              </td>
              <td class="col-requester">
                <div class="user-cell">
                  <div class="user-avatar">
                    <i class="material-icons">person</i>
                  </div>
                  <div class="user-info">
                    <span class="user-name">{{ request.requesterName }}</span>
                    <span class="user-email">{{ request.requesterEmail }}</span>
                  </div>
                </div>
              </td>
              <td class="col-project">
                <div class="project-cell">
                  <span class="project-name">{{ request.projectName }}</span>
                  <span class="project-id">{{ request.projectId }}</span>
                </div>
              </td>
              <td class="col-machine">
                <span class="machine-badge">{{ request.machineType }}</span>
              </td>
              <td class="col-qty">
                <span class="quantity-badge">{{ request.quantity }}</span>
              </td>
              <td class="col-urgency">
                <span class="urgency-badge urgency-{{ request.urgency.toLowerCase() }}">
                  {{ request.urgency }}
                </span>
              </td>
              <td class="col-status">
                <span class="status-badge status-{{ request.status.toLowerCase() }}">
                  <i class="material-icons">
                    {{ request.status === 'APPROVED' ? 'check_circle' :
                       request.status === 'REJECTED' ? 'cancel' : 'schedule' }}
                  </i>
                  {{ request.status }}
                </span>
              </td>
              <td class="col-age">
                <span class="age-badge">{{ getRequestAgeLabel(request) }}</span>
              </td>
              <td class="col-actions">
                @if (request.status === 'PENDING') {
                  <div class="action-buttons">
                    <p-button
                      icon="pi pi-check"
                      [rounded]="true"
                      [text]="true"
                      severity="success"
                      (onClick)="approveRequest(request)"
                      pTooltip="Approve Request"
                      tooltipPosition="top">
                    </p-button>
                    <p-button
                      icon="pi pi-times"
                      [rounded]="true"
                      [text]="true"
                      severity="danger"
                      (onClick)="rejectRequest(request)"
                      pTooltip="Reject Request"
                      tooltipPosition="top">
                    </p-button>
                  </div>
                } @else {
                  <span class="no-actions">â€”</span>
                }
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    }
  </div>
</div>
