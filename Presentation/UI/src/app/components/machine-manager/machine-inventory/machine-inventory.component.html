<div class="machine-inventory-container">
  <!-- Header Section -->
  <div class="inventory-header">
    <h1>Machine Inventory</h1>
    <div class="header-actions">
      <button
        class="assignment-requests-btn"
        (click)="navigateToAssignmentRequests()"
        [disabled]="isLoading">
        <i class="material-icons">assignment</i>
        Assignment Requests
        @if (statistics.pendingRequests > 0) {
          <span class="badge-count">{{ statistics.pendingRequests }}</span>
        }
      </button>
      <button
        class="add-machine-btn"
        (click)="openAddMachineModal()"
        [disabled]="isLoading">
        <i class="material-icons">add</i>
        New Machine
      </button>
    </div>
  </div>

  <!-- Error Alert -->
  @if (error) {
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="material-icons">error</i>
      {{ error }}
      <button type="button" class="btn-close" (click)="error = null"></button>
    </div>
  }

  <!-- Statistics Grid -->
  <div class="stats-grid">
    <div class="stat-card total">
      <div class="stat-icon">
        <i class="material-icons">precision_manufacturing</i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.total }}</h3>
        <p>Total Machines</p>
      </div>
    </div>
    <div class="stat-card available">
      <div class="stat-icon">
        <i class="material-icons">check_circle</i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.available }}</h3>
        <p>Available</p>
      </div>
    </div>
    <div class="stat-card assigned">
      <div class="stat-icon">
        <i class="material-icons">assignment_ind</i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.assigned }}</h3>
        <p>Assigned</p>
      </div>
    </div>
    <div class="stat-card maintenance">
      <div class="stat-icon">
        <i class="material-icons">build</i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.maintenance }}</h3>
        <p>Maintenance</p>
      </div>
    </div>
    <div class="stat-card out-of-service">
      <div class="stat-icon">
        <i class="material-icons">cancel</i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.outOfService }}</h3>
        <p>Out of Service</p>
      </div>
    </div>
    <div class="stat-card requests">
      <div class="stat-icon">
        <i class="material-icons">pending_actions</i>
      </div>
      <div class="stat-content">
        <h3>{{ statistics.pendingRequests }}</h3>
        <p>Pending Requests</p>
      </div>
    </div>
  </div>

  <!-- Search and Filter Section -->
  <div class="search-filter-section">
    <div class="search-box">
      <input 
        type="text" 
        class="form-control" 
        placeholder="Search machines..." 
        [(ngModel)]="searchTerm"
        (ngModelChange)="onSearchChange()">
    </div>
    
    <div class="filter-section">
      <select 
        class="form-select" 
        [(ngModel)]="selectedStatus" 
        (ngModelChange)="onStatusFilterChange()">
        <option value="ALL">All Status</option>
        @for (status of machineStatusOptions; track status) {
          <option [value]="status">{{ status }}</option>
        }
      </select>
      
      <select 
        class="form-select" 
        [(ngModel)]="selectedType" 
        (ngModelChange)="onTypeFilterChange()">
        <option value="ALL">All Types</option>
        @for (type of machineTypeOptions; track type) {
          <option [value]="type">{{ type }}</option>
        }
      </select>
      
      <select
        class="form-select"
        [(ngModel)]="selectedProject"
        (ngModelChange)="onProjectFilterChange()">
        <option value="ALL">All Projects</option>
        <option value="UNASSIGNED">Unassigned</option>
        @for (project of projectOptions; track project) {
          <option [value]="project">{{ project }}</option>
        }
      </select>
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading) {
    <div class="loading-container">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  }

  <!-- Machines Table -->
  <div class="table-container" *ngIf="!isLoading">
    <table class="machines-table">
      <thead>
        <tr>
          <th>Machine Name</th>
          <th>Type</th>
          <th>Model</th>
          <th>Status</th>
          <th>Project</th>
          <th>Operator</th>
          <th>Location</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let machine of filteredMachines" class="machine-row">
          <td class="machine-name" (click)="openMachineDetailsModal(machine)">
            <div class="machine-info">
              <span class="name">{{ machine.name }}</span>
              <small class="serial">{{ machine.serialNumber }}</small>
            </div>
          </td>
          <td class="machine-type">{{ machine.type }}</td>
          <td class="machine-model">
            <div class="model-info">
              <span class="model">{{ machine.model }}</span>
              <small class="manufacturer">{{ machine.manufacturer }}</small>
            </div>
          </td>
          <td class="machine-status">
            <span class="status-badge" [ngClass]="getStatusClass(machine.status)">
              {{ machine.status }}
            </span>
          </td>
          <td class="machine-project">
            @if (machine.projectName || machine.assignedToProject) {
              <span class="project-name">{{ machine.projectName || machine.assignedToProject }}</span>
            } @else {
              <span class="text-muted">Unassigned</span>
            }
          </td>
          <td class="machine-operator">
            @if (machine.operatorName || machine.assignedToOperator) {
              <span class="operator-name">{{ machine.operatorName || machine.assignedToOperator }}</span>
            } @else {
              <span class="text-muted">Unassigned</span>
            }
          </td>
          <td class="machine-location">{{ machine.currentLocation || 'N/A' }}</td>
          <td class="machine-actions">
            <div class="action-buttons">
              <button
                class="action-btn view-btn"
                (click)="openMachineDetailsModal(machine)"
                title="View Details">
                <i class="material-icons">visibility</i>
              </button>
              <button
                class="action-btn edit-btn"
                (click)="openEditMachineModal(machine)"
                title="Edit Machine">
                <i class="material-icons">edit</i>
              </button>
              <button
                class="action-btn delete-btn"
                (click)="openDeleteConfirmModal(machine)"
                title="Delete Machine">
                <i class="material-icons">delete</i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- No Machines Message -->
    <div *ngIf="filteredMachines.length === 0" class="no-machines">
      <div class="empty-state">
        <i class="material-icons">precision_manufacturing</i>
        <h4>No Machines Found</h4>
        <p>No machines match your current filters. Try adjusting your search criteria.</p>
      </div>
    </div>
  </div>
</div>

<!-- Machine Details Modal -->
@if (showMachineDetailsModal && selectedMachine) {
  <app-machine-details
    [machine]="selectedMachine"
    (close)="closeModals()">
  </app-machine-details>
}

<!-- Add Machine Modal -->
@if (showAddMachineModal) {
  <app-add-machine
    (machineSaved)="onMachineSaved($event)"
    (close)="closeModals()">
  </app-add-machine>
}

<!-- Edit Machine Modal -->
@if (showEditMachineModal && selectedMachine) {
  <app-edit-machine
    [machine]="selectedMachine"
    (machineSaved)="onMachineSaved($event)"
    (close)="closeModals()">
  </app-edit-machine>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteConfirmModal && machineToDelete) {
  <div class="modal-overlay">
    <div class="modal-content delete-confirmation">
      <div class="modal-icon warning-icon">
        <i class="material-icons">warning</i>
      </div>
      <h5>Confirm Machine Deletion</h5>
      <div class="confirmation-message">
        <p>You are about to permanently delete the following machine:</p>
        <div class="machine-details-summary">
          <div class="detail-row">
            <span class="label">Machine Name:</span>
            <span class="value">{{ machineToDelete.name }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Serial Number:</span>
            <span class="value">{{ machineToDelete.serialNumber }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Type:</span>
            <span class="value">{{ machineToDelete.type }}</span>
          </div>
        </div>
        <p class="warning-text">
          <i class="material-icons">info</i>
          This action cannot be undone. All associated data and history for this machine will be permanently removed from the system.
        </p>
        <p class="confirmation-question">Are you certain you wish to proceed with this deletion?</p>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">Cancel</button>
        <button type="button" class="btn btn-danger" (click)="confirmDelete()">
          <i class="material-icons">delete_forever</i>
          Confirm Deletion
        </button>
      </div>
    </div>
  </div>
}
