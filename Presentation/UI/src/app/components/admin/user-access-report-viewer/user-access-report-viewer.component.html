<div class="user-access-report-container">
  <!-- Header -->
  <div class="report-header no-print">
    <div class="header-content">
      <div class="title-section">
        <button type="button" class="back-btn" (click)="goBack()">
          <i class="pi pi-arrow-left"></i>
          Back
        </button>
        <h1 class="report-title">
          <i class="pi pi-users"></i>
          User & Access Management Report
        </h1>
      </div>
      <div class="action-buttons">
        <button type="button" class="action-btn print-btn" (click)="printReport()">
          <i class="pi pi-print"></i>
          Print
        </button>
        <button type="button" class="action-btn export-btn" (click)="exportToPdf()">
          <i class="pi pi-file-pdf"></i>
          PDF
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Generating User & Access Management Report...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-container">
    <i class="pi pi-exclamation-circle error-icon"></i>
    <p>{{ error }}</p>
    <button class="retry-button" (click)="loadReport()">Retry</button>
  </div>

  <!-- Report Content -->
  <div *ngIf="!loading && !error && report" class="report-content">
    <!-- Filter Section -->
    <div class="filter-section no-print mb-6">
      <div class="bg-white rounded-2xl shadow-lg border-2 border-gray-200 overflow-hidden">
        <!-- Filter Header -->
        <div class="bg-gradient-to-r from-teal-50 to-emerald-50 border-b-2 border-gray-200 px-6 py-4 cursor-pointer"
             (click)="isFilterExpanded = !isFilterExpanded">
          <div class="flex items-center justify-between flex-wrap gap-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gradient-to-br from-teal-500 to-emerald-600 rounded-lg flex items-center justify-center shadow-md">
                <i class="pi pi-filter text-white text-lg"></i>
              </div>
              <h3 class="text-xl font-bold text-gray-800">Report Filters</h3>
              <button type="button"
                      class="flex items-center gap-2 px-3 py-1.5 text-xs font-semibold text-teal-600 bg-teal-50 border border-teal-200 rounded-lg hover:bg-teal-100 transition-all duration-300"
                      (click)="isFilterExpanded = !isFilterExpanded; $event.stopPropagation()">
                <i [class]="isFilterExpanded ? 'pi pi-chevron-up' : 'pi pi-chevron-down'"></i>
                <span>{{ isFilterExpanded ? 'Collapse' : 'Expand' }}</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Filter Grid -->
        <div class="p-6 transition-all duration-300"
             [class.hidden]="!isFilterExpanded"
             [class.max-h-0]="!isFilterExpanded"
             [class.overflow-hidden]="!isFilterExpanded">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
            <!-- Start Date Filter -->
            <div class="filter-field">
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="pi pi-calendar text-teal-500 mr-2"></i>Start Date
              </label>
              <input type="date"
                     [(ngModel)]="filterStartDate"
                     title="Start Date"
                     placeholder="Select start date"
                     class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-100 transition-all duration-200 bg-white">
            </div>

            <!-- End Date Filter -->
            <div class="filter-field">
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="pi pi-calendar text-teal-500 mr-2"></i>End Date
              </label>
              <input type="date"
                     [(ngModel)]="filterEndDate"
                     title="End Date"
                     placeholder="Select end date"
                     class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-100 transition-all duration-200 bg-white">
            </div>

            <!-- User Status Filter -->
            <div class="filter-field">
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="pi pi-user text-teal-500 mr-2"></i>User Status
              </label>
              <select multiple
                      [(ngModel)]="filterUserStatuses"
                      title="User Status"
                      class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-100 transition-all duration-200 bg-white">
                <option *ngFor="let option of userStatusOptions" [value]="option.value">
                  {{ option.label }}
                </option>
              </select>
            </div>

            <!-- Activity Status Filter -->
            <div class="filter-field">
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="pi pi-chart-line text-teal-500 mr-2"></i>Activity Status
              </label>
              <select multiple
                      [(ngModel)]="filterActivityStatuses"
                      title="Activity Status"
                      class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-100 transition-all duration-200 bg-white">
                <option *ngFor="let option of activityStatusOptions" [value]="option.value">
                  {{ option.label }}
                </option>
              </select>
            </div>

            <!-- Role Filter -->
            <div class="filter-field">
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="pi pi-shield text-teal-500 mr-2"></i>Role
              </label>
              <select multiple
                      [(ngModel)]="filterRoles"
                      title="Role"
                      class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-100 transition-all duration-200 bg-white">
                <option *ngFor="let option of roleOptions" [value]="option.value">
                  {{ option.label }}
                </option>
              </select>
            </div>

            <!-- Region Filter -->
            <div class="filter-field">
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="pi pi-map-marker text-teal-500 mr-2"></i>Region
              </label>
              <select multiple
                      [(ngModel)]="filterRegions"
                      title="Region"
                      class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:border-teal-500 focus:ring-2 focus:ring-teal-100 transition-all duration-200 bg-white">
                <option *ngFor="let option of regionOptions" [value]="option.value">
                  {{ option.label }}
                </option>
              </select>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-wrap gap-3 pt-4 border-t-2 border-gray-200">
            <button type="button"
                    class="inline-flex items-center gap-2 px-6 py-2.5 bg-gradient-to-r from-teal-500 to-emerald-600 text-white font-semibold rounded-lg hover:from-teal-600 hover:to-emerald-700 focus:outline-none focus:ring-2 focus:ring-teal-400 focus:ring-offset-2 shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105"
                    (click)="applyFilters()">
              <i class="pi pi-filter"></i>
              <span>Apply Filters</span>
            </button>
            <button type="button"
                    class="inline-flex items-center gap-2 px-6 py-2.5 bg-white text-gray-700 font-semibold border-2 border-gray-300 rounded-lg hover:bg-gray-50 hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 shadow-sm hover:shadow transition-all duration-300"
                    (click)="clearFilters()">
              <i class="pi pi-times"></i>
              <span>Clear Filters</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Report Title -->
    <div class="report-title-section">
      <h1>User & Access Management Report</h1>
      <p class="report-subtitle">Generated: {{ report.generatedAt | date:'medium' }}</p>
      <p class="report-period" *ngIf="report.startDate && report.endDate">
        Period: {{ report.startDate | date:'shortDate' }} - {{ report.endDate | date:'shortDate' }}
      </p>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)">
          <i class="pi pi-users"></i>
        </div>
        <div class="stat-details">
          <div class="stat-value">{{ report.statistics.totalUsers }}</div>
          <div class="stat-label">Total Users</div>
          <small class="stat-meta">{{ report.statistics.activeUsers }} Active, {{ report.statistics.inactiveUsers }} Inactive</small>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%)">
          <i class="pi pi-shield"></i>
        </div>
        <div class="stat-details">
          <div class="stat-value">{{ report.statistics.totalRoles }}</div>
          <div class="stat-label">Total Roles</div>
          <small class="stat-meta">{{ report.statistics.usersWithMultipleRoles }} users with multiple roles</small>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)">
          <i class="pi pi-user-plus"></i>
        </div>
        <div class="stat-details">
          <div class="stat-value">{{ report.statistics.adminUsers }}</div>
          <div class="stat-label">Admin Users</div>
          <small class="stat-meta">{{ report.statistics.regularUsers }} Regular Users</small>
        </div>
      </div>
    </div>

    <!-- Users Section -->
    <div class="section">
      <h2 class="section-title">
        <i class="pi pi-users"></i>
        User Overview
      </h2>

      <div class="charts-row">
        <div class="chart-card">
          <h3>User Status Distribution</h3>
          <div class="chart-container">
            <p-chart type="doughnut" [data]="userStatusChart" [options]="{
              plugins: {
                legend: {
                  position: 'bottom'
                }
              }
            }"></p-chart>
          </div>
        </div>

        <div class="chart-card">
          <h3>Activity Status</h3>
          <div class="chart-container">
            <p-chart type="pie" [data]="activityStatusChart" [options]="{
              plugins: {
                legend: {
                  position: 'bottom'
                }
              }
            }"></p-chart>
          </div>
        </div>
      </div>

      <!-- Users Table -->
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Username</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Region</th>
              <th>Roles</th>
              <th>Status</th>
              <th>Last Login</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of report.users">
              <td>{{ user.userId }}</td>
              <td>
                <div class="user-info">
                  <p-avatar icon="pi pi-user" shape="circle" [style]="{'background-color': '#dee2e6'}"></p-avatar>
                  <strong>{{ user.username }}</strong>
                </div>
              </td>
              <td>{{ user.email }}</td>
              <td>{{ user.phoneNumber }}</td>
              <td>{{ user.region }}</td>
              <td>
                <div class="roles-container">
                  <p-chip *ngFor="let role of user.roles; let i = index"
                          [label]="role"
                          [styleClass]="'role-chip-' + getRoleChipColor(i)">
                  </p-chip>
                </div>
              </td>
              <td><p-tag [value]="user.isActive ? 'Active' : 'Inactive'" [severity]="getUserStatusSeverity(user.isActive)"></p-tag></td>
              <td>{{ user.lastLoginDate ? (user.lastLoginDate | date:'short') : 'Never' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- User Activity Section -->
    <div class="section">
      <h2 class="section-title">
        <i class="pi pi-chart-line"></i>
        User Activity Summary
      </h2>

      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Username</th>
              <th>Primary Role</th>
              <th>Last Login</th>
              <th>Activity Status</th>
              <th>Account Status</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let activity of report.userActivity">
              <td>{{ activity.userId }}</td>
              <td>
                <div class="user-info">
                  <p-avatar icon="pi pi-user" shape="circle" [style]="{'background-color': '#dee2e6'}"></p-avatar>
                  <strong>{{ activity.username }}</strong>
                </div>
              </td>
              <td>{{ activity.primaryRole }}</td>
              <td>{{ activity.lastLoginDate ? (activity.lastLoginDate | date:'short') : 'Never' }}</td>
              <td>
                <p-tag [value]="activity.activityStatus" [severity]="getActivityStatusSeverity(activity.activityStatus)"></p-tag>
              </td>
              <td>
                <p-tag [value]="activity.isActive ? 'Active' : 'Inactive'" [severity]="getUserStatusSeverity(activity.isActive)"></p-tag>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Footer -->
    <div class="report-footer">
      <p>Generated by DBMS - Detonation and Blasting Management System</p>
      <p>Â© 2024 All Rights Reserved</p>
    </div>
  </div>
</div>
