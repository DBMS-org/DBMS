<div class="users-container">
  <div class="users-header">
    <h1>Users</h1>
    <div class="header-actions">
      <button class="test-connection-btn" (click)="testConnection()">
        <i class="material-icons">wifi</i>
        Test API Connection
      </button>
      <button class="assign-user-btn" (click)="openAssignUserModal()">
        <i class="material-icons">assignment_ind</i>
        Assign User
      </button>
      <button class="add-user-btn" (click)="addUser()">
        <i class="material-icons">add</i>
        Add New User
      </button>
    </div>
  </div>

  <!-- Error Alert -->
  @if (error) {
    <div class="error-alert">
      <i class="material-icons">error</i>
      <span>{{error}}</span>
      <button (click)="error = null" class="close-error">
        <i class="material-icons">close</i>
      </button>
    </div>
  }

  <!-- Loading State -->
  @if (loading) {
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p>Loading users...</p>
    </div>
  } @else {
    <div class="filters-section">
      <div class="filters-row">
        <div class="search-section">
          <h3>Search</h3>
          <div class="search-input">
            <i class="material-icons">search</i>
            <input 
              type="text" 
              [(ngModel)]="searchQuery" 
              (input)="onSearch()"
              placeholder="Search by name, email or region..."
            >
          </div>
        </div>

        <div class="filter-section">
          <h3>Filter</h3>
          <div class="status-filter">
            <select id="statusFilter" [(ngModel)]="statusFilter" (change)="onSearch()">
              <option value="">All Status</option>
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="users-table">
      <p-table
        [value]="filteredUsers"
        styleClass="p-datatable-sm p-datatable-striped"
        responsiveLayout="scroll"
        [paginator]="true"
        [rows]="10"
        [rowsPerPageOptions]="[5, 10, 20, 50]"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} users"
        [tableStyle]="{ 'min-width': '50rem' }"
      >
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7" class="text-center">
              <div class="no-users">
                <i class="material-icons">person_off</i>
                <p>No users found</p>
                @if (searchQuery || statusFilter) {
                  <button (click)="searchQuery = ''; statusFilter = ''; onSearch()" class="clear-filters-btn">
                    Clear Filters
                  </button>
                }
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="header">
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Oman Phone</th>
            <th>Region</th>
            <th>Status</th>
            <th style="width: 10rem">Actions</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-user>
          <tr>
            <td>{{ user.name }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.role }}</td>
            <td>{{ user.omanPhone }}</td>
            <td>{{ user.region }}</td>
            <td>
              <p-tag
                [value]="user.status"
                [severity]="user.status === 'Active' ? 'success' : 'danger'"
              ></p-tag>
            </td>
            <td>
              <div class="flex gap-2">
                <p-button
                  icon="pi pi-eye"
                  [rounded]="true"
                  [text]="true"
                  severity="info"
                  (onClick)="showUserDetails(user)"
                  [pTooltip]="'View Details'"
                  tooltipPosition="top"
                ></p-button>
                <p-button
                  icon="pi pi-pencil"
                  [rounded]="true"
                  [text]="true"
                  severity="warning"
                  (onClick)="editUser(user.id)"
                  [pTooltip]="'Edit User'"
                  tooltipPosition="top"
                ></p-button>
                <p-button
                  icon="pi pi-trash"
                  [rounded]="true"
                  [text]="true"
                  severity="danger"
                  (onClick)="deleteUser(user.id)"
                  [pTooltip]="'Delete User'"
                  tooltipPosition="top"
                ></p-button>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  }
</div>

@if (showAddUserModal) {
  <app-add-user 
    (close)="onCloseAddUser()" 
    (save)="onSaveUser($event)"
    [error]="error"
  ></app-add-user>
}

@if (showAssignUserModal) {
  <app-assign-user 
    (close)="onCloseAssignUser()"
  ></app-assign-user>
}

@if (showDeleteModal) {
  <div class="modal-overlay">
    <div class="modal-content">
      <p>Are you sure you want to delete this user?</p>
      <div class="modal-actions">
        <button class="btn btn-danger" (click)="confirmDelete()">Yes</button>
        <button class="btn btn-secondary" (click)="closeDeleteModal()">No</button>
      </div>
    </div>
  </div>
}
