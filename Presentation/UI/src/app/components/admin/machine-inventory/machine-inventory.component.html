<div class="machine-inventory-container">
  <!-- Page Header with Title and Action Buttons -->
  <div class="header-section">
    <h2 class="page-title">Machine Inventory & Management</h2>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="navigateToAssignments()">
        <i class="fas fa-clipboard-list"></i> View Assignments
      </button>
    </div>
  </div>

  <!-- Search and Filter Controls Section -->
  <div class="search-filter-section">
    <div class="search-box">
      <input 
        type="text" 
        class="form-control" 
        placeholder="Search machines by name, model, manufacturer, or serial number..."
        [(ngModel)]="searchTerm"
        (input)="onSearchChange()"
      />
    </div>
    
    <div class="filter-section">
      <select class="form-select" [(ngModel)]="selectedStatus" (change)="onStatusFilterChange()">
        <option value="ALL">All Statuses</option>
        <option *ngFor="let status of machineStatusOptions" [value]="status">
          {{ status }}
        </option>
      </select>

      <select class="form-select" [(ngModel)]="selectedType" (change)="onTypeFilterChange()">
        <option value="ALL">All Types</option>
        <option *ngFor="let type of machineTypeOptions" [value]="type">
          {{ type }}
        </option>
      </select>
    </div>
  </div>

  <!-- Error Alert Message -->
  <div *ngIf="error" class="alert alert-danger">
    <i class="fas fa-exclamation-triangle"></i>
    {{ error }}
    <button type="button" class="btn-close" (click)="error = null"></button>
  </div>

  <!-- Loading state -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p>Loading machines...</p>
  </div>

  <!-- Machines Table -->
  <div class="table-container" *ngIf="!isLoading">
    <table class="machines-table">
      <thead>
        <tr>
          <th>Machine</th>
          <th>Type</th>
          <th>Status</th>
          <th>Location</th>
          <th>Assignment</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let machine of filteredMachines" class="machine-row">
          <td class="machine-details">
            <div class="machine-info">
              <h5>{{ machine.name }}</h5>
              <p class="text-muted">{{ machine.manufacturer }} {{ machine.model }}</p>
              <small class="text-secondary">S/N: {{ machine.serialNumber }}</small>
            </div>
          </td>
          
          <td class="machine-type">
            <span>{{ machine.type }}</span>
          </td>

          <td class="machine-status">
            <span>{{ machine.status }}</span>
          </td>
          
          <td class="machine-location">
            {{ machine.currentLocation || 'Not specified' }}
          </td>
          
          <td class="machine-assignment">
            <div *ngIf="machine.assignedToProject" class="assignment-info">
              <p><strong>Project:</strong> {{ machine.assignedToProject }}</p>
              <p *ngIf="machine.assignedToOperator"><strong>Operator:</strong> {{ machine.assignedToOperator }}</p>
            </div>
            <span *ngIf="!machine.assignedToProject" class="text-muted">Not assigned</span>
          </td>
          
          <td class="machine-actions">
            <div class="action-buttons">
              <button
                class="action-btn view-btn"
                (click)="viewMachine(machine)"
                title="View Details">
                <i class="fas fa-eye"></i>
              </button>
              <button
                class="action-btn assign-btn"
                (click)="openAssignOperatorModal(machine)"
                title="Assign Operator">
                <i class="fas fa-user-cog"></i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- No Machines Message -->
    <div *ngIf="filteredMachines.length === 0" class="no-machines">
      <div class="empty-state">
        <i class="fas fa-cogs fa-3x text-muted"></i>
        <h4>No Machines Found</h4>
        <p>No machines match your current filters. Try adjusting your search criteria.</p>
      </div>
    </div>
  </div>
</div>

<!-- Assign Operator Modal -->
@if (showAssignOperatorModal && machineToAssignOperator) {
  <div class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h5>Assign Operator to Machine</h5>
        <button class="close-btn" (click)="closeModals()">
          <i class="material-icons">close</i>
        </button>
      </div>
      <div class="modal-body">
        <p><strong>Machine:</strong> {{ machineToAssignOperator.name }}</p>
        <p><strong>Model:</strong> {{ machineToAssignOperator.model }}</p>
        <p><strong>Current Operator:</strong> {{ machineToAssignOperator.assignedToOperator || 'None' }}</p>

        <div class="form-group mt-3">
          <label for="operatorSelect">Select Operator</label>
          <select
            id="operatorSelect"
            class="form-select"
            [(ngModel)]="selectedOperatorId">
            <option [ngValue]="null">-- Unassign Operator --</option>
            <option *ngFor="let operator of operators" [ngValue]="operator.id">
              {{ operator.name }} ({{ operator.email }})
            </option>
          </select>
        </div>
      </div>
      <div class="modal-actions">
        <button
          class="btn btn-primary"
          (click)="confirmAssignOperator()"
          [disabled]="selectedOperatorId === machineToAssignOperator.operatorId">
          <i class="fas fa-check"></i>
          Assign Operator
        </button>
        <button class="btn btn-secondary" (click)="closeModals()">
          <i class="fas fa-times"></i>
          Cancel
        </button>
      </div>
    </div>
  </div>
}

<!-- Reassignment Confirmation Modal -->
@if (showReassignConfirmModal && machineToAssignOperator && operatorCurrentMachine) {
  <div class="modal-overlay">
    <div class="modal-content reassign-modal">
      <div class="modal-header">
        <h5>Operator Already Assigned</h5>
        <button class="close-btn" (click)="closeModals()">
          <i class="material-icons">close</i>
        </button>
      </div>
      <div class="modal-body">
        <div class="warning-message">
          <i class="fas fa-exclamation-triangle"></i>
          <p class="warning-text">
            The selected operator is already assigned to another machine.
          </p>
        </div>

        <div class="assignment-details">
          <div class="detail-section">
            <h6>Current Assignment:</h6>
            <div class="machine-card current">
              <p><strong>Machine:</strong> {{ operatorCurrentMachine.name }}</p>
              <p><strong>Model:</strong> {{ operatorCurrentMachine.model }}</p>
              <p><strong>Operator:</strong> {{ operatorCurrentMachine.assignedToOperator }}</p>
            </div>
          </div>

          <div class="arrow-icon">
            <i class="fas fa-arrow-right"></i>
          </div>

          <div class="detail-section">
            <h6>New Assignment:</h6>
            <div class="machine-card new">
              <p><strong>Machine:</strong> {{ machineToAssignOperator.name }}</p>
              <p><strong>Model:</strong> {{ machineToAssignOperator.model }}</p>
              <p><strong>Operator:</strong> {{ operatorCurrentMachine.assignedToOperator }}</p>
            </div>
          </div>
        </div>

        <p class="confirmation-text">
          If you proceed, the operator will be reassigned to <strong>{{ machineToAssignOperator.name }}</strong>
          and removed from <strong>{{ operatorCurrentMachine.name }}</strong>.
        </p>

        <p class="question-text">Do you want to continue?</p>
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" (click)="confirmReassignment()">
          <i class="fas fa-check"></i>
          Yes, Reassign Operator
        </button>
        <button class="btn btn-secondary" (click)="closeModals()">
          <i class="fas fa-times"></i>
          Cancel
        </button>
      </div>
    </div>
  </div>
}

<!-- Machine Details Modal -->
<div class="modal-overlay" *ngIf="showMachineDetailsModal" (click)="closeMachineDetailsModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="header-content">
        <div class="header-icon">
          <i class="material-icons">info</i>
        </div>
        <div class="header-text">
          <h2>Machine Details</h2>
          <p class="header-subtitle">View machine information</p>
        </div>
      </div>
      <button class="close-btn" (click)="closeMachineDetailsModal()">
        <i class="material-icons">close</i>
      </button>
    </div>

    <div class="machine-details-form" *ngIf="selectedMachine">
      
      <!-- Machine Information Card -->
      <div class="details-card">
        <div class="card-header">
          <div class="card-header-content">
            <div class="card-icon">
              <i class="material-icons">info</i>
            </div>
            <div class="card-title-section">
              <h3>{{ selectedMachine.name }}</h3>
              <p class="card-subtitle">Machine Information</p>
            </div>
          </div>
          <div class="status-indicator" [class]="getStatusClass(selectedMachine.status)">
            <i class="material-icons">{{ getStatusIcon(selectedMachine.status) }}</i>
            <span>{{ selectedMachine.status }}</span>
          </div>
        </div>
        <div class="card-body">
          <div class="details-grid">
            <div class="detail-item">
              <div class="detail-label">
                <i class="material-icons">badge</i>
                Machine Name
              </div>
              <div class="detail-value">{{ selectedMachine.name }}</div>
            </div>
            
            <div class="detail-item">
              <div class="detail-label">
                <i class="material-icons">person</i>
                Operator Name
              </div>
              <div class="detail-value">{{ selectedMachine.assignedToOperator || selectedMachine.operatorName || 'Not assigned' }}</div>
            </div>

            <div class="detail-item">
              <div class="detail-label">
                <i class="material-icons">model_training</i>
                Model
              </div>
              <div class="detail-value">{{ selectedMachine.model }}</div>
            </div>

            <div class="detail-item">
              <div class="detail-label">
                <i class="material-icons">qr_code</i>
                Serial Number
              </div>
              <div class="detail-value">{{ selectedMachine.serialNumber }}</div>
            </div>

            <div class="detail-item">
              <div class="detail-label">
                <i class="material-icons">construction</i>
                Rig No
              </div>
              <div class="detail-value">{{ selectedMachine.rigNo || 'N/A' }}</div>
            </div>
            
            <div class="detail-item">
              <div class="detail-label">
                <i class="material-icons">local_shipping</i>
                Plate No
              </div>
              <div class="detail-value">{{ selectedMachine.plateNo || 'N/A' }}</div>
            </div>


            
            <div class="detail-item">
              <div class="detail-label">
                <i class="material-icons">calendar_today</i>
                Manufacturing Year
              </div>
              <div class="detail-value">{{ selectedMachine.manufacturingYear || 'N/A' }}</div>
            </div>

            <div class="detail-item full-width">
              <div class="detail-label">
                <i class="material-icons">directions_car</i>
                Chassis Details
              </div>
              <div class="detail-value chassis-details">{{ selectedMachine.chassisDetails || 'N/A' }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Additional Information Card -->
      <div class="details-card">
        <div class="card-header">
          <div class="card-header-content">
            <div class="card-icon">
              <i class="material-icons">assignment</i>
            </div>
            <div class="card-title-section">
              <h3>Additional Information</h3>
              <p class="card-subtitle">System generated details</p>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="details-grid">
            <div class="detail-item">
              <div class="detail-label">
                <i class="material-icons">location_on</i>
                Current Location
              </div>
              <div class="detail-value">{{ selectedMachine.currentLocation || 'Not specified' }}</div>
            </div>

            <div class="detail-item">
              <div class="detail-label">
                <i class="material-icons">category</i>
                Machine Type
              </div>
              <div class="detail-value">{{ selectedMachine.type || 'Not specified' }}</div>
            </div>

            <div class="detail-item">
              <div class="detail-label">
                <i class="material-icons">schedule</i>
                Created Date
              </div>
              <div class="detail-value">{{ formatDate(selectedMachine.createdAt) }}</div>
            </div>

            <div class="detail-item">
              <div class="detail-label">
                <i class="material-icons">update</i>
                Last Updated
              </div>
              <div class="detail-value">{{ formatDate(selectedMachine.updatedAt) }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Footer with Close Button -->
      <div class="details-actions">
        <button 
          type="button" 
          class="close-btn-action" 
          (click)="closeMachineDetailsModal()">
          <i class="material-icons">close</i>
          Close
        </button>
      </div>
    </div>
  </div>
</div>
