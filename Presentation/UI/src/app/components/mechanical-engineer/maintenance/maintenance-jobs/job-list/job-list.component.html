<div class="job-list-container">
  <!-- Bulk Actions Toolbar -->
  @if (selectedJobs.length > 0) {
    <div class="bulk-actions-toolbar">
      <div class="bulk-actions-left">
        <i class="pi pi-check-circle text-lg"></i>
        <span class="selected-count">{{ selectedJobs.length }} job(s) selected</span>
      </div>
      <div class="bulk-actions-right">
        <button
          class="bulk-action-btn"
          [matMenuTriggerFor]="bulkStatusMenu"
          pTooltip="Update Status for Selected Jobs"
          tooltipPosition="top">
          <i class="pi pi-pencil"></i>
          <span>Update Status</span>
        </button>
        <button
          class="bulk-action-btn clear-btn"
          (click)="clearSelection()"
          pTooltip="Clear Selection"
          tooltipPosition="top">
          <i class="pi pi-times"></i>
          <span>Clear</span>
        </button>
      </div>
    </div>
  }

  <!-- PrimeNG Table with beautiful gradient headers -->
  <p-table
    [value]="jobs()"
    [loading]="isLoading()"
    [paginator]="true"
    [rows]="25"
    [rowsPerPageOptions]="[10, 25, 50, 100]"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} maintenance jobs"
    [globalFilterFields]="['machineName', 'serialNumber', 'project', 'status', 'type']"
    styleClass="p-datatable-sm p-datatable-striped"
    responsiveLayout="scroll"
    [(selection)]="selectedJobs"
    [selectAll]="selectAll"
    (selectAllChange)="onSelectAllChange($event)"
    dataKey="id">

    <!-- Table header -->
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 4rem">
          <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
        </th>
        <th pSortableColumn="machineName" class="text-xs uppercase py-2">
          <div class="flex items-center gap-1">
            <i class="pi pi-cog text-xs"></i>
            <span>Machine</span>
            <p-sortIcon field="machineName"></p-sortIcon>
          </div>
        </th>
        <th pSortableColumn="serialNumber" class="text-xs uppercase py-2">
          <div class="flex items-center gap-1">
            <i class="pi pi-tag text-xs"></i>
            <span>Serial No.</span>
            <p-sortIcon field="serialNumber"></p-sortIcon>
          </div>
        </th>
        <th pSortableColumn="project" class="text-xs uppercase py-2">
          <div class="flex items-center gap-1">
            <i class="pi pi-folder text-xs"></i>
            <span>Project</span>
            <p-sortIcon field="project"></p-sortIcon>
          </div>
        </th>
        <th pSortableColumn="scheduledDate" class="text-xs uppercase py-2">
          <div class="flex items-center gap-1">
            <i class="pi pi-calendar text-xs"></i>
            <span>Scheduled Date</span>
            <p-sortIcon field="scheduledDate"></p-sortIcon>
          </div>
        </th>
        <th pSortableColumn="type" class="text-xs uppercase py-2">
          <div class="flex items-center gap-1">
            <i class="pi pi-info-circle text-xs"></i>
            <span>Type</span>
            <p-sortIcon field="type"></p-sortIcon>
          </div>
        </th>
        <th pSortableColumn="status" class="text-xs uppercase py-2">
          <div class="flex items-center gap-1">
            <i class="pi pi-flag text-xs"></i>
            <span>Status</span>
            <p-sortIcon field="status"></p-sortIcon>
          </div>
        </th>
        <th class="text-xs uppercase py-2">
          <div class="flex items-center gap-1">
            <i class="pi pi-users text-xs"></i>
            <span>Assigned To</span>
          </div>
        </th>
        <th class="text-xs uppercase py-2">Actions</th>
      </tr>
    </ng-template>

    <!-- Table body with job data -->
    <ng-template pTemplate="body" let-job>
      <tr class="hover:bg-blue-50 transition-colors cursor-pointer" (click)="onJobSelected(job)">
        <td>
          <p-tableCheckbox [value]="job" (click)="$event.stopPropagation()"></p-tableCheckbox>
        </td>
        <td class="py-2">
          <div class="flex flex-col gap-0.5">
            <span class="font-semibold text-xs text-gray-800">{{ job.machineName }}</span>
            <span class="text-xs text-gray-500 italic">ID: {{ job.machineId }}</span>
          </div>
        </td>
        <td class="py-2">
          <span class="text-xs font-medium text-gray-700">{{ job.serialNumber }}</span>
        </td>
        <td class="py-2">
          <span class="text-xs text-gray-700">{{ job.project || job.projectName || 'N/A' }}</span>
        </td>
        <td class="py-2">
          <div class="flex flex-col gap-0.5">
            <span class="text-xs font-medium text-gray-700">{{ formatDate(job.scheduledDate) }}</span>
            <span class="text-xs text-gray-500">{{ formatTime(job.scheduledDate) }}</span>
          </div>
        </td>
        <td class="py-2">
          <p-tag
            [value]="getTypeDisplayName(job.type)"
            [severity]="getTypeSeverity(job.type)"
            [rounded]="true">
          </p-tag>
        </td>
        <td class="py-2">
          <p-tag
            [value]="getStatusDisplayName(job.status)"
            [severity]="getStatusSeverity(job.status)"
            [rounded]="true"
            [icon]="'pi ' + getStatusIcon(job.status)">
          </p-tag>
        </td>
        <td class="py-2">
          @if (job.assignedTo && job.assignedTo.length > 0) {
            <div class="flex items-center gap-1">
              <span class="text-xs text-gray-700 flex items-center gap-1">
                <i class="pi pi-user text-xs"></i>
                {{ job.assignedTo[0] }}
              </span>
              @if (job.assignedTo.length > 1) {
                <span class="text-xs text-gray-600" [pTooltip]="getAssignedTooltip(job.assignedTo)">
                  +{{ job.assignedTo.length - 1 }}
                </span>
              }
            </div>
          } @else {
            <span class="text-xs text-gray-500 italic flex items-center gap-1">
              <i class="pi pi-user-minus text-xs"></i>
              Unassigned
            </span>
          }
        </td>
        <td class="py-2">
          <div class="flex gap-1" (click)="$event.stopPropagation()">
            <button
              class="action-btn view-btn"
              (click)="onJobSelected(job)"
              pTooltip="View Details"
              tooltipPosition="top">
              <i class="pi pi-eye"></i>
            </button>
            <button
              class="action-btn edit-btn"
              [matMenuTriggerFor]="statusMenu"
              [matMenuTriggerData]="{job: job}"
              pTooltip="Update Status"
              tooltipPosition="top">
              <i class="pi pi-pencil"></i>
            </button>
          </div>
        </td>
      </tr>
    </ng-template>

    <!-- Empty state message -->
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="9" class="text-center py-8">
          <div class="flex flex-col items-center gap-2">
            <i class="pi pi-inbox text-4xl text-gray-300"></i>
            <h4 class="text-gray-700 m-0 font-semibold text-sm">No Maintenance Jobs Found</h4>
            <p class="text-gray-600 m-0 text-xs">No maintenance jobs match your current filters or search criteria.</p>
          </div>
        </td>
      </tr>
    </ng-template>

    <!-- Loading state -->
    <ng-template pTemplate="loadingbody">
      <tr>
        <td colspan="9">
          <div class="flex items-center justify-center gap-2 py-4">
            <i class="pi pi-spin pi-spinner text-blue-600"></i>
            <span class="text-gray-600 text-sm">Loading maintenance jobs...</span>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Status Update Menu -->
  <mat-menu #statusMenu="matMenu" class="status-menu">
    <ng-template matMenuContent let-job="job">
      <div class="menu-header p-2 bg-blue-600 text-white">
        <i class="pi pi-pencil"></i>
        <span class="font-semibold text-sm ml-2">Update Job Status</span>
      </div>
      @for (status of availableStatuses; track status) {
        <button mat-menu-item
                (click)="onStatusChange(job, status)"
                [disabled]="job.status === status"
                class="status-menu-item">
          <i class="pi {{ getStatusIcon(status) }} text-sm mr-2"></i>
          <span class="text-sm">{{ getStatusDisplayName(status) }}</span>
          @if (job.status === status) {
            <i class="pi pi-check text-green-600 ml-auto"></i>
          }
        </button>
      }
    </ng-template>
  </mat-menu>

  <!-- Bulk Status Update Menu -->
  <mat-menu #bulkStatusMenu="matMenu" class="status-menu">
    <div class="menu-header p-2 bg-blue-600 text-white">
      <i class="pi pi-pencil"></i>
      <span class="font-semibold text-sm ml-2">Update Status for {{ selectedJobs.length }} Jobs</span>
    </div>
    @for (status of availableStatuses; track status) {
      <button mat-menu-item
              (click)="onBulkStatusChange(status)"
              class="status-menu-item">
        <i class="pi {{ getStatusIcon(status) }} text-sm mr-2"></i>
        <span class="text-sm">{{ getStatusDisplayName(status) }}</span>
      </button>
    }
  </mat-menu>
</div>
