<!-- Dashboard Header: title, current user info, and global actions -->
<header class="dashboard-header">
  <div class="header-content">
    <h1>Maintenance Management Dashboard</h1>
    <div class="user-info">
      <!-- Show user details only when a user is loaded -->
      <div class="user-details" *ngIf="currentUser">
        <span class="welcome-message">{{ getUserWelcomeMessage() }}</span>
        <div class="user-metadata">
          <span class="user-role">Role: {{ currentUser.role }}</span>
          <span class="user-location" *ngIf="getUserLocationInfo()">{{ getUserLocationInfo() }}</span>
          <span class="last-login">{{ getLastLoginInfo() }}</span>
        </div>
      </div>
      <!-- Manual refresh to reload dashboard data from services -->
      <button class="refresh-btn" (click)="refreshDashboard()" title="Refresh dashboard data">
        <i class="material-icons">refresh</i>
        Refresh
      </button>
      <!-- End session for the current user -->
      <button class="logout-btn" (click)="logout()">Logout</button>
    </div>
  </div>
</header>

<!-- Global loading indicator while data is fetched -->
<div class="loading-container" *ngIf="isLoading()">
  <div class="spinner"></div>
  <p>Loading maintenance dashboard...</p>
</div>

<!-- Main dashboard content (visible when not loading) -->
<div class="dashboard-content" *ngIf="!isLoading()">
  <!-- Critical Maintenance Alerts. Show alerts only if any exist -->
  <div class="alerts-section" *ngIf="maintenanceAlerts.length > 0">
    <h3>
      <i class="material-icons alert-icon">warning</i>
      Critical Maintenance Alerts
    </h3>
    <div class="alert-cards">
      <!-- Render one card per alert; class set by priority for styling -->
      <div class="alert-card" *ngFor="let alert of maintenanceAlerts" [class]="'alert-' + alert.priority.toLowerCase()">
        <div class="alert-icon">
          <i class="material-icons">{{ alert.icon }}</i>
        </div>
        <div class="alert-content">
          <h4>{{ alert.machine }}</h4>
          <p>{{ alert.message }}</p>
          <span class="alert-time">{{ alert.timestamp }}</span>
        </div>
        <div class="alert-priority">{{ alert.priority }}</div>
      </div>
    </div>
  </div>

  <div class="stats-grid">
    <!-- High-level machine counts summary -->
    <div class="stat-card machines">
      <div class="stat-icon">
        <i class="material-icons">precision_manufacturing</i>
      </div>
      <div class="stat-content">
        <h3>Total Machines</h3>
        <p class="stat-number">{{ maintenanceStats.totalMachines }}</p>
      </div>
    </div>
    <div class="stat-card operational">
      <div class="stat-icon">
        <i class="material-icons">check_circle</i>
      </div>
      <div class="stat-content">
        <h3>Operational</h3>
        <p class="stat-number">{{ maintenanceStats.operational }}</p>
      </div>
    </div>
    <div class="stat-card maintenance">
      <div class="stat-icon">
        <i class="material-icons">build_circle</i>
      </div>
      <div class="stat-content">
        <h3>Under Maintenance</h3>
        <p class="stat-number">{{ maintenanceStats.underMaintenance }}</p>
      </div>
    </div>
    <div class="stat-card breakdown">
      <div class="stat-icon">
        <i class="material-icons">error</i>
      </div>
      <div class="stat-content">
        <h3>Breakdown</h3>
        <p class="stat-number">{{ maintenanceStats.breakdown }}</p>
      </div>
    </div>
  </div>

  <!-- Machine Management Section - UC-36 & UC-37 Implementation -->
  <div class="machine-management-section">
    <h3>
      <i class="material-icons">build</i>
      Machine Maintenance Management
    </h3>
    
    <!-- Available Machines for Scheduling -->
    <div class="machine-category" *ngIf="availableMachines().length > 0">
      <h4>Available Machines - Schedule Maintenance</h4>
      <div class="machine-cards">
        <div class="machine-card available" *ngFor="let machine of availableMachines()">
          <div class="machine-header">
            <h5>{{ machine.name }}</h5>
            <span class="machine-status">{{ machine.status }}</span>
          </div>
          <div class="machine-details">
            <p><strong>Model:</strong> {{ machine.model }}</p>
            <p><strong>Rig No:</strong> {{ machine.rigNo }}</p>
            <p><strong>Location:</strong> {{ machine.location }}</p>
            <p *ngIf="machine.nextMaintenance"><strong>Next Maintenance:</strong> {{ machine.nextMaintenance }}</p>
          </div>
          <div class="machine-actions">
            <button class="schedule-btn" (click)="scheduleMaintenance(machine)">
              <i class="material-icons">schedule</i>
              Schedule Maintenance
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Machines Scheduled for Maintenance -->
    <div class="machine-category" *ngIf="scheduledForMaintenance().length > 0">
      <h4>Scheduled for Maintenance - Log Activity</h4>
      <div class="machine-cards">
        <div class="machine-card scheduled" *ngFor="let machine of scheduledForMaintenance()">
          <div class="machine-header">
            <h5>{{ machine.name }}</h5>
            <span class="machine-status scheduled">{{ machine.status }}</span>
          </div>
        <div class="machine-details">
          <p><strong>Model:</strong> {{ machine.model }}</p>
          <p><strong>Rig No:</strong> {{ machine.rigNo }}</p>
          <p><strong>Location:</strong> {{ machine.location }}</p>
          <p *ngIf="machine.lastMaintenance"><strong>Last Maintenance:</strong> {{ machine.lastMaintenance }}</p>
        </div>
        <!-- UC-37 Form: Required fields and accessory usage -->
        <div class="maintenance-form">
          <div class="form-row">
            <div class="form-field">
              <label>Maintenance Type</label>
              <select (change)="setMaintenanceForm(machine.id, 'type', $any($event.target).value)">
                <option value="">Select Type</option>
                <option value="Preventive">Preventive</option>
                <option value="Corrective">Corrective</option>
                <option value="Emergency">Emergency</option>
                <option value="Inspection">Inspection</option>
              </select>
            </div>
            <div class="form-field">
              <label>Date</label>
              <input type="date" (change)="setMaintenanceForm(machine.id, 'date', $any($event.target).value)" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-field full-width">
              <label>Notes</label>
              <textarea rows="2" placeholder="Enter maintenance notes" (input)="setMaintenanceForm(machine.id, 'notes', $any($event.target).value)"></textarea>
            </div>
          </div>

          <!-- Accessory usage section -->
          <div class="accessory-usage">
            <label>Add Accessory Usage</label>
            <div class="usage-inputs">
              <select #partSel>
                <option value="">Select Part</option>
                <option *ngFor="let acc of accessories()" [value]="acc.name">{{ acc.name }} (Stock: {{ acc.stock }})</option>
              </select>
              <input #qtyInput type="number" min="1" placeholder="Qty" />
              <button class="add-usage-btn" (click)="addAccessoryUsage(machine.id, partSel.value, qtyInput.valueAsNumber)">
                Add
              </button>
            </div>
            <ul class="usage-list">
              <li *ngFor="let item of (selectedAccessoryUsage()[machine.id] || []); let i = index">
                {{ item.partName }} Ã— {{ item.quantity }}
                <button class="remove-usage" (click)="removeAccessoryUsage(machine.id, i)">Remove</button>
              </li>
            </ul>
          </div>
        </div>
        <div class="machine-actions">
          <button class="log-btn" (click)="logMaintenanceActivity(machine)">
            <i class="material-icons">assignment_turned_in</i>
            Log Maintenance Activity
          </button>
        </div>
        </div>
      </div>
    </div>

    <!-- Machines Under Maintenance -->
    <div class="machine-category" *ngIf="underMaintenance().length > 0">
      <h4>Under Maintenance - Complete Activity</h4>
      <div class="machine-cards">
        <div class="machine-card under-maintenance" *ngFor="let machine of underMaintenance()">
          <div class="machine-header">
            <h5>{{ machine.name }}</h5>
            <span class="machine-status under-maintenance">{{ machine.status }}</span>
          </div>
          <div class="machine-details">
            <p><strong>Model:</strong> {{ machine.model }}</p>
            <p><strong>Rig No:</strong> {{ machine.rigNo }}</p>
            <p><strong>Location:</strong> {{ machine.location }}</p>
            <p *ngIf="machine.lastMaintenance"><strong>Last Maintenance:</strong> {{ machine.lastMaintenance }}</p>
          </div>
          <div class="machine-actions">
            <button class="complete-btn" (click)="logMaintenanceActivity(machine)">
              <i class="material-icons">check_circle</i>
              Complete Maintenance
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Machine Operational Status Panel -->
  <div class="analysis-panel">
    <h3>
      <i class="material-icons">analytics</i>
      Machine Operational Status Overview
    </h3>
    <div class="status-breakdown">
      <div class="status-item running">
        <div class="status-icon">
          <i class="material-icons">play_circle</i>
        </div>
        <div class="status-info">
          <span class="status-label">Running</span>
          <span class="status-count">{{ operationalStatus.running }}</span>
        </div>
      </div>
      <div class="status-item idle">
        <div class="status-icon">
          <i class="material-icons">pause_circle</i>
        </div>
        <div class="status-info">
          <span class="status-label">Idle</span>
          <span class="status-count">{{ operationalStatus.idle }}</span>
        </div>
      </div>
      <div class="status-item maintenance">
        <div class="status-icon">
          <i class="material-icons">build_circle</i>
        </div>
        <div class="status-info">
          <span class="status-label">Under Maintenance</span>
          <span class="status-count">{{ operationalStatus.underMaintenance }}</span>
        </div>
      </div>
      <div class="status-item breakdown">
        <div class="status-icon">
          <i class="material-icons">error</i>
        </div>
        <div class="status-info">
          <span class="status-label">Breakdown</span>
          <span class="status-count">{{ operationalStatus.breakdown }}</span>
        </div>
      </div>
      <div class="status-item available">
        <div class="status-icon">
          <i class="material-icons">check_circle</i>
        </div>
        <div class="status-info">
          <span class="status-label">Available</span>
          <span class="status-count">{{ operationalStatus.available }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions Panel -->
  <div class="quick-actions-panel">
    <h3>
      <i class="material-icons">flash_on</i>
      Quick Actions
    </h3>
    <div class="action-cards">
      <!-- Navigate to maintenance jobs -->
      <div class="action-card jobs-action" (click)="navigateToMaintenanceJobs()">
        <div class="action-icon">
          <i class="material-icons">assignment</i>
        </div>
        <h4>Maintenance Jobs</h4>
        <p>View and manage maintenance jobs</p>
        <div class="action-status">{{ maintenanceStats.pendingTasks }} pending tasks</div>
      </div>

      <!-- Navigate to maintenance analytics -->
      <div class="action-card analytics-action" (click)="navigateToMaintenanceAnalytics()">
        <div class="action-icon">
          <i class="material-icons">analytics</i>
        </div>
        <h4>Maintenance Analytics</h4>
        <p>View maintenance performance metrics</p>
        <div class="action-status">View reports</div>
      </div>
    </div>
  </div>

  <!-- Recent Activities Panel -->
  <div class="activities-panel">
    <h3>
      <i class="material-icons">history</i>
      Recent Maintenance Activities
    </h3>
    <div class="activity-list">
      <div class="activity-item" *ngFor="let activity of recentActivities">
        <div class="activity-icon">
          <i class="material-icons">{{ activity.icon }}</i>
        </div>
        <div class="activity-content">
          <h4>{{ activity.title }}</h4>
          <p>{{ activity.description }}</p>
          <span class="activity-time">{{ activity.timestamp }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- User Profile Section -->
  <div class="user-profile-section">
    <h3>
      <i class="material-icons">account_circle</i>
      Mechanical Engineer Profile
    </h3>
    <!-- Show profile only when user data is available -->
    <div class="profile-card" *ngIf="currentUser">
      <div class="profile-header">
        <div class="profile-avatar">
          <span class="avatar-initials">{{ getInitials() }}</span>
        </div>
        <div class="profile-info">
          <h4>{{ currentUser.name }}</h4>
          <p class="profile-role">{{ currentUser.role }}</p>
          <p class="profile-location" *ngIf="getUserLocationInfo()">{{ getUserLocationInfo() }}</p>
        </div>
      </div>
      <div class="profile-stats">
        <div class="profile-stat">
          <span class="stat-label">Machines Managed</span>
          <span class="stat-value">{{ maintenanceStats.totalMachines }}</span>
        </div>
        <div class="profile-stat">
          <span class="stat-label">Active Alerts</span>
          <span class="stat-value">{{ maintenanceAlerts.length }}</span>
        </div>
        <div class="profile-stat">
          <span class="stat-label">Pending Tasks</span>
          <span class="stat-value">{{ maintenanceStats.pendingTasks }}</span>
        </div>
      </div>
    </div>
  </div>
</div>
