<header class="dashboard-header">
  <div class="header-content">
    <div class="header-left">
      <h1><i class="material-icons">dashboard</i> Blasting Engineer Dashboard</h1>
      <span class="welcome-message" *ngIf="currentUser">{{ getUserWelcomeMessage() }}</span>
    </div>
    <div class="header-actions">
      <button type="button" class="refresh-btn" (click)="refreshDashboard()" title="Refresh dashboard">
        <i class="material-icons">refresh</i>
      </button>
    </div>
  </div>
</header>

<div class="loading-container" *ngIf="isLoading">
  <div class="spinner"></div>
  <p>Loading dashboard...</p>
</div>

<div class="dashboard-content" *ngIf="!isLoading">
  <!-- Ultra-Compact Stats Row -->
  <div class="stats-row">
    <div class="stat-card-mini projects" (click)="navigateToProjects()">
      <div class="stat-icon"><i class="material-icons">work</i></div>
      <div class="stat-info">
        <span class="stat-value">{{ stats.totalProjects }}</span>
        <span class="stat-label">Projects</span>
      </div>
    </div>
    <div class="stat-card-mini active" (click)="navigateToProjects()">
      <div class="stat-icon"><i class="material-icons">trending_up</i></div>
      <div class="stat-info">
        <span class="stat-value">{{ stats.activeProjects }}</span>
        <span class="stat-label">Active</span>
      </div>
    </div>
    <div class="stat-card-mini sites" (click)="navigateToSites()">
      <div class="stat-icon"><i class="material-icons">place</i></div>
      <div class="stat-info">
        <span class="stat-value">{{ stats.totalSites }}</span>
        <span class="stat-label">Sites</span>
      </div>
    </div>
    <div class="stat-card-mini drill-holes" (click)="navigateToDrillVisualization()">
      <div class="stat-icon"><i class="material-icons">scatter_plot</i></div>
      <div class="stat-info">
        <span class="stat-value">{{ stats.totalDrillHoles }}</span>
        <span class="stat-label">Drill Holes</span>
      </div>
    </div>
    <div class="stat-card-mini pending" (click)="navigateToNotifications()">
      <div class="stat-icon"><i class="material-icons">notifications_active</i></div>
      <div class="stat-info">
        <span class="stat-value">{{ notifications.length }}</span>
        <span class="stat-label">Notifications</span>
      </div>
    </div>
    <div class="stat-card-mini patterns" (click)="navigateToProposalHistory()">
      <div class="stat-icon"><i class="material-icons">description</i></div>
      <div class="stat-info">
        <span class="stat-value">{{ recentProposals.length }}</span>
        <span class="stat-label">Proposals</span>
      </div>
    </div>
  </div>

  <!-- Optimized Main Dashboard Grid -->
  <div class="dashboard-grid">
    <!-- Left Column: Notifications -->
    <div class="grid-column">
      <!-- Notifications & Alerts -->
      <section class="section-card">
        <h3><i class="material-icons">notifications_active</i> Alerts <span class="badge" *ngIf="notifications.length > 0">{{ notifications.length }}</span></h3>
        <div class="compact-list">
          <div *ngFor="let notification of notifications.slice(0, 4)" class="list-item" [class.priority-high]="notification.priority === 'high' || notification.priority === 'urgent' || notification.priority === 'critical'" (click)="navigateToProposalHistory()">
            <i class="material-icons item-icon">{{ getNotificationIcon(notification.type) }}</i>
            <div class="item-content">
              <strong>{{ notification.title }}</strong>
              <span class="item-time">{{ formatDate(notification.timestamp) }}</span>
            </div>
          </div>
          <div *ngIf="notifications.length === 0" class="empty-state-mini">
            <i class="material-icons">check_circle</i>
            <span>All clear</span>
          </div>
        </div>
      </section>

      <!-- Project Health -->
      <section class="section-card">
        <h3><i class="material-icons">monitor_heart</i> Project Health</h3>
        <div class="health-compact">
          <div class="health-item success" *ngIf="userProjects.length > 0">
            <i class="material-icons">check_circle</i>
            <div class="health-details">
              <span class="health-label">Active Projects</span>
              <span class="health-value">{{ stats.activeProjects }}</span>
            </div>
          </div>
          <div class="health-item" [class.warning]="stats.pendingReviews > 0" [class.success]="stats.pendingReviews === 0">
            <i class="material-icons">{{ stats.pendingReviews > 0 ? 'warning' : 'check_circle' }}</i>
            <div class="health-details">
              <span class="health-label">Sites Needing Data</span>
              <span class="health-value">{{ stats.pendingReviews }}</span>
            </div>
          </div>
          <div class="health-item" [class.success]="stats.activeDrillSites > 0" [class.neutral]="stats.activeDrillSites === 0">
            <i class="material-icons">scatter_plot</i>
            <div class="health-details">
              <span class="health-label">Data Coverage</span>
              <span class="health-value">{{ stats.totalSites > 0 ? ((stats.activeDrillSites / stats.totalSites) * 100).toFixed(0) : 0 }}%</span>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Center Column: Proposals & Drill Data -->
    <div class="grid-column">
      <!-- Recent Proposals -->
      <section class="section-card">
        <h3><i class="material-icons">description</i> Explosive Approvals</h3>
        <div class="compact-list">
          <div *ngFor="let proposal of recentProposals.slice(0, 4)" class="list-item" (click)="navigateToProposalHistory()">
            <span class="status-dot" [class]="'status-' + proposal.status.toLowerCase().replace(' ', '-')"></span>
            <div class="item-content">
              <strong>{{ proposal.title }}</strong>
              <span class="item-meta">{{ proposal.projectName }} • {{ formatDate(proposal.submittedDate) }}</span>
            </div>
            <i class="material-icons chevron">chevron_right</i>
          </div>
          <div *ngIf="recentProposals.length === 0" class="empty-state-mini">
            <i class="material-icons">assignment</i>
            <span>No proposals</span>
          </div>
        </div>
      </section>

      <!-- Recent Drill Data -->
      <section class="section-card" *ngIf="recentUploads.length > 0">
        <h3><i class="material-icons">database</i> Recent Data</h3>
        <div class="compact-list">
          <div *ngFor="let upload of recentUploads.slice(0, 3)" class="list-item" (click)="navigateToDrillVisualization(upload.projectId, upload.siteId)">
            <i class="material-icons item-icon">scatter_plot</i>
            <div class="item-content">
              <strong>P{{ upload.projectId }} - S{{ upload.siteId }}</strong>
              <span class="item-meta">{{ upload.recordCount }} holes • {{ formatDate(upload.uploadDate) }}</span>
            </div>
            <i class="material-icons chevron">chevron_right</i>
          </div>
        </div>
      </section>
    </div>

    <!-- Right Column: Drill Stats & Activity -->
    <div class="grid-column">
      <!-- Drill Statistics -->
      <section class="section-card" *ngIf="drillData.length > 0">
        <h3><i class="material-icons">analytics</i> Drill Statistics</h3>
        <div class="stats-compact">
          <div class="stat-compact">
            <span class="stat-compact-label">Avg Depth</span>
            <span class="stat-compact-value">{{ quickStats.averageDepth }}m</span>
          </div>
          <div class="stat-compact">
            <span class="stat-compact-label">Max Elevation</span>
            <span class="stat-compact-value">{{ quickStats.maxElevation }}m</span>
          </div>
          <div class="stat-compact">
            <span class="stat-compact-label">Min Elevation</span>
            <span class="stat-compact-value">{{ quickStats.minElevation }}m</span>
          </div>
          <div class="stat-compact">
            <span class="stat-compact-label">Total Length</span>
            <span class="stat-compact-value">{{ quickStats.totalDrillLength }}m</span>
          </div>
        </div>
      </section>

      <!-- Recent Activities -->
      <section class="section-card" *ngIf="recentActivities.length > 0">
        <h3><i class="material-icons">history</i> Recent Activity</h3>
        <div class="compact-list">
          <div *ngFor="let activity of recentActivities.slice(0, 4); trackBy: trackActivity" class="list-item activity-item">
            <i class="material-icons item-icon">{{ getActivityIcon(activity.action) }}</i>
            <div class="item-content">
              <strong>{{ activity.userName || 'User' }}</strong>
              <span class="item-meta">{{ activity.action }} • {{ getTimeFromNow(activity.timestamp) }}</span>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>
