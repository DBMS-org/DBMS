<div class="depth-editor-table-container">
  <div class="table-header">
    <h3>Drill Hole Depths</h3>
    <div class="legend">
      <span class="legend-item">
        <span class="legend-color global-depth"></span>
        Global Depth ({{ globalDepth }}m)
      </span>
      <span class="legend-item">
        <span class="legend-color custom-depth"></span>
        Custom Depth
      </span>
    </div>
  </div>

  <!-- Filter Controls -->
  <div class="filter-controls">
    <div class="filter-row">
      <!-- Search Input -->
      <mat-form-field class="search-field" appearance="outline">
        <mat-label>Search Hole ID</mat-label>
        <input 
          matInput 
          [(ngModel)]="searchText"
          (ngModelChange)="onSearchTextChange()"
          placeholder="Enter hole ID to search"
          aria-label="Search drill holes by ID">
        <mat-icon matSuffix>search</mat-icon>
        <button 
          *ngIf="searchText" 
          matSuffix 
          mat-icon-button 
          type="button"
          (click)="clearSearch()"
          matTooltip="Clear search"
          aria-label="Clear search">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>

      <!-- Depth Filter -->
      <mat-form-field class="depth-filter" appearance="outline">
        <mat-label>Filter by Depth</mat-label>
        <mat-select 
          [(value)]="depthFilter"
          (selectionChange)="onDepthFilterChange()"
          aria-label="Filter holes by depth type">
          <mat-option *ngFor="let option of depthFilterOptions" [value]="option.value">
            {{ option.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Clear Filters Button -->
      <button 
        mat-stroked-button 
        type="button"
        *ngIf="hasActiveFilters()"
        (click)="clearFilters()"
        matTooltip="Clear all filters"
        aria-label="Clear all filters">
        <mat-icon>clear_all</mat-icon>
        Clear Filters
      </button>
    </div>

    <!-- Filter Summary -->
    <div class="filter-summary">
      <mat-chip-set>
        <mat-chip>{{ getFilterSummary() }}</mat-chip>
        <mat-chip *ngIf="searchText" color="primary">
          <mat-icon matChipRemove (click)="clearSearch()">cancel</mat-icon>
          Search: "{{ searchText }}"
        </mat-chip>
        <mat-chip *ngIf="depthFilter !== 'all'" color="accent">
          <mat-icon matChipRemove (click)="clearDepthFilter()">cancel</mat-icon>
          {{ getDepthFilterLabel() }}
        </mat-chip>
      </mat-chip-set>
    </div>
  </div>

  <!-- Bulk Operations Panel -->
  <div class="bulk-operations" *ngIf="!readonly">
    <div class="bulk-header">
      <div class="selection-info">
        <mat-icon>checklist</mat-icon>
        <span>{{ getBulkOperationSummary() }}</span>
        <button 
          *ngIf="hasSelectedRows()" 
          mat-button 
          type="button"
          (click)="clearSelection()"
          matTooltip="Clear selection">
          Clear Selection
        </button>
      </div>
      
      <div class="bulk-actions" *ngIf="hasSelectedRows()">
        <!-- Bulk Depth Input -->
        <mat-form-field class="bulk-depth-input" appearance="outline">
          <mat-label>New Depth (m)</mat-label>
          <input 
            matInput 
            type="number" 
            [(ngModel)]="bulkDepthValue"
            min="1.0" 
            max="50.0" 
            step="0.5"
            placeholder="Enter depth"
            aria-label="Bulk depth value">
          <mat-hint>1.0 - 50.0 meters</mat-hint>
        </mat-form-field>

        <!-- Apply Bulk Depth -->
        <button 
          mat-raised-button 
          color="primary"
          type="button"
          (click)="applyBulkDepthChange()"
          [disabled]="!isValidDepth(bulkDepthValue)"
          matTooltip="Apply the specified depth to all selected holes">
          <mat-icon>edit</mat-icon>
          Apply Depth
        </button>

        <!-- Reset to Global Depth -->
        <button 
          mat-raised-button 
          color="accent"
          type="button"
          (click)="resetSelectedToGlobalDepth()"
          matTooltip="Reset selected holes to global depth ({{ globalDepth }}m)">
          <mat-icon>restore</mat-icon>
          Reset to Global
        </button>

        <!-- More Actions Menu -->
        <button 
          mat-icon-button 
          [matMenuTriggerFor]="bulkMenu"
          matTooltip="More bulk actions">
          <mat-icon>more_vert</mat-icon>
        </button>
        
        <mat-menu #bulkMenu="matMenu">
          <button 
            mat-menu-item 
            type="button"
            (click)="applyGlobalDepthToSelected()"
            [disabled]="!hasSelectedCustomDepthRows()">
            <mat-icon>sync</mat-icon>
            <span>Apply Global Depth to Selected</span>
          </button>
          <mat-divider></mat-divider>
          <button 
            mat-menu-item 
            type="button"
            (click)="applyGlobalDepthToAll()"
            [disabled]="!hasAnyCustomDepthRows()">
            <mat-icon>sync_alt</mat-icon>
            <span>Apply Global Depth to All Holes</span>
          </button>
        </mat-menu>
      </div>
    </div>
  </div>

  <div class="table-wrapper">
    <table mat-table [dataSource]="filteredData" matSort (matSortChange)="onSort($event)" class="depth-table" 
           role="table" 
           aria-label="Drill hole depth editor table"
           [attr.aria-rowcount]="filteredData.length + 1">
      
      <!-- Selection Column -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef class="select-cell">
          <mat-checkbox
            [checked]="isAllSelected"
            [indeterminate]="isIndeterminate"
            (change)="toggleAllSelection()"
            matTooltip="Select all visible holes"
            aria-label="Select all holes">
          </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row" class="select-cell">
          <mat-checkbox
            [checked]="row.selected"
            (change)="toggleRowSelection(row)"
            [matTooltip]="'Select hole ' + row.id"
            [aria-label]="'Select drill hole ' + row.id">
          </mat-checkbox>
        </td>
      </ng-container>

      <!-- ID Column -->
      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef mat-sort-header role="columnheader" scope="col">Hole ID</th>
        <td mat-cell *matCellDef="let row" class="id-cell" role="cell">
          {{ row.id }}
        </td>
      </ng-container>

      <!-- X Coordinate Column -->
      <ng-container matColumnDef="x">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>X (m)</th>
        <td mat-cell *matCellDef="let row" class="coordinate-cell">
          {{ row.x }}
        </td>
      </ng-container>

      <!-- Y Coordinate Column -->
      <ng-container matColumnDef="y">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Y (m)</th>
        <td mat-cell *matCellDef="let row" class="coordinate-cell">
          {{ row.y }}
        </td>
      </ng-container>

      <!-- Depth Column -->
      <ng-container matColumnDef="depth">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Depth (m)</th>
        <td mat-cell *matCellDef="let row" class="depth-cell" [ngClass]="getDepthDisplayClass(row)">
          <div *ngIf="!row.isEditing" class="depth-display">
            <span class="depth-value">{{ row.depth }}</span>
            <mat-icon 
              *ngIf="hasCustomDepth(row)" 
              class="custom-indicator" 
              matTooltip="Custom depth (different from global)"
              aria-label="Custom depth indicator">
              edit
            </mat-icon>
          </div>
          
          <mat-form-field *ngIf="row.isEditing" class="depth-input" appearance="outline">
            <mat-label>Depth (m)</mat-label>
            <input 
              matInput 
              type="number" 
              [(ngModel)]="row.depth"
              min="1.0" 
              max="50.0" 
              step="0.5"
              placeholder="Enter depth in meters"
              [attr.aria-label]="'Edit depth for drill hole ' + row.id"
              [attr.aria-describedby]="'depth-hint-' + row.id"
              (keydown)="onDepthInputKeydown($event, row)"
              (blur)="onDepthInputBlur(row)"
              #depthInput>
            <mat-hint [id]="'depth-hint-' + row.id">1.0 - 50.0 meters</mat-hint>
          </mat-form-field>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let row" class="actions-cell">
          <div *ngIf="!readonly" class="action-buttons">
            <!-- Edit Mode Actions -->
            <div *ngIf="row.isEditing" class="edit-actions">
              <button 
                mat-icon-button 
                type="button"
                color="primary"
                (click)="saveEdit(row)"
                matTooltip="Save changes"
                aria-label="Save depth changes">
                <mat-icon>check</mat-icon>
              </button>
              <button 
                mat-icon-button 
                type="button"
                color="warn"
                (click)="cancelEdit(row)"
                matTooltip="Cancel changes"
                aria-label="Cancel depth changes">
                <mat-icon>close</mat-icon>
              </button>
            </div>
            
            <!-- View Mode Actions -->
            <div *ngIf="!row.isEditing" class="view-actions">
              <button 
                mat-icon-button 
                type="button"
                (click)="startEdit(row)"
                matTooltip="Edit depth"
                aria-label="Edit hole depth">
                <mat-icon>edit</mat-icon>
              </button>
            </div>
          </div>
          
          <!-- Read-only indicator -->
          <div *ngIf="readonly" class="readonly-indicator">
            <mat-icon matTooltip="Read-only mode">lock</mat-icon>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" 
          [class.editing-row]="row.isEditing"
          [class.custom-depth-row]="hasCustomDepth(row)"
          [class.selected-row]="row.selected"></tr>
    </table>
  </div>

  <div *ngIf="tableData.length === 0" class="no-data">
    <mat-icon>info</mat-icon>
    <p>No drill holes to display</p>
  </div>

  <div *ngIf="tableData.length > 0 && filteredData.length === 0" class="no-filtered-data">
    <mat-icon>filter_list_off</mat-icon>
    <p>No holes match the current filters</p>
    <button mat-stroked-button type="button" (click)="clearFilters()">
      Clear Filters
    </button>
  </div>
</div>