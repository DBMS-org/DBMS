# Infrastructure Layer ‚Äì Design & Guidelines

## Purpose
The **Infrastructure** project is the _outermost_ layer that _implements_
interfaces declared in the Application layer and provides concrete access to
external resources:

*   Database (EF-Core `ApplicationDbContext`, migrations, repositories)
*   External services (JWT, email, password hashing, file storage, caching‚Ä¶)
*   Framework configuration (but **never** business rules)

Think of Infrastructure as a _plugin_ ‚Äî replaceable without changing Domain or
Application.

---

## 1. Dependency Rules
1. **May reference:** `Domain`, `Application`, `Microsoft.EntityFrameworkCore.*`,
   `Microsoft.Extensions.*`, any third-party _infrastructure_ libs (e.g.
   SendGrid, Dapper, StackExchange.Redis).
2. **Must not reference:** `Presentation` projects or UI frameworks.
3. **Implements** ‚Äî never declares ‚Äî business interfaces (repositories,
   services) defined in Application.
4. **Never introduces new business abstractions** ‚Äî those belong to Application.

---

## 2. Folder Structure
```
Infrastructure/
‚îú‚îÄ Data/              # DbContext, config, seed
‚îú‚îÄ Repositories/      # EF-Core or Dapper repository implementations
‚îú‚îÄ Services/          # EmailService, JwtService, etc.
‚îú‚îÄ Migrations/        # dotnet-ef generated files (keep separate)
‚îî‚îÄ INFRASTRUCTURE_GUIDELINES.md
```

---

## 3. Building Blocks
| Component | Guidelines |
|-----------|------------|
| **DbContext** | Only one `ApplicationDbContext` per bounded context. Configure in Presentation's DI. |
| **Repository** | Implements `I*Repository` interfaces; no business logic; each method atomic (call `SaveChangesAsync`). |
| **External Service** | Implements `IEmailService`, `IJwtService`, `IPasswordService`, etc.; hide third-party SDK specifics behind interface. |
| **Migration** | Auto-generated by `dotnet ef`; _never_ edited manually except for hot-fixes; keep history. |

---

## 4. Cross-cutting Concerns
1. **Logging** ‚Äì Use injected `ILogger<T>` in repositories/services for failures & performance info.
2. **Error handling** ‚Äì Let exceptions bubble; Application layer decides retry/compensation.
3. **Transactions** ‚Äì Keep transaction boundaries small; consider a Unit-of-Work wrapper if multiple repositories must commit atomically.
4. **Configuration** ‚Äì Bind from `appsettings*.json` via options pattern; _do not_ read configuration directly inside classes.
5. **Cancellation tokens** ‚Äì Surface `CancellationToken` to every async method for graceful shutdown.

---

## 5. Current Design ‚Äì Strengths ‚úÖ
1. EF-Core context isolated under `Data/`; migrations tracked.
2. Repositories cleanly implement Application interfaces (`ProjectRepository`, `DrillHoleRepository`).
3. Separate folder `Services/` for JWT, Password, Email ‚Äì keeps concerns tidy.
4. Dependency registration centralised in `Presentation/API/Program.cs`.

## 5.1 Areas to Improve üîç
| Finding | Impact | Suggested Fix |
|---------|--------|---------------|
| **Missing ILogger injection in some repositories** (e.g. `ProjectRepository`) | Harder to diagnose DB issues | Inject `ILogger<ProjectRepository>` and log queries & exceptions. |
| **SaveChangesAsync called inside each repository method** but sometimes additional manual changes done in Application. | Risk of partial commits | Consider Unit of Work or transaction scope across multiple repositories when needed. |
| **PasswordService duplicates hash logic** already present in other libs | Security, redundancy | Evaluate using ASP.NET Core Identity's `PasswordHasher<T>` for vetted implementation. |
| **JwtService hard-codes secret key length assumption** | Security | Move key length validation & rotation policy into configuration + options validation. |
| **No caching layer** for read-heavy lookups (Regions, Roles) | Performance | Add optional Redis implementation behind `IRegionRepository` or separate `ICacheService`. |
| **Migration namespace clutter** ‚Äì dozens of files in root `Migrations/` | Project hygiene | Enable sub-folder per feature or squash before production launch. |

---

## 6. Implementation Templates
### 6.1 Repository skeleton
```csharp
public class ProjectRepository : IProjectRepository
{
    private readonly ApplicationDbContext _db;
    private readonly ILogger<ProjectRepository> _log;

    public ProjectRepository(ApplicationDbContext db, ILogger<ProjectRepository> log)
    {
        _db  = db;
        _log = log;
    }

    public async Task<Project?> GetByIdAsync(int id, CancellationToken ct = default)
    {
        return await _db.Projects
                        .Include(p => p.ProjectSites)
                        .FirstOrDefaultAsync(p => p.Id == id, ct);
    }

    public async Task<Project> CreateAsync(Project entity, CancellationToken ct = default)
    {
        _db.Projects.Add(entity);
        await _db.SaveChangesAsync(ct);
        _log.LogInformation("Project {Id} persisted", entity.Id);
        return entity;
    }
}
```

### 6.2 External service via Options pattern
```csharp
public class EmailService : IEmailService
{
    private readonly SmtpSettings _cfg;
    private readonly ILogger<EmailService> _log;

    public EmailService(IOptions<SmtpSettings> cfg, ILogger<EmailService> log)
    {
        _cfg = cfg.Value;
        _log = log;
    }

    public async Task SendPasswordResetEmailAsync(string to, string code)
    {
        using var client = new SmtpClient(_cfg.Host, _cfg.Port);
        // ‚Ä¶ send ‚Ä¶
        _log.LogInformation("Reset email sent to {Email}", to);
    }
}
```

---

## 7. Improvement Back-log (2025-07-01)
| üìù Item | Status | Priority |
|---------|--------|----------|
| Inject `ILogger` into all repositories & services | Not started | High |
| Introduce Unit-of-Work abstraction if multi-repo transactions grow | Not started | High |
| Adopt `CancellationToken` in repository/service methods | Not started | High |
| Replace custom PasswordService with ASP.NET Core Identity hashing | Researching | Medium |
| Enable response-caching layer (Redis) for lookup tables | Backlog | Medium |
| Create seed data classes and remove data-seeding from migrations | Not started | Low |

---

## 8. Checklist for New Infrastructure Component
- [ ] Does an interface already exist in Application? If not, add it _there_, then implement here.
- [ ] Keep constructor DI-friendly (`ApplicationDbContext`, `ILogger<T>`, options pattern).
- [ ] Propagate cancellation tokens.
- [ ] Log queries and external calls.
- [ ] Respect retry policies / transient-fault-handling if calling network services.
- [ ] Unit test with in-memory provider or mocks.

---

### Authors & Maintenance
Created July 2025 by the DBMS team.  Update this file whenever new infrastructure patterns are added or existing ones change. 